<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="codeva-XHCX41TH3N">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.planejun.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一、PEB系列12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394kd&gt; dt _PEB">
<meta property="og:type" content="article">
<meta property="og:title" content="从零开始学习反调试">
<meta property="og:url" content="https://blog.planejun.cn/2024/04/21/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/index.html">
<meta property="og:site_name" content="PlaneJun&#39;Blog">
<meta property="og:description" content="一、PEB系列12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394kd&gt; dt _PEB">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.planejun.cn/.../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219165530733.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221221153952332.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219144519199.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219151607807.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219144823922.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219145026132.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219154705788.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219154800065.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219155345233.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219155353983.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219160642924.png">
<meta property="article:published_time" content="2024-04-21T12:32:42.396Z">
<meta property="article:modified_time" content="2024-04-21T13:19:24.825Z">
<meta property="article:author" content="PlaneJun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.planejun.cn/.../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219165530733.png">


<link rel="canonical" href="https://blog.planejun.cn/2024/04/21/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.planejun.cn/2024/04/21/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/","path":"2024/04/21/从零开始学习反调试/","title":"从零开始学习反调试"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>从零开始学习反调试 | PlaneJun'Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">PlaneJun'Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">我是从未来来的！现在学已经来不及了，放开玩吧！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section">归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section">分类</a></li><li class="menu-item menu-item-github"><a href="https://www.github.com/PlaneJun" rel="section" target="_blank">GitHub</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section">关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81PEB%E7%B3%BB%E5%88%97"><span class="nav-number">1.</span> <span class="nav-text">一、PEB系列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BeingDebugged"><span class="nav-number">1.1.</span> <span class="nav-text">BeingDebugged</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtGlobalFlag"><span class="nav-number">1.2.</span> <span class="nav-text">NtGlobalFlag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProcessHeap"><span class="nav-number">1.3.</span> <span class="nav-text">ProcessHeap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CrossProcessFlags"><span class="nav-number">1.4.</span> <span class="nav-text">CrossProcessFlags</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81API%E7%B3%BB%E5%88%97"><span class="nav-number">2.</span> <span class="nav-text">二、API系列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IsDebuggerPresent"><span class="nav-number">2.1.</span> <span class="nav-text">IsDebuggerPresent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CheckRemoteDebuggerPresent"><span class="nav-number">2.2.</span> <span class="nav-text">CheckRemoteDebuggerPresent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DbgBreakPoint"><span class="nav-number">2.3.</span> <span class="nav-text">DbgBreakPoint</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DbgUiRemoteBreakin"><span class="nav-number">2.4.</span> <span class="nav-text">DbgUiRemoteBreakin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtQueryInformationProcess"><span class="nav-number">2.5.</span> <span class="nav-text">NtQueryInformationProcess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtQueryInformationThread"><span class="nav-number">2.6.</span> <span class="nav-text">NtQueryInformationThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtQuerySystemInformation"><span class="nav-number">2.7.</span> <span class="nav-text">NtQuerySystemInformation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtQueryObject"><span class="nav-number">2.8.</span> <span class="nav-text">NtQueryObject</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81ObjectAllTypesInformation"><span class="nav-number">2.8.1.</span> <span class="nav-text">1、ObjectAllTypesInformation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81ObjectTypeInformation"><span class="nav-number">2.8.2.</span> <span class="nav-text">2、ObjectTypeInformation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtSetInformationThread"><span class="nav-number">2.9.</span> <span class="nav-text">NtSetInformationThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtGetContextThread%E3%80%81NtSetContextThread"><span class="nav-number">2.10.</span> <span class="nav-text">NtGetContextThread、NtSetContextThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OutputDebugStringA"><span class="nav-number">2.11.</span> <span class="nav-text">OutputDebugStringA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TimeCheck"><span class="nav-number">2.12.</span> <span class="nav-text">TimeCheck</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtSetDebugFilterState"><span class="nav-number">2.13.</span> <span class="nav-text">NtSetDebugFilterState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapSetInformation"><span class="nav-number">2.14.</span> <span class="nav-text">HeapSetInformation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NtSystemDebugControl"><span class="nav-number">2.15.</span> <span class="nav-text">NtSystemDebugControl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RtlCaptureStackBackTrace"><span class="nav-number">2.16.</span> <span class="nav-text">RtlCaptureStackBackTrace</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7"><span class="nav-number">3.</span> <span class="nav-text">三、异常捕获</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CloseHandle%E3%80%81NtGetContextThread"><span class="nav-number">3.1.</span> <span class="nav-text">CloseHandle、NtGetContextThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetHandleInformation"><span class="nav-number">3.2.</span> <span class="nav-text">SetHandleInformation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetUnhandledExceptionFilter%E3%80%81UnhandledExcepFilter"><span class="nav-number">3.3.</span> <span class="nav-text">SetUnhandledExceptionFilter、UnhandledExcepFilter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RtlQueryProcessDebugInformation"><span class="nav-number">3.4.</span> <span class="nav-text">RtlQueryProcessDebugInformation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RtlQueryProcessHeapInformation"><span class="nav-number">3.5.</span> <span class="nav-text">RtlQueryProcessHeapInformation</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="nav-number">4.</span> <span class="nav-text">四、注册表</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GlobalFlagsClear"><span class="nav-number">4.1.</span> <span class="nav-text">GlobalFlagsClear</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SystemBoot"><span class="nav-number">4.2.</span> <span class="nav-text">SystemBoot</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%A0%86%E6%A3%80%E6%B5%8B"><span class="nav-number">5.</span> <span class="nav-text">五、堆检测</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapTail"><span class="nav-number">5.1.</span> <span class="nav-text">HeapTail</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E7%AC%A6%E5%8F%B7%E6%A3%80%E6%9F%A5"><span class="nav-number">6.</span> <span class="nav-text">六、符号检查</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Syser"><span class="nav-number">6.1.</span> <span class="nav-text">Syser</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81ETC"><span class="nav-number">7.</span> <span class="nav-text">七、ETC</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E5%85%B6%E4%BB%96"><span class="nav-number">8.</span> <span class="nav-text">八、其他</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#KUSER-SHARED-DATA"><span class="nav-number">8.1.</span> <span class="nav-text">KUSER_SHARED_DATA</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">PlaneJun</p>
  <div class="site-description" itemprop="description">This is PlaneJun‘s Blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.planejun.cn/2024/04/21/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PlaneJun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PlaneJun'Blog">
      <meta itemprop="description" content="This is PlaneJun‘s Blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="从零开始学习反调试 | PlaneJun'Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          从零开始学习反调试
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-04-21 20:32:42 / 修改时间：21:19:24" itemprop="dateCreated datePublished" datetime="2024-04-21T20:32:42+08:00">2024-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Anti/" itemprop="url" rel="index"><span itemprop="name">Anti</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="一、PEB系列"><a href="#一、PEB系列" class="headerlink" title="一、PEB系列"></a>一、PEB系列</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _PEB</span><br><span class="line">ntdll!_PEB</span><br><span class="line">   +0x000 InheritedAddressSpace : UChar</span><br><span class="line">   +0x001 ReadImageFileExecOptions : UChar</span><br><span class="line">   +0x002 BeingDebugged    : UChar</span><br><span class="line">   +0x003 BitField         : UChar</span><br><span class="line">   +0x003 ImageUsesLargePages : Pos 0, 1 Bit</span><br><span class="line">   +0x003 IsProtectedProcess : Pos 1, 1 Bit</span><br><span class="line">   +0x003 IsLegacyProcess  : Pos 2, 1 Bit</span><br><span class="line">   +0x003 IsImageDynamicallyRelocated : Pos 3, 1 Bit</span><br><span class="line">   +0x003 SkipPatchingUser32Forwarders : Pos 4, 1 Bit</span><br><span class="line">   +0x003 SpareBits        : Pos 5, 3 Bits</span><br><span class="line">   +0x004 Mutant           : Ptr32 Void</span><br><span class="line">   +0x008 ImageBaseAddress : Ptr32 Void</span><br><span class="line">   +0x00c Ldr              : Ptr32 _PEB_LDR_DATA</span><br><span class="line">   +0x010 ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +0x014 SubSystemData    : Ptr32 Void</span><br><span class="line">   +0x018 ProcessHeap      : Ptr32 Void</span><br><span class="line">   +0x01c FastPebLock      : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x020 AtlThunkSListPtr : Ptr32 Void</span><br><span class="line">   +0x024 IFEOKey          : Ptr32 Void</span><br><span class="line">   +0x028 CrossProcessFlags : Uint4B</span><br><span class="line">   +0x028 ProcessInJob     : Pos 0, 1 Bit</span><br><span class="line">   +0x028 ProcessInitializing : Pos 1, 1 Bit</span><br><span class="line">   +0x028 ProcessUsingVEH  : Pos 2, 1 Bit</span><br><span class="line">   +0x028 ProcessUsingVCH  : Pos 3, 1 Bit</span><br><span class="line">   +0x028 ProcessUsingFTH  : Pos 4, 1 Bit</span><br><span class="line">   +0x028 ReservedBits0    : Pos 5, 27 Bits</span><br><span class="line">   +0x02c KernelCallbackTable : Ptr32 Void</span><br><span class="line">   +0x02c UserSharedInfoPtr : Ptr32 Void</span><br><span class="line">   +0x030 SystemReserved   : [1] Uint4B</span><br><span class="line">   +0x034 AtlThunkSListPtr32 : Uint4B</span><br><span class="line">   +0x038 ApiSetMap        : Ptr32 Void</span><br><span class="line">   +0x03c TlsExpansionCounter : Uint4B</span><br><span class="line">   +0x040 TlsBitmap        : Ptr32 Void</span><br><span class="line">   +0x044 TlsBitmapBits    : [2] Uint4B</span><br><span class="line">   +0x04c ReadOnlySharedMemoryBase : Ptr32 Void</span><br><span class="line">   +0x050 HotpatchInformation : Ptr32 Void</span><br><span class="line">   +0x054 ReadOnlyStaticServerData : Ptr32 Ptr32 Void</span><br><span class="line">   +0x058 AnsiCodePageData : Ptr32 Void</span><br><span class="line">   +0x05c OemCodePageData  : Ptr32 Void</span><br><span class="line">   +0x060 UnicodeCaseTableData : Ptr32 Void</span><br><span class="line">   +0x064 NumberOfProcessors : Uint4B</span><br><span class="line">   +0x068 NtGlobalFlag     : Uint4B</span><br><span class="line">   +0x070 CriticalSectionTimeout : _LARGE_INTEGER</span><br><span class="line">   +0x078 HeapSegmentReserve : Uint4B</span><br><span class="line">   +0x07c HeapSegmentCommit : Uint4B</span><br><span class="line">   +0x080 HeapDeCommitTotalFreeThreshold : Uint4B</span><br><span class="line">   +0x084 HeapDeCommitFreeBlockThreshold : Uint4B</span><br><span class="line">   +0x088 NumberOfHeaps    : Uint4B</span><br><span class="line">   +0x08c MaximumNumberOfHeaps : Uint4B</span><br><span class="line">   +0x090 ProcessHeaps     : Ptr32 Ptr32 Void</span><br><span class="line">   +0x094 GdiSharedHandleTable : Ptr32 Void</span><br><span class="line">   +0x098 ProcessStarterHelper : Ptr32 Void</span><br><span class="line">   +0x09c GdiDCAttributeList : Uint4B</span><br><span class="line">   +0x0a0 LoaderLock       : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x0a4 OSMajorVersion   : Uint4B</span><br><span class="line">   +0x0a8 OSMinorVersion   : Uint4B</span><br><span class="line">   +0x0ac OSBuildNumber    : Uint2B</span><br><span class="line">   +0x0ae OSCSDVersion     : Uint2B</span><br><span class="line">   +0x0b0 OSPlatformId     : Uint4B</span><br><span class="line">   +0x0b4 ImageSubsystem   : Uint4B</span><br><span class="line">   +0x0b8 ImageSubsystemMajorVersion : Uint4B</span><br><span class="line">   +0x0bc ImageSubsystemMinorVersion : Uint4B</span><br><span class="line">   +0x0c0 ActiveProcessAffinityMask : Uint4B</span><br><span class="line">   +0x0c4 GdiHandleBuffer  : [34] Uint4B</span><br><span class="line">   +0x14c PostProcessInitRoutine : Ptr32     void </span><br><span class="line">   +0x150 TlsExpansionBitmap : Ptr32 Void</span><br><span class="line">   +0x154 TlsExpansionBitmapBits : [32] Uint4B</span><br><span class="line">   +0x1d4 SessionId        : Uint4B</span><br><span class="line">   +0x1d8 AppCompatFlags   : _ULARGE_INTEGER</span><br><span class="line">   +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER</span><br><span class="line">   +0x1e8 pShimData        : Ptr32 Void</span><br><span class="line">   +0x1ec AppCompatInfo    : Ptr32 Void</span><br><span class="line">   +0x1f0 CSDVersion       : _UNICODE_STRING</span><br><span class="line">   +0x1f8 ActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +0x1fc ProcessAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +0x200 SystemDefaultActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +0x204 SystemAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +0x208 MinimumStackCommit : Uint4B</span><br><span class="line">   +0x20c FlsCallback      : Ptr32 _FLS_CALLBACK_INFO</span><br><span class="line">   +0x210 FlsListHead      : _LIST_ENTRY</span><br><span class="line">   +0x218 FlsBitmap        : Ptr32 Void</span><br><span class="line">   +0x21c FlsBitmapBits    : [4] Uint4B</span><br><span class="line">   +0x22c FlsHighIndex     : Uint4B</span><br><span class="line">   +0x230 WerRegistrationData : Ptr32 Void</span><br><span class="line">   +0x234 WerShipAssertPtr : Ptr32 Void</span><br><span class="line">   +0x238 pContextData     : Ptr32 Void</span><br><span class="line">   +0x23c pImageHeaderHash : Ptr32 Void</span><br><span class="line">   +0x240 TracingFlags     : Uint4B</span><br><span class="line">   +0x240 HeapTracingEnabled : Pos 0, 1 Bit</span><br><span class="line">   +0x240 CritSecTracingEnabled : Pos 1, 1 Bit</span><br><span class="line">   +0x240 SpareTracingBits : Pos 2, 30 Bits</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="BeingDebugged"><a href="#BeingDebugged" class="headerlink" title="BeingDebugged"></a>BeingDebugged</h2><p>&#x3D;0表示未调试,≠0表示调试。</p>
<h2 id="NtGlobalFlag"><a href="#NtGlobalFlag" class="headerlink" title="NtGlobalFlag"></a>NtGlobalFlag</h2><p>&#x3D;0表示未调试,≠0表示调试。在 Windows NT中，有一组标志存储在全局变量NtGlobalFlag中，这在整个系统中是通用的。在启动时，NtGlobalFlag全局系统变量将使用系统注册表项中的值进行初始化：<code>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\GlobalFlag]</code>，要检查进程是否已使用调试器启动，请检查PEB结构中NtGlobal标志字段的值。此字段分别位于x32和x64系统的PEB 0x068和0x0bc偏移量。</p>
<p><img src="/.../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219165530733.png" alt="image-20221219165530733"></p>
<h2 id="ProcessHeap"><a href="#ProcessHeap" class="headerlink" title="ProcessHeap"></a>ProcessHeap</h2><table>
<thead>
<tr>
<th>标志名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ProcessHeap-&gt;Flags</td>
<td>&#x3D;2表示未调试,≠2表示调试。</td>
</tr>
<tr>
<td>ProcessHeap-&gt;ForceFlags</td>
<td>&#x3D;0表示未调试,≠0表示调试。</td>
</tr>
</tbody></table>
<h2 id="CrossProcessFlags"><a href="#CrossProcessFlags" class="headerlink" title="CrossProcessFlags"></a>CrossProcessFlags</h2><p>ULONG类型，每个位表达的含义不同，其中第四位为ProcessUsingVEH，可用来检测是否使用了VEH。</p>
<p><a target="_blank" rel="noopener" href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/crossprocessflags.htm">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/api/pebteb/peb/crossprocessflags.htm</a><br /><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221221153952332.png" alt="image-20221221153952332"></p>
<h1 id="二、API系列"><a href="#二、API系列" class="headerlink" title="二、API系列"></a>二、API系列</h1><h2 id="IsDebuggerPresent"><a href="#IsDebuggerPresent" class="headerlink" title="IsDebuggerPresent"></a>IsDebuggerPresent</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">IsDebuggerPresent</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>返回0表示未调试，返回1表示调试，实际上是读取BeingDebugged的值。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219144519199.png" alt="image-20221219144519199"></p>
<h2 id="CheckRemoteDebuggerPresent"><a href="#CheckRemoteDebuggerPresent" class="headerlink" title="CheckRemoteDebuggerPresent"></a>CheckRemoteDebuggerPresent</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CheckRemoteDebuggerPresent</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]      HANDLE hProcess,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] PBOOL  pbDebuggerPresent</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>检测进程是否处于调试状态，且其不仅仅可以检测自身是否处于调试状态，还可以检测其他程序是否处于调试状态，底层为调用NtQueryInformationProcess（ProcessDebugPort）。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219151607807.png" alt="image-20221219151607807"></p>
<h2 id="DbgBreakPoint"><a href="#DbgBreakPoint" class="headerlink" title="DbgBreakPoint"></a>DbgBreakPoint</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DebugBreak</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>软件断点,int3。调试器附加后会停留在此函数上进行中断等待,将函数头部改写ret可让调试结束</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219144823922.png" alt="image-20221219144823922"></p>
<h2 id="DbgUiRemoteBreakin"><a href="#DbgUiRemoteBreakin" class="headerlink" title="DbgUiRemoteBreakin"></a>DbgUiRemoteBreakin</h2><p>ntdll提供的用于在目标进程中创建远线程后下软件断点的函数,hook该函数可让调试器下断点时失败。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219145026132.png" alt="image-20221219145026132"></p>
<h2 id="NtQueryInformationProcess"><a href="#NtQueryInformationProcess" class="headerlink" title="NtQueryInformationProcess"></a>NtQueryInformationProcess</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQueryInformationProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE           ProcessHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            PROCESSINFOCLASS ProcessInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]           PVOID            ProcessInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG            ProcessInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG           ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ProcessInformationClass为一个宏，用于调试检测的值如下：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
<th>补充</th>
</tr>
</thead>
<tbody><tr>
<td>ProcessDebugPort（0x7）</td>
<td>检索一个 <strong>DWORD_PTR</strong> 值，该值是进程的调试器的端口号。 非零值指示进程在环 3 调试器的控制下运行。</td>
<td>无</td>
</tr>
<tr>
<td>ProcessDebugObjectHandle(0x1E)</td>
<td>调试器会为被调试的进程创建一个调试对象，该参数能获取调试对象的句柄,不为0则为调试。</td>
<td>无</td>
</tr>
<tr>
<td>ProcessDebugFlags（0x1F）</td>
<td>调试标志。调试时为0，未调试为1。</td>
<td>无</td>
</tr>
</tbody></table>
<h2 id="NtQueryInformationThread"><a href="#NtQueryInformationThread" class="headerlink" title="NtQueryInformationThread"></a>NtQueryInformationThread</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQueryInformationThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            HANDLE          ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            THREADINFOCLASS ThreadInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID           ThreadInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG           ThreadInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG          ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>检查当前线程上下文的Dr寄存器。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">WOW64_CONTEXT context = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">context.ContextFlags = WOW64_CONTEXT_ALL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(<span class="built_in">NtQueryInformationThread</span>(NtCurrentThread, ThreadWow64Context, &amp;context, <span class="built_in">sizeof</span>(context), <span class="literal">NULL</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.Dr0 || context.Dr1 || context.Dr2 || context.Dr3 || context.Dr6 || context.Dr7)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">DEBUG_LOG</span>(LL_ERR, <span class="string">&quot;Debugger detected via: ThreadWow64Context&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h2 id="NtQuerySystemInformation"><a href="#NtQuerySystemInformation" class="headerlink" title="NtQuerySystemInformation"></a>NtQuerySystemInformation</h2><p>可查询当前系统是否为调试模式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSTATUS <span class="title">NtQuerySystemInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out]       PVOID                    SystemInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    SystemInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>调试状态下 <code>SYSTEM_KERNEL_DEBUGGER_INFORMATION.DebuggerEnabled</code>值和<code>KernelDebuggerNotPresent</code>值为1。</p>
<h2 id="NtQueryObject"><a href="#NtQueryObject" class="headerlink" title="NtQueryObject"></a>NtQueryObject</h2><p>可查询内核对象。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__kernel_entry NTSYSCALLAPI NTSTATUS <span class="title">NtQueryObject</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional]  HANDLE                   Handle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            OBJECT_INFORMATION_CLASS ObjectInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PVOID                    ObjectInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            ULONG                    ObjectInformationLength,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PULONG                   ReturnLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="1、ObjectAllTypesInformation"><a href="#1、ObjectAllTypesInformation" class="headerlink" title="1、ObjectAllTypesInformation"></a>1、ObjectAllTypesInformation</h3><p>通过参数二传入<code>ObjectAllTypesInformation</code>获取所有对象后，判断是否存在调试对象。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历对象信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NtQueryObject</span>(<span class="literal">NULL</span>, ObjectAllInformation, p_Memory, objSize, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> main_end;</span><br><span class="line">    &#125;</span><br><span class="line">    p_ObjectAllInfo = (POBJECT_ALL_INFORMATION)p_Memory;</span><br><span class="line">    p_ObjInfoLocation = (PUCHAR)p_ObjectAllInfo-&gt;ObjectTypeInformation;</span><br><span class="line">    <span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; p_ObjectAllInfo-&gt;NumberOfObjects; i++) &#123;</span><br><span class="line">        p_ObjectTypeInfo = (POBJECT_TYPE_INFORMATION)p_ObjInfoLocation;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">wcscmp</span>(<span class="string">L&quot;DebugObject&quot;</span>, p_ObjectTypeInfo-&gt;TypeName.Buffer) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p_ObjectTypeInfo-&gt;TotalNumberOfObjects &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;发现调试器！&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;没有调试器&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        p_ObjInfoLocation = (PUCHAR)p_ObjectTypeInfo-&gt;TypeName.Buffer;</span><br><span class="line">        p_ObjInfoLocation += p_ObjectTypeInfo-&gt;TypeName.MaximumLength;</span><br><span class="line">        ULONG_PTR tmp = ((ULONG_PTR)p_ObjInfoLocation) &amp; -(<span class="type">int</span>)<span class="built_in">sizeof</span>(<span class="type">void</span>*);</span><br><span class="line">        <span class="keyword">if</span> ((ULONG_PTR)tmp != (ULONG_PTR)p_ObjInfoLocation) &#123;</span><br><span class="line">            tmp += <span class="built_in">sizeof</span>(<span class="type">void</span>*);</span><br><span class="line">        &#125;</span><br><span class="line">        p_ObjInfoLocation = ((<span class="type">unsigned</span> <span class="type">char</span>*)tmp);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、ObjectTypeInformation"><a href="#2、ObjectTypeInformation" class="headerlink" title="2、ObjectTypeInformation"></a>2、ObjectTypeInformation</h3><p>配合<code>NtCreateDebugObject</code>函数进行检测。首先创建一个调试对象，然后再查询该调试对象类型的对象总数，如果数量为1则表示没有调试，如果数量&gt;1则表示有其他调试器再调试进程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> <span class="title">checkDebugObj_4037F0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-1028h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2[<span class="number">6</span>]; <span class="comment">// [esp+8h] [ebp-1024h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [esp+23h] [ebp-1009h]</span></span><br><span class="line">  _DWORD v4[<span class="number">1025</span>]; <span class="comment">// [esp+24h] [ebp-1008h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">1</span>;</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="number">4096</span>);</span><br><span class="line">  v2[<span class="number">0</span>] = <span class="number">24</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v2[<span class="number">1</span>], <span class="number">0</span>, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">NtCreateDebugObject_404650</span>(&amp;v1, <span class="number">0x1F000F</span>, v2, <span class="number">0</span>);<span class="comment">// 创建一个调试对象</span></span><br><span class="line">  <span class="built_in">NtQueryObject_4045D0</span>(v1, ObjectTypeInformation, v4, <span class="number">0x1000</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v4[<span class="number">3</span>] == <span class="number">1</span> )                             <span class="comment">// 如果只有1个,即自己创建的对象,则没有被调试</span></span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">NtwClose_404560</span>(v1);                          <span class="comment">// 销毁创建的对象</span></span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NtSetInformationThread"><a href="#NtSetInformationThread" class="headerlink" title="NtSetInformationThread"></a>NtSetInformationThread</h2><p>可以通过给线程设置为<code>ThreadHideFromDebugger</code>使调试器无法捕获被隐藏线程的异常信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSYSAPI NTSTATUS <span class="title">ZwSetInformationThread</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HANDLE          ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] THREADINFOCLASS ThreadInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] PVOID           ThreadInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] ULONG           ThreadInformationLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="NtGetContextThread、NtSetContextThread"><a href="#NtGetContextThread、NtSetContextThread" class="headerlink" title="NtGetContextThread、NtSetContextThread"></a>NtGetContextThread、NtSetContextThread</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">GetThreadContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]      HANDLE    hThread,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, out] LPCONTEXT lpContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetThreadContext</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] HANDLE        hThread,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in] <span class="type">const</span> CONTEXT *lpContext</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>基于硬件断点的原理，可以将CR0-CR3寄存器清空，并且检查TF标志位。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* pfnNtGetContextThread)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_  HANDLE             ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    _Out_ PCONTEXT           pContext</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* pfnNtSetContextThread)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ HANDLE              ThreadHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ PCONTEXT            pContext</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HMODULE hNtDll = <span class="built_in">LoadLibrary</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ntdll.dll&quot;</span>));</span><br><span class="line">    <span class="keyword">auto</span> fnNtGetContextThread = (pfnNtGetContextThread)<span class="built_in">GetProcAddress</span>(hNtDll, <span class="string">&quot;NtGetContextThread&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> fnNtSetContextThread = (pfnNtSetContextThread)<span class="built_in">GetProcAddress</span>(hNtDll, <span class="string">&quot;NtSetContextThread&quot;</span>);</span><br><span class="line"></span><br><span class="line">    CONTEXT ctx&#123;&#125;;</span><br><span class="line">    <span class="built_in">fnNtGetContextThread</span>(<span class="built_in">GetCurrentThread</span>(),&amp;ctx);</span><br><span class="line">    ctx.Dr0 = <span class="number">0</span>; <span class="comment">//清空</span></span><br><span class="line">    ctx.Dr1 = <span class="number">0</span>;</span><br><span class="line">    ctx.Dr2 = <span class="number">0</span>;</span><br><span class="line">    ctx.Dr3 = <span class="number">0</span>;</span><br><span class="line">    ctx.EFlags &amp;= <span class="number">0x0FFFFFFF</span>; <span class="comment">//置TF为0</span></span><br><span class="line">    <span class="built_in">fnNtSetContextThread</span>(<span class="built_in">GetCurrentThread</span>(),&amp;ctx);</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OutputDebugStringA"><a href="#OutputDebugStringA" class="headerlink" title="OutputDebugStringA"></a>OutputDebugStringA</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">OutputDebugStringA</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] LPCSTR lpOutputString</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以通过构造部分特殊字符串使得调试器崩溃。恶意代码常尝试利用OllyDbg1.1的格式化字符串漏洞，为OutputDebugString函数提供一个%s字符串的参数，让OllyDbg崩溃。因此，需要注意程序中可疑的OutputDebugString调用，例如OutputDebugString(“%s%s%s%s%s%s%s%s%s”)。如果执行了这个调用，OllyDbg将会崩溃。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CHAR szFakeFormat[] = &#123; <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="number">0x0</span> &#125;; </span><br><span class="line"><span class="built_in">OutputDebugStringA</span>(szFakeFormat);</span><br></pre></td></tr></table></figure>

<p>也可以通过设置错误码，检测调试器。在有调试器存在和没有调试器存在时，OutputDebugString函数表现会有所不同。最明显的不同是， 如果有调试器存在，其后的GetLastError()的返回值为零。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetLastError</span>(<span class="number">1234</span>); </span><br><span class="line"><span class="built_in">OutputDebugString</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">tmpD=<span class="built_in">GetLastError</span>();</span><br><span class="line"><span class="keyword">if</span>(tmpD==<span class="number">1234</span>) <span class="comment">//默认为0，但由于设置了自定义的错误码，如果不等于我们设置的，说明被调试器接管。</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<h2 id="TimeCheck"><a href="#TimeCheck" class="headerlink" title="TimeCheck"></a>TimeCheck</h2><p>由于断点的存在导致断点前后存在时间差，可以使用GetTickCount或者QueryPerformanceCounter、rdtsc指令，或者等待事件的方法检测。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckSystemTime</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> bRet = <span class="literal">false</span>;</span><br><span class="line">	BOOLEAN bAdjustPrivRet;</span><br><span class="line">	<span class="keyword">auto</span> ntStatus =<span class="built_in">RtlAdjustPrivilege</span>(SE_SYSTEMTIME_PRIVILEGE, TRUE, FALSE, &amp;bAdjustPrivRet);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">auto</span> hEvent = <span class="built_in">CreateEventA</span>(<span class="literal">NULL</span>, FALSE, FALSE, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">IS_VALID_HANDLE</span>(hEvent))</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">//https://www.geoffchappell.com/studies/windows/km/ntoskrnl/api/ex/sysinfo/set.htm</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(<span class="built_in">NtSetSystemInformation</span>(SystemTimeSlipNotification, &amp;hEvent, <span class="built_in">sizeof</span>(hEvent))))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">WaitForSingleObject</span>(hEvent, <span class="number">1</span>) == WAIT_OBJECT_0) <span class="comment">//如果为有信号,说明进程处于中断状态</span></span><br><span class="line">					bRet = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">CloseHandle</span>(hEvent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NtSetDebugFilterState"><a href="#NtSetDebugFilterState" class="headerlink" title="NtSetDebugFilterState"></a>NtSetDebugFilterState</h2><p>函数ntdll!DbgSetDebugFilterState()和ntdll!NtSetDebugFilterState()只设置一个标志寄存器，如果内核模式的调试器存在，将被检查。<code>因此，如果一个内核调试器被连接到系统上，这些函数将成功。</code>然而，这些函数也可能因为一些用户模式的调试器引起的副作用而成功。这些功能需要管理员的权限。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckDebugFilterState</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> ntStatus = <span class="built_in">NtSetDebugFilterState</span>(<span class="number">0</span>, <span class="number">0</span>, TRUE);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">NT_SUCCESS</span>(ntStatus))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HeapSetInformation"><a href="#HeapSetInformation" class="headerlink" title="HeapSetInformation"></a>HeapSetInformation</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">HeapSetInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in, optional] HANDLE                 HeapHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           HEAP_INFORMATION_CLASS HeapInformationClass,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           PVOID                  HeapInformation,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]           SIZE_T                 HeapInformationLength</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>HeapCompatibilityInformation（0）</td>
<td>启用堆功能。 仅支持<code>低碎片堆 (LFH)</code>。 但是，应用程序不需要启用 LFH，因为系统根据需要使用 LFH 来服务内存分配请求。<br/>Windows XP 和 Windows Server 2003： 默认情况下，LFH 未启用。 若要为指定的堆启用 LFH，请将 HeapInformation 参数指向的变量设置为 2。 为堆启用 LFH 后，无法禁用它。<br/>不能为使用 HEAP_NO_SERIALIZE 创建的堆或固定大小的堆启用 LFH。 如果在 Windows 或 Microsoft 应用程序验证程序调试工具中使用堆调试工具，则无法启用 LFH。<br/><code>在任何调试器下运行进程时，将自动为进程中的所有堆启用某些堆调试选项。 这些堆调试选项阻止使用 LFH。 若要在调试器下运行时启用低碎片堆，请将_NO_DEBUG_HEAP环境变量设置为 1。</code></td>
</tr>
</tbody></table>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckHeapSetInformation</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG uHeapInfo = <span class="number">2</span>; <span class="comment">/* HEAP_LFH */</span></span><br><span class="line">	<span class="keyword">if</span> (!g_winapiApiTable-&gt;<span class="built_in">HeapSetInformation</span>(g_winapiApiTable-&gt;<span class="built_in">GetProcessHeap</span>(), HeapCompatibilityInformation, &amp;uHeapInfo, <span class="built_in">sizeof</span>(uHeapInfo)))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//如果能设置则表示有调试</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NtSystemDebugControl"><a href="#NtSystemDebugControl" class="headerlink" title="NtSystemDebugControl"></a>NtSystemDebugControl</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">CheckSystemDebugControl</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> dwReturnLength		= <span class="number">0UL</span>;</span><br><span class="line">	<span class="keyword">auto</span> ntStatus			= g_winapiApiTable-&gt;<span class="built_in">NtSystemDebugControl</span>(SysDbgBreakPoint, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">DEBUG_LOG</span>(LL_SYS, <span class="string">&quot;NtSystemDebugControl completed! Status: %p Return length: %u&quot;</span>, ntStatus, dwReturnLength);</span><br><span class="line">	<span class="keyword">return</span> (ntStatus != STATUS_DEBUGGER_INACTIVE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RtlCaptureStackBackTrace"><a href="#RtlCaptureStackBackTrace" class="headerlink" title="RtlCaptureStackBackTrace"></a>RtlCaptureStackBackTrace</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSYSAPI WORD <span class="title">RtlCaptureStackBackTrace</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            DWORD  FramesToSkip,</span></span></span><br><span class="line"><span class="params"><span class="function">  [in]            DWORD  FramesToCapture,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out]           PVOID  *BackTrace,</span></span></span><br><span class="line"><span class="params"><span class="function">  [out, optional] PDWORD BackTraceHash</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>该函数可以捕获当前调用堆栈的栈回溯。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DbgHelp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;Dbghelp.lib&quot;</span>)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/***********************************</span></span><br><span class="line"><span class="comment">1.PrintfStackInfo(),可打印当前的调用堆栈信息</span></span><br><span class="line"><span class="comment">2.如try catch,无法捕获异常，如除0，访问非法地址等</span></span><br><span class="line"><span class="comment">项目属性中设置 C/C++  -&gt;代码生成  -&gt;启用c++异常选择“是，但有 SEH 异常 (/EHa)”</span></span><br><span class="line"><span class="comment">try</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	.....</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">catch (...)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	PrintfStackInfo();</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">3.如多个函数嵌套，PrintfStackInfo只会打印当前函数的位置</span></span><br><span class="line"><span class="comment">/***********************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">wchar2strstring</span><span class="params">(std::string &amp; szDst, WCHAR * wchart)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">wchar_t</span> * wtext = wchart;</span><br><span class="line">	DWORD dwNmu = <span class="built_in">WideCharToMultiByte</span>(CP_OEMCP, <span class="literal">NULL</span>, wtext, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">	<span class="type">char</span> * psTest;</span><br><span class="line">	psTest = <span class="keyword">new</span> <span class="type">char</span>[dwNmu];</span><br><span class="line">	<span class="built_in">WideCharToMultiByte</span>(CP_OEMCP, <span class="literal">NULL</span>, wtext, <span class="number">-1</span>, psTest, dwNmu, <span class="literal">NULL</span>, FALSE);</span><br><span class="line">	szDst = psTest;</span><br><span class="line">	<span class="keyword">delete</span>[]psTest;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShowTraceStack</span><span class="params">(std::vector&lt;std::string&gt;&amp; vInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	vInfo.<span class="built_in">clear</span>();</span><br><span class="line">	<span class="keyword">enum</span></span><br><span class="line">	&#123;</span><br><span class="line">		MAX_STACK_FRAMES = <span class="number">16</span></span><br><span class="line">	&#125;;</span><br><span class="line"> </span><br><span class="line">	<span class="type">void</span>* arrBackTrace[MAX_STACK_FRAMES] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"> </span><br><span class="line">	HANDLE hProcess = <span class="built_in">GetCurrentProcess</span>();</span><br><span class="line">	<span class="built_in">SymInitialize</span>(hProcess, <span class="literal">NULL</span>, TRUE);</span><br><span class="line">	<span class="function"><span class="keyword">typedef</span> <span class="title">USHORT</span><span class="params">(*PFUNRtlCaptureStackBackTrace)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		ULONG  FramesToSkip,</span></span></span><br><span class="line"><span class="params"><span class="function">		ULONG  FramesToCapture,</span></span></span><br><span class="line"><span class="params"><span class="function">		PVOID* BackTrace,</span></span></span><br><span class="line"><span class="params"><span class="function">		PULONG BackTraceHash</span></span></span><br><span class="line"><span class="params"><span class="function">		)</span></span>;</span><br><span class="line">	HMODULE hNt = <span class="built_in">LoadLibrary</span>(_T(<span class="string">&quot;NtDll.dll&quot;</span>));</span><br><span class="line">	PFUNRtlCaptureStackBackTrace</span><br><span class="line">		pCaptureStackBackTrace = (PFUNRtlCaptureStackBackTrace)</span><br><span class="line">		<span class="built_in">GetProcAddress</span>(hNt, (<span class="string">&quot;RtlCaptureStackBackTrace&quot;</span>));</span><br><span class="line">	<span class="keyword">if</span> (!pCaptureStackBackTrace)</span><br><span class="line">	&#123;</span><br><span class="line">		vInfo.<span class="built_in">push_back</span>(<span class="string">&quot;RtlCaptureStackBackTrace load failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	CString strStackInfo;</span><br><span class="line">	WORD wFrames = <span class="built_in">pCaptureStackBackTrace</span>(<span class="number">0</span>, MAX_STACK_FRAMES, arrBackTrace, <span class="literal">NULL</span>);</span><br><span class="line"> </span><br><span class="line">	TCHAR szBuffer[<span class="built_in">sizeof</span>(SYMBOL_INFOW) + <span class="function">MAX_SYM_NAME * <span class="title">sizeof</span><span class="params">(TCHAR)</span>]</span>;</span><br><span class="line">	DWORD64 dwAddress = <span class="number">0</span>;</span><br><span class="line">	DWORD64 dwDisplacement = <span class="number">0</span>;</span><br><span class="line">	PSYMBOL_INFOW pSymbol = <span class="literal">NULL</span>;</span><br><span class="line">	DWORD dwDisplacement2 = <span class="number">0</span>;</span><br><span class="line">	IMAGEHLP_LINEW64  ilLine;</span><br><span class="line">	<span class="keyword">for</span> (WORD wIndex = <span class="number">0</span>; wIndex &lt; wFrames; ++wIndex)</span><br><span class="line">	&#123;</span><br><span class="line">		dwAddress = (DWORD64)(arrBackTrace[wIndex]);</span><br><span class="line">		dwDisplacement = <span class="number">0</span>;</span><br><span class="line">		pSymbol = (PSYMBOL_INFOW)szBuffer;</span><br><span class="line">		pSymbol-&gt;SizeOfStruct = <span class="built_in">sizeof</span>(SYMBOL_INFOW);</span><br><span class="line">		pSymbol-&gt;MaxNameLen = MAX_SYM_NAME;</span><br><span class="line"> </span><br><span class="line">		dwDisplacement2 = <span class="number">0</span>;</span><br><span class="line">		ilLine.SizeOfStruct = <span class="built_in">sizeof</span>(IMAGEHLP_LINEW64);</span><br><span class="line"> </span><br><span class="line">		<span class="keyword">if</span> (TRUE == <span class="built_in">SymFromAddrW</span>(hProcess, dwAddress, &amp;dwDisplacement, pSymbol) &amp;&amp;</span><br><span class="line">			TRUE == <span class="built_in">SymGetLineFromAddrW64</span>(hProcess, dwAddress, &amp;dwDisplacement2, &amp;ilLine))</span><br><span class="line">		&#123;</span><br><span class="line">			std::string sname, sfile;</span><br><span class="line">			<span class="built_in">wchar2strstring</span>(sname, pSymbol-&gt;Name);</span><br><span class="line">			<span class="built_in">wchar2strstring</span>(sfile, ilLine.FileName);</span><br><span class="line">			strStackInfo.<span class="built_in">Format</span>(_T(<span class="string">&quot;FUN:%s() File：%s:[%d]&quot;</span>), sname.<span class="built_in">c_str</span>(), sfile.<span class="built_in">c_str</span>(), ilLine.LineNumber);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			strStackInfo.<span class="built_in">Format</span>((<span class="string">&quot;query error: %d&quot;</span>), <span class="built_in">GetLastError</span>());</span><br><span class="line">		&#125;</span><br><span class="line">		vInfo.<span class="built_in">push_back</span>(strStackInfo.<span class="built_in">GetBuffer</span>());</span><br><span class="line"> </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">FreeLibrary</span>(hNt);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintfStackInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;===========start===========\n&quot;</span>);</span><br><span class="line">	std::vector&lt;std::string&gt; mVStackList;</span><br><span class="line">	<span class="built_in">ShowTraceStack</span>(mVStackList);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mVStackList.<span class="built_in">size</span>(); i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, mVStackList[i].<span class="built_in">c_str</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;===========end===========\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="三、异常捕获"><a href="#三、异常捕获" class="headerlink" title="三、异常捕获"></a>三、异常捕获</h1><h2 id="CloseHandle、NtGetContextThread"><a href="#CloseHandle、NtGetContextThread" class="headerlink" title="CloseHandle、NtGetContextThread"></a>CloseHandle、NtGetContextThread</h2><p>可以通过传入错误参数的手段让调试器抛出异常后检测调试。调试情况下,一个非法的句柄会引发0xC00000008。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219154705788.png" alt="image-20221219154705788"></p>
<p>非调试情况下。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219154800065.png" alt="image-20221219154800065"></p>
<p>因此可以使用异常捕获来判断是否被调试。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __try &#123;</span><br><span class="line">        <span class="built_in">CloseHandle</span>((HANDLE)<span class="number">672368</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;debugger&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>VS调试模式下运行。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219155345233.png" alt="image-20221219155345233"></p>
<p>正常运行。</p>
<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219155353983.png" alt="image-20221219155353983"></p>
<p><code>NtGetContextThread</code>同理。</p>
<p>其他可用函数还有</p>
<blockquote>
<p>NtQueryInformationProcess</p>
<p>CloseWindow</p>
</blockquote>
<h2 id="SetHandleInformation"><a href="#SetHandleInformation" class="headerlink" title="SetHandleInformation"></a><strong>SetHandleInformation</strong></h2><p>通过创建一个互斥体对象，利用<strong>SetHandleInformation将互斥体对象句柄</strong>标志改为HANDLE_FLAG_PROTECT_FROM_CLOSE，然后关闭句柄，如果是在调试器状态下，它会抛出EXCEPTION_EXECUTE_HANDLER异常，只要捕获到异常那么就表示程序被调试。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>HANDLE_FLAG_PROTECT_FROM_CLOSE（0x2）</td>
<td>如果设置了此标志，则调用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/desktop/api/handleapi/nf-handleapi-closehandle">CloseHandle</a> 函数不会关闭对象句柄。</td>
</tr>
</tbody></table>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title">CheckCloseHandle2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> hMutex = <span class="built_in">CreateMutexA</span>(<span class="literal">NULL</span>, FALSE, <span class="string">&quot;ntdil.dli&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IS_VALID_HANDLE</span>(hMutex))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">SetHandleInformation</span>(hMutex, HANDLE_FLAG_PROTECT_FROM_CLOSE, HANDLE_FLAG_PROTECT_FROM_CLOSE))</span><br><span class="line">		&#123;</span><br><span class="line">			__try </span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">CloseHandle</span>(hMutex);</span><br><span class="line">			&#125;</span><br><span class="line">			__except (HANDLE_FLAG_PROTECT_FROM_CLOSE)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SetUnhandledExceptionFilter、UnhandledExcepFilter"><a href="#SetUnhandledExceptionFilter、UnhandledExcepFilter" class="headerlink" title="SetUnhandledExceptionFilter、UnhandledExcepFilter"></a>SetUnhandledExceptionFilter、UnhandledExcepFilter</h2><p>通过设置一个SEH函数，然后抛出一个异常，使其跳转到其他地方进行检查调试。如果有调试器时，默认由调试器接管异常。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Test_Console_1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有调试器，则不会执行这个函数</span></span><br><span class="line">BOOL bIsBeinDbg = TRUE;</span><br><span class="line"><span class="function">LONG WINAPI <span class="title">UnhandledExcepFilter</span><span class="params">(PEXCEPTION_POINTERS pExcepPointers)</span></span>&#123;</span><br><span class="line">    bIsBeinDbg = FALSE;</span><br><span class="line">    <span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 注册异常处理函数</span></span><br><span class="line">    LPTOP_LEVEL_EXCEPTION_FILTER Top = <span class="built_in">SetUnhandledExceptionFilter</span>(UnhandledExcepFilter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主动抛出一个异常</span></span><br><span class="line">    <span class="built_in">RaiseException</span>(EXCEPTION_FLT_DIVIDE_BY_ZERO, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bIsBeinDbg == TRUE) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;发现调试器！&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;没有调试器！&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">main_end:</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../images/Anti/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0%E5%8F%8D%E8%B0%83%E8%AF%95/image-20221219160642924.png" alt="image-20221219160642924"></p>
<h2 id="RtlQueryProcessDebugInformation"><a href="#RtlQueryProcessDebugInformation" class="headerlink" title="RtlQueryProcessDebugInformation"></a>RtlQueryProcessDebugInformation</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PRTL_DEBUG_INFORMATION NTAPI* <span class="title">RtlCreateQueryDebugBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG  Size, </span></span></span><br><span class="line"><span class="params"><span class="function">    IN BOOLEAN  EventPair</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS NTAPI* <span class="title">RtlQueryProcessDebugInformation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG  ProcessId, </span></span></span><br><span class="line"><span class="params"><span class="function">    IN ULONG  DebugInfoClassMask, </span></span></span><br><span class="line"><span class="params"><span class="function">    IN OUT PRTL_DEBUG_INFORMATION   </span></span></span><br><span class="line"><span class="params"><span class="function">    DebugBuffer)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>ntdll!RtlQueryProcessDebugInformation()</code>函数可用于从请求进程的进程内存中读取某些字段，包括堆标志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bool Check()</span><br><span class="line">&#123;</span><br><span class="line">    ntdll::PDEBUG_BUFFER pDebugBuffer = ntdll::RtlCreateQueryDebugBuffer(0, FALSE);</span><br><span class="line">    if (!SUCCEEDED(ntdll::RtlQueryProcessDebugInformation(GetCurrentProcessId(), ntdll::PDI_HEAPS | ntdll::PDI_HEAP_BLOCKS, pDebugBuffer)))</span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    ULONG dwFlags = ((ntdll::PRTL_PROCESS_HEAPS)pDebugBuffer-&gt;HeapInformation)-&gt;Heaps[0].Flags;</span><br><span class="line">    return dwFlags &amp; ~HEAP_GROWABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RtlQueryProcessHeapInformation"><a href="#RtlQueryProcessHeapInformation" class="headerlink" title="RtlQueryProcessHeapInformation"></a>RtlQueryProcessHeapInformation</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSTATUS NTAPI <span class="title">RtlQueryProcessHeapInformation</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">    IN OUT PRTL_DEBUG_INFORMATION Buffer </span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>ntdll!RtlQueryProcessHeapInformation()</code>函数可用于从当前进程的进程内存中读取堆标志</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ool <span class="title">Check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ntdll::PDEBUG_BUFFER pDebugBuffer = ntdll::<span class="built_in">RtlCreateQueryDebugBuffer</span>(<span class="number">0</span>, FALSE);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">SUCCEEDED</span>(ntdll::<span class="built_in">RtlQueryProcessHeapInformation</span>((ntdll::PRTL_DEBUG_INFORMATION)pDebugBuffer)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    ULONG dwFlags = ((ntdll::PRTL_PROCESS_HEAPS)pDebugBuffer-&gt;HeapInformation)-&gt;Heaps[<span class="number">0</span>].Flags;</span><br><span class="line">    <span class="keyword">return</span> dwFlags &amp; ~HEAP_GROWABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="四、注册表"><a href="#四、注册表" class="headerlink" title="四、注册表"></a>四、注册表</h1><h2 id="GlobalFlagsClear"><a href="#GlobalFlagsClear" class="headerlink" title="GlobalFlagsClear"></a>GlobalFlagsClear</h2><p>可执行文件可以包含<code>IMAGE_LOAD_CONFIG_DIRECTORY</code>结构，该结构包含系统加载程序的其他配置参数。默认情况下，此结构不会内置于可执行文件中，但可以使用修补程序添加它。此结构具有<code>GlobalFlagsClear</code> ，该字段指示应重置 PEB 结构的 <code>NtGlobalFlag</code> 标志字段的哪些标志。该字段具有非零值，表示存在隐藏的调试器。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_IMAGE_LOAD_CONFIG_DIRECTORY</span> &#123;</span><br><span class="line">    DWORD      Size;</span><br><span class="line">    DWORD      TimeDateStamp;</span><br><span class="line">    WORD       MajorVersion;</span><br><span class="line">    WORD       MinorVersion;</span><br><span class="line">    DWORD      GlobalFlagsClear;</span><br><span class="line">    DWORD      GlobalFlagsSet;</span><br><span class="line">    DWORD      CriticalSectionDefaultTimeout;</span><br><span class="line">    ULONGLONG  DeCommitFreeBlockThreshold;</span><br><span class="line">    ULONGLONG  DeCommitTotalFreeThreshold;</span><br><span class="line">    ULONGLONG  LockPrefixTable;                <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  MaximumAllocationSize;</span><br><span class="line">    ULONGLONG  VirtualMemoryThreshold;</span><br><span class="line">    ULONGLONG  ProcessAffinityMask;</span><br><span class="line">    DWORD      ProcessHeapFlags;</span><br><span class="line">    WORD       CSDVersion;</span><br><span class="line">    WORD       DependentLoadFlags;</span><br><span class="line">    ULONGLONG  EditList;                       <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  SecurityCookie;                 <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  SEHandlerTable;                 <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  SEHandlerCount;</span><br><span class="line">    ULONGLONG  GuardCFCheckFunctionPointer;    <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardCFDispatchFunctionPointer; <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardCFFunctionTable;           <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardCFFunctionCount;</span><br><span class="line">    DWORD      GuardFlags;</span><br><span class="line">    IMAGE_LOAD_CONFIG_CODE_INTEGRITY CodeIntegrity;</span><br><span class="line">    ULONGLONG  GuardAddressTakenIatEntryTable; <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardAddressTakenIatEntryCount;</span><br><span class="line">    ULONGLONG  GuardLongJumpTargetTable;       <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardLongJumpTargetCount;</span><br><span class="line">    ULONGLONG  DynamicValueRelocTable;         <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  CHPEMetadataPointer;            <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardRFFailureRoutine;          <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardRFFailureRoutineFunctionPointer; <span class="comment">// VA</span></span><br><span class="line">    DWORD      DynamicValueRelocTableOffset;</span><br><span class="line">    WORD       DynamicValueRelocTableSection;</span><br><span class="line">    WORD       Reserved2;</span><br><span class="line">    ULONGLONG  GuardRFVerifyStackPointerFunctionPointer; <span class="comment">// VA</span></span><br><span class="line">    DWORD      HotPatchTableOffset;</span><br><span class="line">    DWORD      Reserved3;</span><br><span class="line">    ULONGLONG  EnclaveConfigurationPointer;    <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  VolatileMetadataPointer;        <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardEHContinuationTable;       <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardEHContinuationCount;</span><br><span class="line">    ULONGLONG  GuardXFGCheckFunctionPointer;   <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardXFGDispatchFunctionPointer; <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardXFGTableDispatchFunctionPointer; <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  CastGuardOsDeterminedFailureMode; <span class="comment">// VA</span></span><br><span class="line">    ULONGLONG  GuardMemcpyFunctionPointer;     <span class="comment">// VA</span></span><br><span class="line">&#125; IMAGE_LOAD_CONFIG_DIRECTORY, *PIMAGE_LOAD_CONFIG_DIRECTORY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">PIMAGE_NT_HEADERS <span class="title">GetImageNtHeaders</span><span class="params">(PBYTE pImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PIMAGE_DOS_HEADER pImageDosHeader = (PIMAGE_DOS_HEADER)pImageBase;</span><br><span class="line">    <span class="keyword">return</span> (PIMAGE_NT_HEADERS)(pImageBase + pImageDosHeader-&gt;e_lfanew);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">PIMAGE_SECTION_HEADER <span class="title">FindRDataSection</span><span class="params">(PBYTE pImageBase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> std::string rdata = <span class="string">&quot;.rdata&quot;</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS pImageNtHeaders = <span class="built_in">GetImageNtHeaders</span>(pImageBase);</span><br><span class="line">    PIMAGE_SECTION_HEADER pImageSectionHeader = <span class="built_in">IMAGE_FIRST_SECTION</span>(pImageNtHeaders);</span><br><span class="line">    <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; n &lt; pImageNtHeaders-&gt;FileHeader.NumberOfSections; ++n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdata == (<span class="type">char</span>*)pImageSectionHeader[n].Name)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;pImageSectionHeader[n];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CheckGlobalFlagsClearInProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PBYTE pImageBase = (PBYTE)<span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">    PIMAGE_NT_HEADERS pImageNtHeaders = <span class="built_in">GetImageNtHeaders</span>(pImageBase);</span><br><span class="line">    PIMAGE_LOAD_CONFIG_DIRECTORY pImageLoadConfigDirectory = (PIMAGE_LOAD_CONFIG_DIRECTORY)(pImageBase</span><br><span class="line">        + pImageNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG].VirtualAddress);</span><br><span class="line">    <span class="keyword">if</span> (pImageLoadConfigDirectory-&gt;GlobalFlagsClear != <span class="number">0</span>) #  内存中检查IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Stop debugging program!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CheckGlobalFlagsClearInFile</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hExecutable = INVALID_HANDLE_VALUE;</span><br><span class="line">    HANDLE hExecutableMapping = <span class="literal">NULL</span>;</span><br><span class="line">    PBYTE pMappedImageBase = <span class="literal">NULL</span>;</span><br><span class="line">    __try</span><br><span class="line">    &#123;</span><br><span class="line">        PBYTE pImageBase = (PBYTE)<span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">        PIMAGE_SECTION_HEADER pImageSectionHeader = <span class="built_in">FindRDataSection</span>(pImageBase);</span><br><span class="line">        TCHAR pszExecutablePath[MAX_PATH];</span><br><span class="line">        DWORD dwPathLength = <span class="built_in">GetModuleFileName</span>(<span class="literal">NULL</span>, pszExecutablePath, MAX_PATH);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == dwPathLength) __leave;</span><br><span class="line">        hExecutable = <span class="built_in">CreateFile</span>(pszExecutablePath, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (INVALID_HANDLE_VALUE == hExecutable) __leave;</span><br><span class="line">        hExecutableMapping = <span class="built_in">CreateFileMapping</span>(hExecutable, <span class="literal">NULL</span>, PAGE_READONLY, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == hExecutableMapping) __leave;</span><br><span class="line">        pMappedImageBase = (PBYTE)<span class="built_in">MapViewOfFile</span>(hExecutableMapping, FILE_MAP_READ, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            pImageSectionHeader-&gt;PointerToRawData + pImageSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == pMappedImageBase) __leave;</span><br><span class="line">        PIMAGE_NT_HEADERS pImageNtHeaders = <span class="built_in">GetImageNtHeaders</span>(pMappedImageBase);</span><br><span class="line">        PIMAGE_LOAD_CONFIG_DIRECTORY pImageLoadConfigDirectory = (PIMAGE_LOAD_CONFIG_DIRECTORY)(pMappedImageBase </span><br><span class="line">            + (pImageSectionHeader-&gt;PointerToRawData</span><br><span class="line">                + (pImageNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG].VirtualAddress - pImageSectionHeader-&gt;VirtualAddress)));</span><br><span class="line">        <span class="keyword">if</span> (pImageLoadConfigDirectory-&gt;GlobalFlagsClear != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Stop debugging program!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __finally</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != pMappedImageBase)</span><br><span class="line">            <span class="built_in">UnmapViewOfFile</span>(pMappedImageBase);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != hExecutableMapping)</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hExecutableMapping);</span><br><span class="line">        <span class="keyword">if</span> (INVALID_HANDLE_VALUE != hExecutable)</span><br><span class="line">            <span class="built_in">CloseHandle</span>(hExecutable);</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="SystemBoot"><a href="#SystemBoot" class="headerlink" title="SystemBoot"></a>SystemBoot</h2><p>可以通过枚举系统启动项中是否存在debug相关字符串判断是否处于调试模式。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckDebugBoot</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> hKey = <span class="built_in">HKEY</span>(<span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">auto</span> dwRegOpenRet = <span class="built_in">RegOpenKeyExA</span>(HKEY_LOCAL_MACHINE, <span class="built_in">xorstr</span>(<span class="string">&quot;System\\CurrentControlSet\\Control&quot;</span>).<span class="built_in">crypt_get</span>(), <span class="number">0</span>, KEY_READ, &amp;hKey);</span><br><span class="line">	<span class="keyword">if</span> (dwRegOpenRet != ERROR_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">char</span> szBootOptions[<span class="number">1024</span>]	= &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">auto</span> dwLen					= <span class="built_in">DWORD</span>(<span class="built_in">sizeof</span>(szBootOptions) - <span class="built_in">sizeof</span>(CHAR));</span><br><span class="line">	<span class="keyword">auto</span> dwRegGetRet			= <span class="built_in">RegGetValueA</span>(hKey, <span class="literal">NULL</span>, <span class="built_in">xorstr</span>(<span class="string">&quot;SystemStartOptions&quot;</span>).<span class="built_in">crypt_get</span>(), RRF_RT_REG_SZ, <span class="literal">NULL</span>, szBootOptions, &amp;dwLen);</span><br><span class="line">	<span class="keyword">if</span> (dwRegGetRet != ERROR_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		g_winapiApiTable-&gt;<span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">auto</span> szLowerOptions =<span class="built_in">szLower</span>(szBootOptions);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strstr</span>(szLowerOptions.<span class="built_in">c_str</span>(), <span class="built_in">xorstr</span>(<span class="string">&quot;debug&quot;</span>).<span class="built_in">crypt_get</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、堆检测"><a href="#五、堆检测" class="headerlink" title="五、堆检测"></a>五、堆检测</h1><h2 id="HeapTail"><a href="#HeapTail" class="headerlink" title="HeapTail"></a>HeapTail</h2><p>如果处于调试中，堆尾部也会留下痕迹。标志HEAP_TAIL_CHECKING_ENABLED 将会在分配的堆块尾部生成两个0xABABABAB。如果需要额外的字节来填充堆尾，HEAP_FREE_CHECKING_ENABLED标志则会生成0xFEEEFEEE。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckHeapTail</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD flag[] = &#123; <span class="number">0xabababab</span>, <span class="number">0xabababab</span> &#125;;</span><br><span class="line">	<span class="keyword">auto</span> buff = <span class="built_in">reinterpret_cast</span>&lt;DWORD_PTR&gt;(g_nmApp-&gt;<span class="built_in">DynamicWinapiInstance</span>()-&gt;<span class="built_in">NTHelper</span>()-&gt;<span class="built_in">Alloc</span>(<span class="number">32</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> temp = buff + <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> dwRet = <span class="built_in">memcmp</span>((LPVOID)temp, (LPVOID)flag, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">	g_nmApp-&gt;<span class="built_in">DynamicWinapiInstance</span>()-&gt;<span class="built_in">NTHelper</span>()-&gt;<span class="built_in">Free</span>(<span class="built_in">reinterpret_cast</span>&lt;PVOID&gt;(buff));</span><br><span class="line">	<span class="keyword">return</span> dwRet == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="六、符号检查"><a href="#六、符号检查" class="headerlink" title="六、符号检查"></a>六、符号检查</h1><h2 id="Syser"><a href="#Syser" class="headerlink" title="Syser"></a>Syser</h2><p>调试工具通常会使用内核驱动，因此如果尝试是否可以打开一些调试器所用到的设备，就可判断是否存在调试器。</p>
<blockquote>
<p>\\.\Syser</p>
<p>\\.\SyserBoot</p>
<p>\\.\SyserDbgMsg</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;SICE</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;SIWVID</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;SIWVIDSTART</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;NTICE</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;ICEEXT</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;TRW</p>
<p>&#x2F;&#x2F;&#x2F;&#x2F;..&#x2F;images&#x2F;Anti&#x2F;&#x2F;TRWDEBUG</p>
</blockquote>
<h1 id="七、ETC"><a href="#七、ETC" class="headerlink" title="七、ETC"></a>七、ETC</h1><p>是一种通过直接检测当前程序、窗口等等中是否含有常见反调试软件，如果有则停止程序。</p>
<ol>
<li><p>检测调试器窗口—–&gt;FindWindow()</p>
</li>
<li><p>检测调试器进程——&gt;CreatToolhelp32Snapshot（）</p>
</li>
<li><p>检查计算机名称是否为“TEST”，“ANALYSIS”等——-&gt;GetComputerName（）</p>
</li>
<li><p>检查程序运行路径是否存在“TEST”，“SAMPLE”等名称——-&gt;GetCommandLine()</p>
</li>
<li><p>检测虚拟机是否处于运行状态（查看虚拟机特有的进程名称—-&gt;VMWareService.exe，VMWareTray.exe，VMWareUser.exe等）</p>
</li>
<li><p>枚举每个进程下的一些特殊文件。</p>
</li>
<li><p>检查每个进程的资源。</p>
</li>
<li><p>等等…..</p>
</li>
</ol>
<h1 id="八、其他"><a href="#八、其他" class="headerlink" title="八、其他"></a>八、其他</h1><h2 id="KUSER-SHARED-DATA"><a href="#KUSER-SHARED-DATA" class="headerlink" title="KUSER_SHARED_DATA"></a>KUSER_SHARED_DATA</h2><p>无论是在 32 位系统内存分布，还是在 64 位系统内存分布中，我们知道高地址空间分配给系统内核使用，低地址空间分配给用户进程使用。</p>
<p>事实上，用户空间和内核空间其实有一块共享区域（KUSER_SHARED_DATA），大小为 4 KB。它们的内存地址虽然不一样，但是它们都是有同一块物理内存映射出来的，KdDebuggerEnabled 就在存放这一块内存里。</p>
<p>对于 32 位系统和 64 位系统来说，这块共享区域对应的内核地址范围以及对应用户空间的地址范围如下表所示：</p>
<table>
<thead>
<tr>
<th>mode</th>
<th>kernel start</th>
<th>kernel end</th>
<th>user start</th>
<th>user end</th>
</tr>
</thead>
<tbody><tr>
<td>x86</td>
<td>0xFFDF0000</td>
<td>0xFFDF0FFF</td>
<td>0x7FFE0000</td>
<td>0x7FFE0FFF</td>
</tr>
<tr>
<td>x64</td>
<td>0xFFFFF78000000000</td>
<td>0xFFFFF78000000FFF</td>
<td>0x7FFE0000</td>
<td>0x7FFE0FFF</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">dt _KUSER_SHARED_DATA     // win11前</span><br><span class="line">nt!_KUSER_SHARED_DATA</span><br><span class="line">   +0x000 TickCountLowDeprecated : Uint4B</span><br><span class="line">   +0x004 TickCountMultiplier : Uint4B</span><br><span class="line">   +0x008 InterruptTime    : _KSYSTEM_TIME</span><br><span class="line">   +0x014 SystemTime       : _KSYSTEM_TIME</span><br><span class="line">   +0x020 TimeZoneBias     : _KSYSTEM_TIME</span><br><span class="line">   +0x02c ImageNumberLow   : Uint2B</span><br><span class="line">   +0x02e ImageNumberHigh  : Uint2B</span><br><span class="line">   +0x030 NtSystemRoot     : [260] Wchar</span><br><span class="line">   +0x238 MaxStackTraceDepth : Uint4B</span><br><span class="line">   +0x23c CryptoExponent   : Uint4B</span><br><span class="line">   +0x240 TimeZoneId       : Uint4B</span><br><span class="line">   +0x244 LargePageMinimum : Uint4B</span><br><span class="line">   +0x248 AitSamplingValue : Uint4B</span><br><span class="line">   +0x24c AppCompatFlag    : Uint4B</span><br><span class="line">   +0x250 RNGSeedVersion   : Uint8B</span><br><span class="line">   +0x258 GlobalValidationRunlevel : Uint4B</span><br><span class="line">   +0x25c TimeZoneBiasStamp : Int4B</span><br><span class="line">   +0x260 NtBuildNumber    : Uint4B</span><br><span class="line">   +0x264 NtProductType    : _NT_PRODUCT_TYPE</span><br><span class="line">   +0x268 ProductTypeIsValid : UChar</span><br><span class="line">   +0x269 Reserved0        : [1] UChar</span><br><span class="line">   +0x26a NativeProcessorArchitecture : Uint2B</span><br><span class="line">   +0x26c NtMajorVersion   : Uint4B</span><br><span class="line">   +0x270 NtMinorVersion   : Uint4B</span><br><span class="line">   +0x274 ProcessorFeatures : [64] UChar</span><br><span class="line">   +0x2b4 Reserved1        : Uint4B</span><br><span class="line">   +0x2b8 Reserved3        : Uint4B</span><br><span class="line">   +0x2bc TimeSlip         : Uint4B</span><br><span class="line">   +0x2c0 AlternativeArchitecture : _ALTERNATIVE_ARCHITECTURE_TYPE</span><br><span class="line">   +0x2c4 BootId           : Uint4B</span><br><span class="line">   +0x2c8 SystemExpirationDate : _LARGE_INTEGER</span><br><span class="line">   +0x2d0 SuiteMask        : Uint4B</span><br><span class="line">   +0x2d4 KdDebuggerEnabled : UChar                            // &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;  划重点 </span><br><span class="line">   +0x2d5 MitigationPolicies : UChar</span><br><span class="line">   +0x2d5 NXSupportPolicy  : Pos 0, 2 Bits</span><br><span class="line">   +0x2d5 SEHValidationPolicy : Pos 2, 2 Bits</span><br><span class="line">   +0x2d5 CurDirDevicesSkippedForDlls : Pos 4, 2 Bits</span><br><span class="line">   +0x2d5 Reserved         : Pos 6, 2 Bits</span><br><span class="line">   +0x2d6 Reserved6        : [2] UChar</span><br><span class="line">   +0x2d8 ActiveConsoleId  : Uint4B</span><br><span class="line">   +0x2dc DismountCount    : Uint4B</span><br><span class="line">   +0x2e0 ComPlusPackage   : Uint4B</span><br><span class="line">   +0x2e4 LastSystemRITEventTickCount : Uint4B</span><br><span class="line">   +0x2e8 NumberOfPhysicalPages : Uint4B</span><br><span class="line">   +0x2ec SafeBootMode     : UChar</span><br><span class="line">   +0x2ed VirtualizationFlags : UChar</span><br><span class="line">   +0x2ee Reserved12       : [2] UChar</span><br><span class="line">   +0x2f0 SharedDataFlags  : Uint4B</span><br><span class="line">   +0x2f0 DbgErrorPortPresent : Pos 0, 1 Bit</span><br><span class="line">   +0x2f0 DbgElevationEnabled : Pos 1, 1 Bit</span><br><span class="line">   +0x2f0 DbgVirtEnabled   : Pos 2, 1 Bit</span><br><span class="line">   +0x2f0 DbgInstallerDetectEnabled : Pos 3, 1 Bit</span><br><span class="line">   +0x2f0 DbgLkgEnabled    : Pos 4, 1 Bit</span><br><span class="line">   +0x2f0 DbgDynProcessorEnabled : Pos 5, 1 Bit</span><br><span class="line">   +0x2f0 DbgConsoleBrokerEnabled : Pos 6, 1 Bit</span><br><span class="line">   +0x2f0 DbgSecureBootEnabled : Pos 7, 1 Bit</span><br><span class="line">   +0x2f0 DbgMultiSessionSku : Pos 8, 1 Bit</span><br><span class="line">   +0x2f0 DbgMultiUsersInSessionSku : Pos 9, 1 Bit</span><br><span class="line">   +0x2f0 DbgStateSeparationEnabled : Pos 10, 1 Bit</span><br><span class="line">   +0x2f0 SpareBits        : Pos 11, 21 Bits</span><br><span class="line">   +0x2f4 DataFlagsPad     : [1] Uint4B</span><br><span class="line">   +0x2f8 TestRetInstruction : Uint8B</span><br><span class="line">   +0x300 QpcFrequency     : Int8B</span><br><span class="line">   +0x308 SystemCall       : Uint4B</span><br><span class="line">   +0x30c SystemCallPad0   : Uint4B</span><br><span class="line">   +0x310 SystemCallPad    : [2] Uint8B</span><br><span class="line">   +0x320 TickCount        : _KSYSTEM_TIME</span><br><span class="line">   +0x320 TickCountQuad    : Uint8B</span><br><span class="line">   +0x320 ReservedTickCountOverlay : [3] Uint4B</span><br><span class="line">   +0x32c TickCountPad     : [1] Uint4B</span><br><span class="line">   +0x330 Cookie           : Uint4B</span><br><span class="line">   +0x334 CookiePad        : [1] Uint4B</span><br><span class="line">   +0x338 ConsoleSessionForegroundProcessId : Int8B</span><br><span class="line">   +0x340 TimeUpdateLock   : Uint8B</span><br><span class="line">   +0x348 BaselineSystemTimeQpc : Uint8B</span><br><span class="line">   +0x350 BaselineInterruptTimeQpc : Uint8B</span><br><span class="line">   +0x358 QpcSystemTimeIncrement : Uint8B</span><br><span class="line">   +0x360 QpcInterruptTimeIncrement : Uint8B</span><br><span class="line">   +0x368 QpcSystemTimeIncrementShift : UChar</span><br><span class="line">   +0x369 QpcInterruptTimeIncrementShift : UChar</span><br><span class="line">   +0x36a UnparkedProcessorCount : Uint2B</span><br><span class="line">   +0x36c EnclaveFeatureMask : [4] Uint4B</span><br><span class="line">   +0x37c TelemetryCoverageRound : Uint4B</span><br><span class="line">   +0x380 UserModeGlobalLogger : [16] Uint2B</span><br><span class="line">   +0x3a0 ImageFileExecutionOptions : Uint4B</span><br><span class="line">   +0x3a4 LangGenerationCount : Uint4B</span><br><span class="line">   +0x3a8 Reserved4        : Uint8B</span><br><span class="line">   +0x3b0 InterruptTimeBias : Uint8B</span><br><span class="line">   +0x3b8 QpcBias          : Uint8B</span><br><span class="line">   +0x3c0 ActiveProcessorCount : Uint4B</span><br><span class="line">   +0x3c4 ActiveGroupCount : UChar</span><br><span class="line">   +0x3c5 Reserved9        : UChar</span><br><span class="line">   +0x3c6 QpcData          : Uint2B</span><br><span class="line">   +0x3c6 QpcBypassEnabled : UChar</span><br><span class="line">   +0x3c7 QpcShift         : UChar</span><br><span class="line">   +0x3c8 TimeZoneBiasEffectiveStart : _LARGE_INTEGER</span><br><span class="line">   +0x3d0 TimeZoneBiasEffectiveEnd : _LARGE_INTEGER</span><br><span class="line">   +0x3d8 XState           : _XSTATE_CONFIGURATION</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckSharedUserData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> pUserSharedData = (KUSER_SHARED_DATA *)<span class="number">0x7FFE0000</span>; <span class="comment">// The fixed user mode address of KUSER_SHARED_DATA</span></span><br><span class="line"></span><br><span class="line">	BOOLEAN KdDebuggerEnabled		= (pUserSharedData-&gt;KdDebuggerEnabled &amp; <span class="number">0x1</span>) == <span class="number">0x1</span>;</span><br><span class="line">	BOOLEAN KdDebuggerNotPresent	= (pUserSharedData-&gt;KdDebuggerEnabled &amp; <span class="number">0x2</span>) == <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (KdDebuggerEnabled || !KdDebuggerNotPresent)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/04/21/VMProtect%E5%88%86%E6%9E%90-IAT%E4%BF%AE%E5%A4%8D/" rel="prev" title="VMProtect分析-IAT修复">
                  <i class="fa fa-chevron-left"></i> VMProtect分析-IAT修复
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/04/21/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-%E9%80%86%E5%90%91%E9%A2%98%E7%AC%94%E8%AE%B0%7Bcsaw2013reversing2%7D/" rel="next" title="攻防世界-逆向题笔记{csaw2013reversing2}">
                  攻防世界-逆向题笔记{csaw2013reversing2} <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PlaneJun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
