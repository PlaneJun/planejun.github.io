<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="codeva-XHCX41TH3N">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.planejun.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1、EPROCESS进程结构，每个进程都有这样一个结构。EPROCESS中还有一个KPROCESS，其中EPROCESS被称为执行体,主要是给R3进行访问；KPROCESS才是真正的对象结构。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556">
<meta property="og:type" content="article">
<meta property="og:title" content="x86进程线程">
<meta property="og:url" content="https://blog.planejun.cn/2023/06/13/Window-Kernel/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/index.html">
<meta property="og:site_name" content="PlaneJun&#39;Blog">
<meta property="og:description" content="1、EPROCESS进程结构，每个进程都有这样一个结构。EPROCESS中还有一个KPROCESS，其中EPROCESS被称为执行体,主要是给R3进行访问；KPROCESS才是真正的对象结构。 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613124753624.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613160050089.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613125912245.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613130000778.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613130019847.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094127635.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094234272.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094549890.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094610181.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094642370.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615095932177.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615095952824.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615100143668.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613122919271.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011025900.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011102894.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011455243.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011631290.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011853388.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011901258.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613123642965.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614014234470.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613130813145.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613160832341.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613160745296.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114646701.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114706308.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114718633.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114935264.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115004134.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115014216.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115135812.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115229779.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115305076.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115612425.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120241008.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120410056.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120813868.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120850794.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120909664.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120949595.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121210212.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121501799.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121554962.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121614349.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121631225.png">
<meta property="og:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121711042.png">
<meta property="article:published_time" content="2023-06-13T04:23:00.000Z">
<meta property="article:modified_time" content="2024-04-21T12:21:41.745Z">
<meta property="article:author" content="PlaneJun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.planejun.cn/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613124753624.png">


<link rel="canonical" href="https://blog.planejun.cn/2023/06/13/Window-Kernel/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.planejun.cn/2023/06/13/Window-Kernel/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/","path":"2023/06/13/Window-Kernel/x86进程线程/","title":"x86进程线程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>x86进程线程 | PlaneJun'Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">PlaneJun'Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">我是从未来来的！现在学已经来不及了，放开玩吧！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section">归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section">分类</a></li><li class="menu-item menu-item-github"><a href="https://www.github.com/PlaneJun" rel="section" target="_blank">GitHub</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section">关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1%E3%80%81EPROCESS"><span class="nav-number">1.</span> <span class="nav-text">1、EPROCESS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-KPROCESS"><span class="nav-number">1.1.</span> <span class="nav-text">2.1 KPROCESS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2%E3%80%81ETHREAD"><span class="nav-number">2.</span> <span class="nav-text">2、ETHREAD</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-KTHREAD"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 KTHREAD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E7%BA%BF%E7%A8%8B%E4%BC%AA%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 线程伪装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%9D%80%E6%AD%BB%E8%BF%9B%E7%A8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 杀死进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-NtTerminateProcess%E9%80%86%E5%90%91"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 NtTerminateProcess逆向</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3%E3%80%81KPCR"><span class="nav-number">3.</span> <span class="nav-text">3、KPCR</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-KPRCB"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 KPRCB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E4%BB%A3%E7%A0%81%E8%8E%B7%E5%8F%96KiProcessorBlock"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 代码获取KiProcessorBlock</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4%E3%80%81OBJECT-HEADER"><span class="nav-number">4.</span> <span class="nav-text">4、OBJECT_HEADER</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5%E3%80%81Window%E6%9F%A5%E8%AF%A2%E5%B0%B1%E7%BB%AA%E7%BA%BF%E7%A8%8B%E5%87%BD%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text">5、Window查询就绪线程函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6%E3%80%81Windows%E4%BA%A4%E6%8D%A2%E7%BA%BF%E7%A8%8B%E5%87%BD%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text">6、Windows交换线程函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 主动切换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-KiSwapThread%E9%80%86%E5%90%91"><span class="nav-number">6.1.1.</span> <span class="nav-text">6.1.1 KiSwapThread逆向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-KiSearchForNewThread%E9%80%86%E5%90%91"><span class="nav-number">6.1.2.</span> <span class="nav-text">6.1.2 KiSearchForNewThread逆向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-3-SwapContext%E9%80%86%E5%90%91"><span class="nav-number">6.1.3.</span> <span class="nav-text">6.1.3 SwapContext逆向</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E8%A2%AB%E5%8A%A8%E5%88%87%E6%8D%A2"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 被动切换</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">PlaneJun</p>
  <div class="site-description" itemprop="description">This is PlaneJun‘s Blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.planejun.cn/2023/06/13/Window-Kernel/x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PlaneJun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PlaneJun'Blog">
      <meta itemprop="description" content="This is PlaneJun‘s Blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="x86进程线程 | PlaneJun'Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          x86进程线程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-13 12:23:00" itemprop="dateCreated datePublished" datetime="2023-06-13T12:23:00+08:00">2023-06-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-21 20:21:41" itemprop="dateModified" datetime="2024-04-21T20:21:41+08:00">2024-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Windows-Kernel/" itemprop="url" rel="index"><span itemprop="name">Windows-Kernel</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="1、EPROCESS"><a href="#1、EPROCESS" class="headerlink" title="1、EPROCESS"></a>1、EPROCESS</h1><p>进程结构，每个进程都有这样一个结构。EPROCESS中还有一个KPROCESS，其中EPROCESS被称为<code>执行体</code>,主要是给R3进行访问；KPROCESS才是真正的对象结构。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x2c0 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_EPROCESS</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPROCESS</span> Pcb;                                                   <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_PUSH_LOCK</span> ProcessLock;                                       <span class="comment">//0x98</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> CreateTime;                                        <span class="comment">//0xa0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> ExitTime;                                          <span class="comment">//0xa8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_RUNDOWN_REF</span> RundownProtect;                                  <span class="comment">//0xb0</span></span><br><span class="line">    VOID* UniqueProcessId;                                                  <span class="comment">//0xb4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ActiveProcessLinks;                                  <span class="comment">//0xb8</span></span><br><span class="line">    ULONG ProcessQuotaUsage[<span class="number">2</span>];                                             <span class="comment">//0xc0</span></span><br><span class="line">    ULONG ProcessQuotaPeak[<span class="number">2</span>];                                              <span class="comment">//0xc8</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG CommitCharge;                                            <span class="comment">//0xd0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EPROCESS_QUOTA_BLOCK</span>* QuotaBlock;                               <span class="comment">//0xd4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_PS_CPU_QUOTA_BLOCK</span>* CpuQuotaBlock;                              <span class="comment">//0xd8</span></span><br><span class="line">    ULONG PeakVirtualSize;                                                  <span class="comment">//0xdc</span></span><br><span class="line">    ULONG VirtualSize;                                                      <span class="comment">//0xe0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> SessionProcessLinks;                                 <span class="comment">//0xe4</span></span><br><span class="line">    VOID* DebugPort;                                                        <span class="comment">//0xec</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        VOID* ExceptionPortData;                                            <span class="comment">//0xf0</span></span><br><span class="line">        ULONG ExceptionPortValue;                                           <span class="comment">//0xf0</span></span><br><span class="line">        ULONG ExceptionPortState:<span class="number">3</span>;                                         <span class="comment">//0xf0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_HANDLE_TABLE</span>* ObjectTable;                                      <span class="comment">//0xf4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_FAST_REF</span> Token;                                              <span class="comment">//0xf8</span></span><br><span class="line">    ULONG WorkingSetPage;                                                   <span class="comment">//0xfc</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_PUSH_LOCK</span> AddressCreationLock;                               <span class="comment">//0x100</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_ETHREAD</span>* RotateInProgress;                                      <span class="comment">//0x104</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_ETHREAD</span>* ForkInProgress;                                        <span class="comment">//0x108</span></span><br><span class="line">    ULONG HardwareTrigger;                                                  <span class="comment">//0x10c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_MM_AVL_TABLE</span>* PhysicalVadRoot;                                  <span class="comment">//0x110</span></span><br><span class="line">    VOID* CloneRoot;                                                        <span class="comment">//0x114</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG NumberOfPrivatePages;                                    <span class="comment">//0x118</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG NumberOfLockedPages;                                     <span class="comment">//0x11c</span></span><br><span class="line">    VOID* Win32Process;                                                     <span class="comment">//0x120</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EJOB</span>* <span class="keyword">volatile</span> Job;                                             <span class="comment">//0x124</span></span><br><span class="line">    VOID* SectionObject;                                                    <span class="comment">//0x128</span></span><br><span class="line">    VOID* SectionBaseAddress;                                               <span class="comment">//0x12c</span></span><br><span class="line">    ULONG Cookie;                                                           <span class="comment">//0x130</span></span><br><span class="line">    ULONG Spare8;                                                           <span class="comment">//0x134</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_PAGEFAULT_HISTORY</span>* WorkingSetWatch;                             <span class="comment">//0x138</span></span><br><span class="line">    VOID* Win32WindowStation;                                               <span class="comment">//0x13c</span></span><br><span class="line">    VOID* InheritedFromUniqueProcessId;                                     <span class="comment">//0x140</span></span><br><span class="line">    VOID* LdtInformation;                                                   <span class="comment">//0x144</span></span><br><span class="line">    VOID* VdmObjects;                                                       <span class="comment">//0x148</span></span><br><span class="line">    ULONG ConsoleHostProcess;                                               <span class="comment">//0x14c</span></span><br><span class="line">    VOID* DeviceMap;                                                        <span class="comment">//0x150</span></span><br><span class="line">    VOID* EtwDataSource;                                                    <span class="comment">//0x154</span></span><br><span class="line">    VOID* FreeTebHint;                                                      <span class="comment">//0x158</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_HARDWARE_PTE</span> PageDirectoryPte;                              <span class="comment">//0x160</span></span><br><span class="line">        ULONGLONG Filler;                                                   <span class="comment">//0x160</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* Session;                                                          <span class="comment">//0x168</span></span><br><span class="line">    UCHAR ImageFileName[<span class="number">15</span>];                                                <span class="comment">//0x16c</span></span><br><span class="line">    UCHAR PriorityClass;                                                    <span class="comment">//0x17b</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> JobLinks;                                            <span class="comment">//0x17c</span></span><br><span class="line">    VOID* LockedPagesList;                                                  <span class="comment">//0x184</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ThreadListHead;                                      <span class="comment">//0x188</span></span><br><span class="line">    VOID* SecurityPort;                                                     <span class="comment">//0x190</span></span><br><span class="line">    VOID* PaeTop;                                                           <span class="comment">//0x194</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG ActiveThreads;                                           <span class="comment">//0x198</span></span><br><span class="line">    ULONG ImagePathHash;                                                    <span class="comment">//0x19c</span></span><br><span class="line">    ULONG DefaultHardErrorProcessing;                                       <span class="comment">//0x1a0</span></span><br><span class="line">    LONG LastThreadExitStatus;                                              <span class="comment">//0x1a4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_PEB</span>* Peb;                                                       <span class="comment">//0x1a8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_FAST_REF</span> PrefetchTrace;                                      <span class="comment">//0x1ac</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> ReadOperationCount;                                <span class="comment">//0x1b0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> WriteOperationCount;                               <span class="comment">//0x1b8</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> OtherOperationCount;                               <span class="comment">//0x1c0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> ReadTransferCount;                                 <span class="comment">//0x1c8</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> WriteTransferCount;                                <span class="comment">//0x1d0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> OtherTransferCount;                                <span class="comment">//0x1d8</span></span><br><span class="line">    ULONG CommitChargeLimit;                                                <span class="comment">//0x1e0</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG CommitChargePeak;                                        <span class="comment">//0x1e4</span></span><br><span class="line">    VOID* AweInfo;                                                          <span class="comment">//0x1e8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SE_AUDIT_PROCESS_CREATION_INFO</span> SeAuditProcessCreationInfo;      <span class="comment">//0x1ec</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_MMSUPPORT</span> Vm;                                                   <span class="comment">//0x1f0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> MmProcessLinks;                                      <span class="comment">//0x25c</span></span><br><span class="line">    VOID* HighestUserAddress;                                               <span class="comment">//0x264</span></span><br><span class="line">    ULONG ModifiedPageCount;                                                <span class="comment">//0x268</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG Flags2;                                                       <span class="comment">//0x26c</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            ULONG JobNotReallyActive:<span class="number">1</span>;                                     <span class="comment">//0x26c</span></span><br><span class="line">            ULONG AccountingFolded:<span class="number">1</span>;                                       <span class="comment">//0x26c</span></span><br><span class="line">            ULONG NewProcessReported:<span class="number">1</span>;                                     <span class="comment">//0x26c</span></span><br><span class="line">            ULONG ExitProcessReported:<span class="number">1</span>;                                    <span class="comment">//0x26c</span></span><br><span class="line">            ULONG ReportCommitChanges:<span class="number">1</span>;                                    <span class="comment">//0x26c</span></span><br><span class="line">            ULONG LastReportMemory:<span class="number">1</span>;                                       <span class="comment">//0x26c</span></span><br><span class="line">            ULONG ReportPhysicalPageChanges:<span class="number">1</span>;                              <span class="comment">//0x26c</span></span><br><span class="line">            ULONG HandleTableRundown:<span class="number">1</span>;                                     <span class="comment">//0x26c</span></span><br><span class="line">            ULONG NeedsHandleRundown:<span class="number">1</span>;                                     <span class="comment">//0x26c</span></span><br><span class="line">            ULONG RefTraceEnabled:<span class="number">1</span>;                                        <span class="comment">//0x26c</span></span><br><span class="line">            ULONG NumaAware:<span class="number">1</span>;                                              <span class="comment">//0x26c</span></span><br><span class="line">            ULONG ProtectedProcess:<span class="number">1</span>;                                       <span class="comment">//0x26c</span></span><br><span class="line">            ULONG DefaultPagePriority:<span class="number">3</span>;                                    <span class="comment">//0x26c</span></span><br><span class="line">            ULONG PrimaryTokenFrozen:<span class="number">1</span>;                                     <span class="comment">//0x26c</span></span><br><span class="line">            ULONG ProcessVerifierTarget:<span class="number">1</span>;                                  <span class="comment">//0x26c</span></span><br><span class="line">            ULONG StackRandomizationDisabled:<span class="number">1</span>;                             <span class="comment">//0x26c</span></span><br><span class="line">            ULONG AffinityPermanent:<span class="number">1</span>;                                      <span class="comment">//0x26c</span></span><br><span class="line">            ULONG AffinityUpdateEnable:<span class="number">1</span>;                                   <span class="comment">//0x26c</span></span><br><span class="line">            ULONG PropagateNode:<span class="number">1</span>;                                          <span class="comment">//0x26c</span></span><br><span class="line">            ULONG ExplicitAffinity:<span class="number">1</span>;                                       <span class="comment">//0x26c</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG Flags;                                                        <span class="comment">//0x270</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            ULONG CreateReported:<span class="number">1</span>;                                         <span class="comment">//0x270</span></span><br><span class="line">            ULONG NoDebugInherit:<span class="number">1</span>;                                         <span class="comment">//0x270</span></span><br><span class="line">            ULONG ProcessExiting:<span class="number">1</span>;                                         <span class="comment">//0x270</span></span><br><span class="line">            ULONG ProcessDelete:<span class="number">1</span>;                                          <span class="comment">//0x270</span></span><br><span class="line">            ULONG Wow64SplitPages:<span class="number">1</span>;                                        <span class="comment">//0x270</span></span><br><span class="line">            ULONG VmDeleted:<span class="number">1</span>;                                              <span class="comment">//0x270</span></span><br><span class="line">            ULONG OutswapEnabled:<span class="number">1</span>;                                         <span class="comment">//0x270</span></span><br><span class="line">            ULONG Outswapped:<span class="number">1</span>;                                             <span class="comment">//0x270</span></span><br><span class="line">            ULONG ForkFailed:<span class="number">1</span>;                                             <span class="comment">//0x270</span></span><br><span class="line">            ULONG Wow64VaSpace4Gb:<span class="number">1</span>;                                        <span class="comment">//0x270</span></span><br><span class="line">            ULONG AddressSpaceInitialized:<span class="number">2</span>;                                <span class="comment">//0x270</span></span><br><span class="line">            ULONG SetTimerResolution:<span class="number">1</span>;                                     <span class="comment">//0x270</span></span><br><span class="line">            ULONG BreakOnTermination:<span class="number">1</span>;                                     <span class="comment">//0x270</span></span><br><span class="line">            ULONG DeprioritizeViews:<span class="number">1</span>;                                      <span class="comment">//0x270</span></span><br><span class="line">            ULONG WriteWatch:<span class="number">1</span>;                                             <span class="comment">//0x270</span></span><br><span class="line">            ULONG ProcessInSession:<span class="number">1</span>;                                       <span class="comment">//0x270</span></span><br><span class="line">            ULONG OverrideAddressSpace:<span class="number">1</span>;                                   <span class="comment">//0x270</span></span><br><span class="line">            ULONG HasAddressSpace:<span class="number">1</span>;                                        <span class="comment">//0x270</span></span><br><span class="line">            ULONG LaunchPrefetched:<span class="number">1</span>;                                       <span class="comment">//0x270</span></span><br><span class="line">            ULONG InjectInpageErrors:<span class="number">1</span>;                                     <span class="comment">//0x270</span></span><br><span class="line">            ULONG VmTopDown:<span class="number">1</span>;                                              <span class="comment">//0x270</span></span><br><span class="line">            ULONG ImageNotifyDone:<span class="number">1</span>;                                        <span class="comment">//0x270</span></span><br><span class="line">            ULONG PdeUpdateNeeded:<span class="number">1</span>;                                        <span class="comment">//0x270</span></span><br><span class="line">            ULONG VdmAllowed:<span class="number">1</span>;                                             <span class="comment">//0x270</span></span><br><span class="line">            ULONG CrossSessionCreate:<span class="number">1</span>;                                     <span class="comment">//0x270</span></span><br><span class="line">            ULONG ProcessInserted:<span class="number">1</span>;                                        <span class="comment">//0x270</span></span><br><span class="line">            ULONG DefaultIoPriority:<span class="number">3</span>;                                      <span class="comment">//0x270</span></span><br><span class="line">            ULONG ProcessSelfDelete:<span class="number">1</span>;                                      <span class="comment">//0x270</span></span><br><span class="line">            ULONG SetTimerResolutionLink:<span class="number">1</span>;                                 <span class="comment">//0x270</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    LONG ExitStatus;                                                        <span class="comment">//0x274</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_MM_AVL_TABLE</span> VadRoot;                                           <span class="comment">//0x278</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_ALPC_PROCESS_CONTEXT</span> AlpcContext;                               <span class="comment">//0x298</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> TimerResolutionLink;                                 <span class="comment">//0x2a8</span></span><br><span class="line">    ULONG RequestedTimerResolution;                                         <span class="comment">//0x2b0</span></span><br><span class="line">    ULONG ActiveThreadsHighWatermark;                                       <span class="comment">//0x2b4</span></span><br><span class="line">    ULONG SmallestTimerResolution;                                          <span class="comment">//0x2b8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_PO_DIAG_STACK_RECORD</span>* TimerResolutionStackRecord;               <span class="comment">//0x2bc</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>Pcb：Kprocess结构体。内核成员，见下文。</p>
</li>
<li><p>ProcessLock：R3进程锁。修改EPROCESS结构存放锁结构，防止同时修改。改完了置0.</p>
</li>
<li><p>CreateTime：进程的创建时间。</p>
</li>
<li><p>ExitTime：进程的退出时间。</p>
</li>
<li><p>RundownProtect：进程锁。该字段置值后，进程无法被访问、打开、结束，相当于保护。但是会容易卡死。</p>
</li>
</ul>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613124753624.png" alt="image-20230613124753624"></p>
<ul>
<li><p>UniqueProcessId：进程ID。任务管理器中显示的进程ID就是这个。</p>
</li>
<li><p>ActiveProcessLinks：双向链表。包括了windows中所有活动的进程。全局变量“PsActiveProcessHead”指向了这个链表的头部。通过该全局变量可以遍历整条链表。<br><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613160050089.png" alt="image-20230613160050089"></p>
</li>
<li><p>ProcessQuotaUsage：进程物理页相关统计信息。</p>
</li>
<li><p>ProcessQuotaPeak：进程物理页相关统计信息。</p>
</li>
<li><p>CommitCharge：进程虚拟内存相关统计信息。</p>
</li>
<li><p>QuotaBlock：进程虚拟内存相关统计信息。</p>
</li>
<li><p>CpuQuotaBlock：进程虚拟内存相关统计信息。</p>
</li>
<li><p>SessionProcessLinks：会话进程链表。保存了当前登录的用户的所有进程。</p>
</li>
<li><p>DebugPort：调试相关。如果该进程处于调试状态，这里会有值（一个结构体），该结构体用于进程与调试器之间通信。通过循环清0可以达到反调试效果。</p>
</li>
<li><p>ExceptionPortData：调试相关。</p>
</li>
<li><p>ObjectTable：进程的句柄表。句柄相关章节再学。</p>
</li>
<li><p>Token：进程Token，外边的提权实际上就是拷贝这个位置的Token。<code>System/Administror</code></p>
</li>
<li><p>WorkingSetPage：表明当前进程用了多少个物理页。</p>
</li>
<li><p>ImageFileName：当前进程的进程名，但是只有15个字节，要获取完整的可以获取<code>SeAuditProcessCreationInfo</code>。</p>
</li>
<li><p>ThreadListHead：当前进程内所有线程的链表。</p>
</li>
<li><p>ActiveThreads：当前进程内活动的线程数量。</p>
</li>
<li><p>Peb。就是3环下该进程的PEB。（PEB结构此处不赘述了，网上有非常多的PEB结构说明。）</p>
</li>
<li><p>SeAuditProcessCreationInfo：当前进程完整路径。函数<code>SeLocateProcessImageName</code>就是获取的这个位置。</p>
</li>
<li><p>Flags2：一个联合体，每个位影响该进程的一些属性。</p>
<ul>
<li>ProtectedProcess：进程保护位。该位置1后该进程被保护。CE看不到图片，打不开了进程。OD附加进程列表遍历不到。一个最简单的进程保护。</li>
</ul>
</li>
</ul>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613125912245.png" alt="image-20230613125912245"></p>
<ul>
<li><p>+Flags：一个联合体，每个位影响该进程的一些属性。</p>
<ul>
<li><p>ProcessExiting：进程退出标志位。置1后表明该进程已退出，但实际还在运行。可以达到反调试的效果。同时进程无法使用任务管理器结束。</p>
</li>
<li><p>ProcessDelete：进程退出标志位。置1后表明该进程已退出，但实际还在运行。可以达到反调试的效果。同时进程无法使用任务管理器结束。<br><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613130000778.png" alt="image-20230613130000778"></p>
</li>
<li><p>BreakOnTermination：该位置1后，任务管理器结束进程时将提示“是否结束系统进程XXX”。结束后windbg将会断下。<br><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613130019847.png" alt="image-20230613130019847"></p>
</li>
<li><p>VmTopDown：该位置1时，VirtualAlloc一类的申请内存函数将会从大地址开始申请。</p>
</li>
<li><p>ProcessInserted：该位置0后，OD附加进程列表找不到该进程。任务管理器结束不掉该进程。CE打不开该进程，无图标。</p>
</li>
</ul>
</li>
<li><p>ExitStatus：进程退出状态码。进程创建时默认值是250（0x103）。如果不是这个值基本上就是进程退出了。</p>
</li>
<li><p>VadRoot：标识当前进程用户空间（低2G）中哪些地址没被分配。该成员指向了一个二叉树。</p>
</li>
</ul>
<h2 id="2-1-KPROCESS"><a href="#2-1-KPROCESS" class="headerlink" title="2.1 KPROCESS"></a>2.1 KPROCESS</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x98 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KPROCESS</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_DISPATCHER_HEADER</span> Header;                                       <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ProfileListHead;                                     <span class="comment">//0x10</span></span><br><span class="line">    ULONG DirectoryTableBase;                                               <span class="comment">//0x18</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KGDTENTRY</span> LdtDescriptor;                                        <span class="comment">//0x1c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KIDTENTRY</span> Int21Descriptor;                                      <span class="comment">//0x24</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ThreadListHead;                                      <span class="comment">//0x2c</span></span><br><span class="line">    ULONG ProcessLock;                                                      <span class="comment">//0x34</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KAFFINITY_EX</span> Affinity;                                          <span class="comment">//0x38</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ReadyListHead;                                       <span class="comment">//0x44</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SINGLE_LIST_ENTRY</span> SwapListEntry;                                <span class="comment">//0x4c</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">struct</span> <span class="title class_">_KAFFINITY_EX</span> ActiveProcessors;                         <span class="comment">//0x50</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">volatile</span> LONG AutoAlignment:<span class="number">1</span>;                                  <span class="comment">//0x5c</span></span><br><span class="line">            <span class="keyword">volatile</span> LONG DisableBoost:<span class="number">1</span>;                                   <span class="comment">//0x5c</span></span><br><span class="line">            <span class="keyword">volatile</span> LONG DisableQuantum:<span class="number">1</span>;                                 <span class="comment">//0x5c</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG ActiveGroupsMask:<span class="number">1</span>;                              <span class="comment">//0x5c</span></span><br><span class="line">            <span class="keyword">volatile</span> LONG ReservedFlags:<span class="number">28</span>;                                 <span class="comment">//0x5c</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">volatile</span> LONG ProcessFlags;                                         <span class="comment">//0x5c</span></span><br><span class="line">    &#125;;</span><br><span class="line">    CHAR BasePriority;                                                      <span class="comment">//0x60</span></span><br><span class="line">    CHAR QuantumReset;                                                      <span class="comment">//0x61</span></span><br><span class="line">    UCHAR Visited;                                                          <span class="comment">//0x62</span></span><br><span class="line">    UCHAR Unused3;                                                          <span class="comment">//0x63</span></span><br><span class="line">    ULONG ThreadSeed[<span class="number">1</span>];                                                    <span class="comment">//0x64</span></span><br><span class="line">    USHORT IdealNode[<span class="number">1</span>];                                                    <span class="comment">//0x68</span></span><br><span class="line">    USHORT IdealGlobalNode;                                                 <span class="comment">//0x6a</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_KEXECUTE_OPTIONS</span> Flags;                                          <span class="comment">//0x6c</span></span><br><span class="line">    UCHAR Unused1;                                                          <span class="comment">//0x6d</span></span><br><span class="line">    USHORT IopmOffset;                                                      <span class="comment">//0x6e</span></span><br><span class="line">    ULONG Unused4;                                                          <span class="comment">//0x70</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_KSTACK_COUNT</span> StackCount;                                         <span class="comment">//0x74</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ProcessListEntry;                                    <span class="comment">//0x78</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONGLONG CycleTime;                                           <span class="comment">//0x80</span></span><br><span class="line">    ULONG KernelTime;                                                       <span class="comment">//0x88</span></span><br><span class="line">    ULONG UserTime;                                                         <span class="comment">//0x8c</span></span><br><span class="line">    VOID* VdmTrapcHandler;                                                  <span class="comment">//0x90</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>Header：可等待对象头部。所有0环结构体只要以_DISPATCHER_HEADER结构开头的，都可以使用WaitForSingleObject等待。如互斥体、事件。</p>
</li>
<li><p>ProfileListHead：性能分析相关，任务管理器，性能栏那些数据。</p>
</li>
<li><p>DirectoryTableBase：页目录表基址。物理地址，指向页目录表，CR3中的值就从这里获取。</p>
</li>
<li><p>LdtDescriptor：进程LDT描述符。</p>
</li>
<li><p>Int21Descriptor：为了兼容DOS下可通过Int21调用系统功能。</p>
</li>
<li><p>ThreadListHead：当前进程的所有线程结构体链表。这个位置- KTHREAD-&gt;ThreadListHead &#x3D;&#x3D; KTHREAD</p>
</li>
<li><p>ProcessLock：进程锁，作用和EPROCESS中的一样，但这个是RO用的。</p>
</li>
<li><p>Affinity：亲核性。规定了当前进程内的所有线程可以在哪些CPU上跑，4字节，共32位，每一位对应一个CPU核。如000000A1，转换为二进制为1010 0001，则该进程中的线程只能在0、5、7号CPU上运行。因此32位系统最多支持32核CPU，64位系统支持64核CPU。该值仅为线程结构中的亲核性做初始化赋值使用，没有实际的限制功能。</p>
<p>如果只有1个CPU，但此处值为2（0010），则该进程为一个“死”了的进程。</p>
</li>
<li><p>ReadyListHead：当前进程内的就绪线程链表，保存的值指向了<code>ETHREAD-&gt;WaitListEntry</code>地址。当进程被换出内存以后，所属的线程一旦就绪就会加入到这个链表中，然后换入进程，并将就绪线程链表全部加入全局的就绪线程链表。</p>
</li>
<li><p>SwapListEntry：当进程被换出内存时会通过这个位置将进程加入到<code>KiProcessOutSwapListHead</code>，换入时加入到<code>KiProcessInSwapListHead</code>。</p>
</li>
<li><p>ActiveProcessors：当前进程内正在运行的线程运行在哪些CPU上。</p>
</li>
<li><p>AutoAlignment：强制内存对齐。一般为0。</p>
</li>
<li><p>DisableBoost：置1为关闭当前进程内所有线程的时间碎片。（置1后，不会由于时间中断触发线程切换）</p>
</li>
<li><p>BasePriority：基础优先级。该进程内所有线程最初的优先级。</p>
</li>
<li><p>QuantumReset：当前进程内线程的初始时间碎片。每一次时钟中断会将线程中的时间碎片减6，为0时，切换线程。线程从就绪变为运行时，会从这个值中取到初始的时间碎片。改大这个值会让该进程内的线程跑的更久。</p>
</li>
<li><p>ProcessListEntry：系统内所有进程的链表。win7及以上此处为空，已弃用。</p>
</li>
<li><p>Flags：进程NX位的局部开关。结构为_KEXECUTE_OPTIONS的联合体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x1 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> _<span class="title">KEXECUTE_OPTIONS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UCHAR ExecuteDisable:<span class="number">1</span>;                                                 <span class="comment">//0x0</span></span><br><span class="line">    UCHAR ExecuteEnable:<span class="number">1</span>;                                                  <span class="comment">//0x0</span></span><br><span class="line">    UCHAR DisableThunkEmulation:<span class="number">1</span>;                                          <span class="comment">//0x0</span></span><br><span class="line">    UCHAR Permanent:<span class="number">1</span>;                                                      <span class="comment">//0x0</span></span><br><span class="line">    UCHAR ExecuteDispatchEnable:<span class="number">1</span>;                                          <span class="comment">//0x0</span></span><br><span class="line">    UCHAR ImageDispatchEnable:<span class="number">1</span>;                                            <span class="comment">//0x0</span></span><br><span class="line">    UCHAR DisableExceptionChainValidation:<span class="number">1</span>;                                <span class="comment">//0x0</span></span><br><span class="line">    UCHAR Spare:<span class="number">1</span>;                                                          <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR ExecuteOptions;                                          <span class="comment">//0x0</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li>ExecuteOptions：写1，数据段可以当做代码执行。写0数据段不能当做代码执行。<code>某些检测弱的游戏可以通过对这个置1，然后申请一段可读可写内存作为shellcode执行</code>。</li>
</ul>
</li>
<li><p>CycleTime：当前进程执行了多少个指令周期。当进程结束时才会被赋值，指明了该进程存活了多久。</p>
</li>
<li><p>KernelTime：（统计信息）当前进程在0环的运行时间。<code>当进程结束时才会被赋值，指明了该进程存活了多久。</code></p>
</li>
<li><p>UserTime：（统计信息）当前进程在3环的运行时间。<code>当进程结束时才会被赋值，指明了该进程存活了多久。</code></p>
</li>
<li><p>VdmTrapcHandler：虚拟8086模式时使用。</p>
</li>
</ul>
<h1 id="2、ETHREAD"><a href="#2、ETHREAD" class="headerlink" title="2、ETHREAD"></a>2、ETHREAD</h1><p>与EPROCESS类似，主要用来描述线程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x2b8 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_ETHREAD</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTHREAD</span> Tcb;                                                    <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> CreateTime;                                        <span class="comment">//0x200</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> ExitTime;                                      <span class="comment">//0x208</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> KeyedWaitChain;                                  <span class="comment">//0x208</span></span><br><span class="line">    &#125;;</span><br><span class="line">    LONG ExitStatus;                                                        <span class="comment">//0x210</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> PostBlockList;                                   <span class="comment">//0x214</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            VOID* ForwardLinkShadow;                                        <span class="comment">//0x214</span></span><br><span class="line">            VOID* StartAddress;                                             <span class="comment">//0x218</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_TERMINATION_PORT</span>* TerminationPort;                          <span class="comment">//0x21c</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_ETHREAD</span>* ReaperLink;                                        <span class="comment">//0x21c</span></span><br><span class="line">        VOID* KeyedWaitValue;                                               <span class="comment">//0x21c</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG ActiveTimerListLock;                                              <span class="comment">//0x220</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ActiveTimerListHead;                                 <span class="comment">//0x224</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_CLIENT_ID</span> Cid;                                                  <span class="comment">//0x22c</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KSEMAPHORE</span> KeyedWaitSemaphore;                              <span class="comment">//0x234</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KSEMAPHORE</span> AlpcWaitSemaphore;                               <span class="comment">//0x234</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_PS_CLIENT_SECURITY_CONTEXT</span> ClientSecurity;                       <span class="comment">//0x248</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> IrpList;                                             <span class="comment">//0x24c</span></span><br><span class="line">    ULONG TopLevelIrp;                                                      <span class="comment">//0x254</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_DEVICE_OBJECT</span>* DeviceToVerify;                                  <span class="comment">//0x258</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_PSP_CPU_QUOTA_APC</span>* CpuQuotaApc;                                  <span class="comment">//0x25c</span></span><br><span class="line">    VOID* Win32StartAddress;                                                <span class="comment">//0x260</span></span><br><span class="line">    VOID* LegacyPowerObject;                                                <span class="comment">//0x264</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ThreadListEntry;                                     <span class="comment">//0x268</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_RUNDOWN_REF</span> RundownProtect;                                  <span class="comment">//0x270</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_PUSH_LOCK</span> ThreadLock;                                        <span class="comment">//0x274</span></span><br><span class="line">    ULONG ReadClusterSize;                                                  <span class="comment">//0x278</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmLockOrdering;                                           <span class="comment">//0x27c</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG CrossThreadFlags;                                             <span class="comment">//0x280</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            ULONG Terminated:<span class="number">1</span>;                                             <span class="comment">//0x280</span></span><br><span class="line">            ULONG ThreadInserted:<span class="number">1</span>;                                         <span class="comment">//0x280</span></span><br><span class="line">            ULONG HideFromDebugger:<span class="number">1</span>;                                       <span class="comment">//0x280</span></span><br><span class="line">            ULONG ActiveImpersonationInfo:<span class="number">1</span>;                                <span class="comment">//0x280</span></span><br><span class="line">            ULONG Reserved:<span class="number">1</span>;                                               <span class="comment">//0x280</span></span><br><span class="line">            ULONG HardErrorsAreDisabled:<span class="number">1</span>;                                  <span class="comment">//0x280</span></span><br><span class="line">            ULONG BreakOnTermination:<span class="number">1</span>;                                     <span class="comment">//0x280</span></span><br><span class="line">            ULONG SkipCreationMsg:<span class="number">1</span>;                                        <span class="comment">//0x280</span></span><br><span class="line">            ULONG SkipTerminationMsg:<span class="number">1</span>;                                     <span class="comment">//0x280</span></span><br><span class="line">            ULONG CopyTokenOnOpen:<span class="number">1</span>;                                        <span class="comment">//0x280</span></span><br><span class="line">            ULONG ThreadIoPriority:<span class="number">3</span>;                                       <span class="comment">//0x280</span></span><br><span class="line">            ULONG ThreadPagePriority:<span class="number">3</span>;                                     <span class="comment">//0x280</span></span><br><span class="line">            ULONG RundownFail:<span class="number">1</span>;                                            <span class="comment">//0x280</span></span><br><span class="line">            ULONG NeedsWorkingSetAging:<span class="number">1</span>;                                   <span class="comment">//0x280</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG SameThreadPassiveFlags;                                       <span class="comment">//0x284</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            ULONG ActiveExWorker:<span class="number">1</span>;                                         <span class="comment">//0x284</span></span><br><span class="line">            ULONG ExWorkerCanWaitUser:<span class="number">1</span>;                                    <span class="comment">//0x284</span></span><br><span class="line">            ULONG MemoryMaker:<span class="number">1</span>;                                            <span class="comment">//0x284</span></span><br><span class="line">            ULONG ClonedThread:<span class="number">1</span>;                                           <span class="comment">//0x284</span></span><br><span class="line">            ULONG KeyedEventInUse:<span class="number">1</span>;                                        <span class="comment">//0x284</span></span><br><span class="line">            ULONG RateApcState:<span class="number">2</span>;                                           <span class="comment">//0x284</span></span><br><span class="line">            ULONG SelfTerminate:<span class="number">1</span>;                                          <span class="comment">//0x284</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        ULONG SameThreadApcFlags;                                           <span class="comment">//0x288</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR Spare:<span class="number">1</span>;                                                  <span class="comment">//0x288</span></span><br><span class="line">            <span class="keyword">volatile</span> UCHAR StartAddressInvalid:<span class="number">1</span>;                           <span class="comment">//0x288</span></span><br><span class="line">            UCHAR EtwPageFaultCalloutActive:<span class="number">1</span>;                              <span class="comment">//0x288</span></span><br><span class="line">            UCHAR OwnsProcessWorkingSetExclusive:<span class="number">1</span>;                         <span class="comment">//0x288</span></span><br><span class="line">            UCHAR OwnsProcessWorkingSetShared:<span class="number">1</span>;                            <span class="comment">//0x288</span></span><br><span class="line">            UCHAR OwnsSystemCacheWorkingSetExclusive:<span class="number">1</span>;                     <span class="comment">//0x288</span></span><br><span class="line">            UCHAR OwnsSystemCacheWorkingSetShared:<span class="number">1</span>;                        <span class="comment">//0x288</span></span><br><span class="line">            UCHAR OwnsSessionWorkingSetExclusive:<span class="number">1</span>;                         <span class="comment">//0x288</span></span><br><span class="line">            UCHAR OwnsSessionWorkingSetShared:<span class="number">1</span>;                            <span class="comment">//0x289</span></span><br><span class="line">            UCHAR OwnsProcessAddressSpaceExclusive:<span class="number">1</span>;                       <span class="comment">//0x289</span></span><br><span class="line">            UCHAR OwnsProcessAddressSpaceShared:<span class="number">1</span>;                          <span class="comment">//0x289</span></span><br><span class="line">            UCHAR SuppressSymbolLoad:<span class="number">1</span>;                                     <span class="comment">//0x289</span></span><br><span class="line">            UCHAR Prefetching:<span class="number">1</span>;                                            <span class="comment">//0x289</span></span><br><span class="line">            UCHAR OwnsDynamicMemoryShared:<span class="number">1</span>;                                <span class="comment">//0x289</span></span><br><span class="line">            UCHAR OwnsChangeControlAreaExclusive:<span class="number">1</span>;                         <span class="comment">//0x289</span></span><br><span class="line">            UCHAR OwnsChangeControlAreaShared:<span class="number">1</span>;                            <span class="comment">//0x289</span></span><br><span class="line">            UCHAR OwnsPagedPoolWorkingSetExclusive:<span class="number">1</span>;                       <span class="comment">//0x28a</span></span><br><span class="line">            UCHAR OwnsPagedPoolWorkingSetShared:<span class="number">1</span>;                          <span class="comment">//0x28a</span></span><br><span class="line">            UCHAR OwnsSystemPtesWorkingSetExclusive:<span class="number">1</span>;                      <span class="comment">//0x28a</span></span><br><span class="line">            UCHAR OwnsSystemPtesWorkingSetShared:<span class="number">1</span>;                         <span class="comment">//0x28a</span></span><br><span class="line">            UCHAR TrimTrigger:<span class="number">2</span>;                                            <span class="comment">//0x28a</span></span><br><span class="line">            UCHAR Spare1:<span class="number">2</span>;                                                 <span class="comment">//0x28a</span></span><br><span class="line">            UCHAR PriorityRegionActive;                                     <span class="comment">//0x28b</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    UCHAR CacheManagerActive;                                               <span class="comment">//0x28c</span></span><br><span class="line">    UCHAR DisablePageFaultClustering;                                       <span class="comment">//0x28d</span></span><br><span class="line">    UCHAR ActiveFaultCount;                                                 <span class="comment">//0x28e</span></span><br><span class="line">    UCHAR LockOrderState;                                                   <span class="comment">//0x28f</span></span><br><span class="line">    ULONG AlpcMessageId;                                                    <span class="comment">//0x290</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        VOID* AlpcMessage;                                                  <span class="comment">//0x294</span></span><br><span class="line">        ULONG AlpcReceiveAttributeSet;                                      <span class="comment">//0x294</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> AlpcWaitListEntry;                                   <span class="comment">//0x298</span></span><br><span class="line">    ULONG CacheManagerCount;                                                <span class="comment">//0x2a0</span></span><br><span class="line">    ULONG IoBoostCount;                                                     <span class="comment">//0x2a4</span></span><br><span class="line">    ULONG IrpListLock;                                                      <span class="comment">//0x2a8</span></span><br><span class="line">    VOID* ReservedForSynchTracking;                                         <span class="comment">//0x2ac</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SINGLE_LIST_ENTRY</span> CmCallbackListHead;                           <span class="comment">//0x2b0</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li>Tcb：KTHREAD成员，见下文。</li>
<li>StartAddress：线程函数起始地址。</li>
<li>Cid：当前线程的线程ID。为_CLIENT_ID结构，包含了线程ID和所属的进程ID。</li>
<li>Win32StartAddress：GUI线程函数起始地址。如果一个线程属于GUI线程则这个位置为真实的线程起始地址，否则为null。</li>
<li>ThreadListEntry：当前进程内所有线程的双向链表。</li>
<li>RundownProtect：与EPROCESS效果一致。</li>
<li>ThreadLock：与EPROCESS效果一致。</li>
</ul>
<h2 id="2-1-KTHREAD"><a href="#2-1-KTHREAD" class="headerlink" title="2.1 KTHREAD"></a>2.1 KTHREAD</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x200 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KTHREAD</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_DISPATCHER_HEADER</span> Header;                                       <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONGLONG CycleTime;                                           <span class="comment">//0x10</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG HighCycleTime;                                           <span class="comment">//0x18</span></span><br><span class="line">    ULONGLONG QuantumTarget;                                                <span class="comment">//0x20</span></span><br><span class="line">    VOID* InitialStack;                                                     <span class="comment">//0x28</span></span><br><span class="line">    VOID* <span class="keyword">volatile</span> StackLimit;                                              <span class="comment">//0x2c</span></span><br><span class="line">    VOID* KernelStack;                                                      <span class="comment">//0x30</span></span><br><span class="line">    ULONG ThreadLock;                                                       <span class="comment">//0x34</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_KWAIT_STATUS_REGISTER</span> WaitRegister;                              <span class="comment">//0x38</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR Running;                                                 <span class="comment">//0x39</span></span><br><span class="line">    UCHAR Alerted[<span class="number">2</span>];                                                       <span class="comment">//0x3a</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            ULONG KernelStackResident:<span class="number">1</span>;                                    <span class="comment">//0x3c</span></span><br><span class="line">            ULONG ReadyTransition:<span class="number">1</span>;                                        <span class="comment">//0x3c</span></span><br><span class="line">            ULONG ProcessReadyQueue:<span class="number">1</span>;                                      <span class="comment">//0x3c</span></span><br><span class="line">            ULONG WaitNext:<span class="number">1</span>;                                               <span class="comment">//0x3c</span></span><br><span class="line">            ULONG SystemAffinityActive:<span class="number">1</span>;                                   <span class="comment">//0x3c</span></span><br><span class="line">            ULONG Alertable:<span class="number">1</span>;                                              <span class="comment">//0x3c</span></span><br><span class="line">            ULONG GdiFlushActive:<span class="number">1</span>;                                         <span class="comment">//0x3c</span></span><br><span class="line">            ULONG UserStackWalkActive:<span class="number">1</span>;                                    <span class="comment">//0x3c</span></span><br><span class="line">            ULONG ApcInterruptRequest:<span class="number">1</span>;                                    <span class="comment">//0x3c</span></span><br><span class="line">            ULONG ForceDeferSchedule:<span class="number">1</span>;                                     <span class="comment">//0x3c</span></span><br><span class="line">            ULONG QuantumEndMigrate:<span class="number">1</span>;                                      <span class="comment">//0x3c</span></span><br><span class="line">            ULONG UmsDirectedSwitchEnable:<span class="number">1</span>;                                <span class="comment">//0x3c</span></span><br><span class="line">            ULONG TimerActive:<span class="number">1</span>;                                            <span class="comment">//0x3c</span></span><br><span class="line">            ULONG SystemThread:<span class="number">1</span>;                                           <span class="comment">//0x3c</span></span><br><span class="line">            ULONG Reserved:<span class="number">18</span>;                                              <span class="comment">//0x3c</span></span><br><span class="line">        &#125;;</span><br><span class="line">        LONG MiscFlags;                                                     <span class="comment">//0x3c</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KAPC_STATE</span> ApcState;                                        <span class="comment">//0x40</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR ApcStateFill[<span class="number">23</span>];                                         <span class="comment">//0x40</span></span><br><span class="line">            CHAR Priority;                                                  <span class="comment">//0x57</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">volatile</span> ULONG NextProcessor;                                           <span class="comment">//0x58</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG DeferredProcessor;                                       <span class="comment">//0x5c</span></span><br><span class="line">    ULONG ApcQueueLock;                                                     <span class="comment">//0x60</span></span><br><span class="line">    ULONG ContextSwitches;                                                  <span class="comment">//0x64</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR State;                                                   <span class="comment">//0x68</span></span><br><span class="line">    CHAR NpxState;                                                          <span class="comment">//0x69</span></span><br><span class="line">    UCHAR WaitIrql;                                                         <span class="comment">//0x6a</span></span><br><span class="line">    CHAR WaitMode;                                                          <span class="comment">//0x6b</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG WaitStatus;                                               <span class="comment">//0x6c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KWAIT_BLOCK</span>* WaitBlockList;                                     <span class="comment">//0x70</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> WaitListEntry;                                   <span class="comment">//0x74</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_SINGLE_LIST_ENTRY</span> SwapListEntry;                            <span class="comment">//0x74</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KQUEUE</span>* <span class="keyword">volatile</span> Queue;                                         <span class="comment">//0x7c</span></span><br><span class="line">    ULONG WaitTime;                                                         <span class="comment">//0x80</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            SHORT KernelApcDisable;                                         <span class="comment">//0x84</span></span><br><span class="line">            SHORT SpecialApcDisable;                                        <span class="comment">//0x86</span></span><br><span class="line">        &#125;;</span><br><span class="line">        ULONG CombinedApcDisable;                                           <span class="comment">//0x84</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* Teb;                                                              <span class="comment">//0x88</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTIMER</span> Timer;                                                   <span class="comment">//0x90</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">volatile</span> ULONG AutoAlignment:<span class="number">1</span>;                                 <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG DisableBoost:<span class="number">1</span>;                                  <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG EtwStackTraceApc1Inserted:<span class="number">1</span>;                     <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG EtwStackTraceApc2Inserted:<span class="number">1</span>;                     <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG CalloutActive:<span class="number">1</span>;                                 <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG ApcQueueable:<span class="number">1</span>;                                  <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG EnableStackSwap:<span class="number">1</span>;                               <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG GuiThread:<span class="number">1</span>;                                     <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG UmsPerformingSyscall:<span class="number">1</span>;                          <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG VdmSafe:<span class="number">1</span>;                                       <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG UmsDispatched:<span class="number">1</span>;                                 <span class="comment">//0xb8</span></span><br><span class="line">            <span class="keyword">volatile</span> ULONG ReservedFlags:<span class="number">21</span>;                                <span class="comment">//0xb8</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">volatile</span> LONG ThreadFlags;                                          <span class="comment">//0xb8</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* ServiceTable;                                                     <span class="comment">//0xbc</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KWAIT_BLOCK</span> WaitBlock[<span class="number">4</span>];                                       <span class="comment">//0xc0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> QueueListEntry;                                      <span class="comment">//0x120</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTRAP_FRAME</span>* TrapFrame;                                         <span class="comment">//0x128</span></span><br><span class="line">    VOID* FirstArgument;                                                    <span class="comment">//0x12c</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        VOID* CallbackStack;                                                <span class="comment">//0x130</span></span><br><span class="line">        ULONG CallbackDepth;                                                <span class="comment">//0x130</span></span><br><span class="line">    &#125;;</span><br><span class="line">    UCHAR ApcStateIndex;                                                    <span class="comment">//0x134</span></span><br><span class="line">    CHAR BasePriority;                                                      <span class="comment">//0x135</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        CHAR PriorityDecrement;                                             <span class="comment">//0x136</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR ForegroundBoost:<span class="number">4</span>;                                        <span class="comment">//0x136</span></span><br><span class="line">            UCHAR UnusualBoost:<span class="number">4</span>;                                           <span class="comment">//0x136</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    UCHAR Preempted;                                                        <span class="comment">//0x137</span></span><br><span class="line">    UCHAR AdjustReason;                                                     <span class="comment">//0x138</span></span><br><span class="line">    CHAR AdjustIncrement;                                                   <span class="comment">//0x139</span></span><br><span class="line">    CHAR PreviousMode;                                                      <span class="comment">//0x13a</span></span><br><span class="line">    CHAR Saturation;                                                        <span class="comment">//0x13b</span></span><br><span class="line">    ULONG SystemCallNumber;                                                 <span class="comment">//0x13c</span></span><br><span class="line">    ULONG FreezeCount;                                                      <span class="comment">//0x140</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">struct</span> <span class="title class_">_GROUP_AFFINITY</span> UserAffinity;                           <span class="comment">//0x144</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPROCESS</span>* Process;                                              <span class="comment">//0x150</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">struct</span> <span class="title class_">_GROUP_AFFINITY</span> Affinity;                               <span class="comment">//0x154</span></span><br><span class="line">    ULONG IdealProcessor;                                                   <span class="comment">//0x160</span></span><br><span class="line">    ULONG UserIdealProcessor;                                               <span class="comment">//0x164</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KAPC_STATE</span>* ApcStatePointer[<span class="number">2</span>];                                 <span class="comment">//0x168</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KAPC_STATE</span> SavedApcState;                                   <span class="comment">//0x170</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SavedApcStateFill[<span class="number">23</span>];                                    <span class="comment">//0x170</span></span><br><span class="line">            UCHAR WaitReason;                                               <span class="comment">//0x187</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    CHAR SuspendCount;                                                      <span class="comment">//0x188</span></span><br><span class="line">    CHAR Spare1;                                                            <span class="comment">//0x189</span></span><br><span class="line">    UCHAR OtherPlatformFill;                                                <span class="comment">//0x18a</span></span><br><span class="line">    VOID* <span class="keyword">volatile</span> Win32Thread;                                             <span class="comment">//0x18c</span></span><br><span class="line">    VOID* StackBase;                                                        <span class="comment">//0x190</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KAPC</span> SuspendApc;                                            <span class="comment">//0x194</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SuspendApcFill0[<span class="number">1</span>];                                       <span class="comment">//0x194</span></span><br><span class="line">            UCHAR ResourceIndex;                                            <span class="comment">//0x195</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SuspendApcFill1[<span class="number">3</span>];                                       <span class="comment">//0x194</span></span><br><span class="line">            UCHAR QuantumReset;                                             <span class="comment">//0x197</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SuspendApcFill2[<span class="number">4</span>];                                       <span class="comment">//0x194</span></span><br><span class="line">            ULONG KernelTime;                                               <span class="comment">//0x198</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SuspendApcFill3[<span class="number">36</span>];                                      <span class="comment">//0x194</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">_KPRCB</span>* <span class="keyword">volatile</span> WaitPrcb;                               <span class="comment">//0x1b8</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SuspendApcFill4[<span class="number">40</span>];                                      <span class="comment">//0x194</span></span><br><span class="line">            VOID* LegoData;                                                 <span class="comment">//0x1bc</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR SuspendApcFill5[<span class="number">47</span>];                                      <span class="comment">//0x194</span></span><br><span class="line">            UCHAR LargeStack;                                               <span class="comment">//0x1c3</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG UserTime;                                                         <span class="comment">//0x1c4</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_KSEMAPHORE</span> SuspendSemaphore;                                <span class="comment">//0x1c8</span></span><br><span class="line">        UCHAR SuspendSemaphorefill[<span class="number">20</span>];                                     <span class="comment">//0x1c8</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG SListFaultCount;                                                  <span class="comment">//0x1dc</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> ThreadListEntry;                                     <span class="comment">//0x1e0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> MutantListHead;                                      <span class="comment">//0x1e8</span></span><br><span class="line">    VOID* SListFaultAddress;                                                <span class="comment">//0x1f0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTHREAD_COUNTERS</span>* ThreadCounters;                               <span class="comment">//0x1f4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_XSTATE_SAVE</span>* XStateSave;                                        <span class="comment">//0x1f8</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li>Header：可等待对象头部。</li>
<li>InitialStack：线程切换相关。当前线程的栈底。栈底-29C是TrapFrame结构首地址。</li>
<li>StackLimit：线程切换相关。当前线程的最大栈顶。ESP不能小于这个值。</li>
<li>KernelStack：线程切换相关。线程切换时，存储当前线程切换时的ESP，被切换回来时，从这里恢复ESP。</li>
<li>ThreadLock：跟上边的一致</li>
<li>Running：线程状态，正在运行中为1，否则为0。</li>
<li>Alerted：可警惕性。APC相关，后续APC章节学习。</li>
<li>MiscFlags：<ul>
<li>KernelStackResident：堆栈可扩展位。为1时，线程内核堆栈可以被扩大。0时无法扩大。</li>
<li>SystemThread：为1时，该线程为内核线程，否则为用户线程。</li>
</ul>
</li>
<li>ApcState：APC相关，后续APC章节学习。</li>
<li>Priority：当前线程的优先级。如存储11，则优先级为11，当前线程存储在第11个就绪链表中。<code>优先级数字越大，优先级越低</code>。默认线程优先级为8，存储在第8个就绪链表中。</li>
<li>NextProcessor：线程下次运行在哪个核上，如果为0，则随机。</li>
<li>ApcQueueLock：APC相关，后续APC章节学习。</li>
<li>ContextSwitches：当前线程切换了多少次。</li>
<li>State：线程状态。就绪、等待、运行等。</li>
<li>Teb：3环的TEB。</li>
<li>EnableStackSwap：内核栈是否可以换出内存。</li>
<li>ServiceTable：系统服务表地址，系统调用章节已学过。</li>
<li>WaitBlock：当前线程正在等待的对象，由KPROCESS-&gt;ReadyThreadList指向。</li>
<li>TrapFrame：TrapFrame结构，进0环时保存3环寄存器的值，系统调用章节已学过。</li>
<li>BasePriority：线程基础优先级。这个值就是所属进程的BasePriority值。</li>
<li>PreviousMode：先前模式。一些内核函数会判断这个值。</li>
<li>FreezeCount：被挂起的次数。如果一直为0则无法被恢复。</li>
<li>Process：该线程的父进程（创建该线程的进程）。</li>
<li>ApcStatePointer：APC相关，后续APC章节学习。</li>
<li>SavedApcState：APC相关，后续APC章节学习。</li>
<li>Win32Thread：win32线程，如果该线程是UI图形线程，就会多一个win32线程结构体。</li>
<li>ThreadListEntry：当前进程所有线程的双向链表。这个位置- KPROCESS-&gt;ThreadListEntry &#x3D;&#x3D; KPROCESS</li>
</ul>
<h2 id="2-2-线程伪装"><a href="#2-2-线程伪装" class="headerlink" title="2.2 线程伪装"></a>2.2 线程伪装</h2><p>使用<code>pchunter</code>随便查看一个进程的线程。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094127635.png" alt="image-20230615094127635"></p>
<p>然后使用Windbg查看对应的<code>ETHREAD</code>结构体。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094234272.png" alt="image-20230615094234272"></p>
<p>由于该进程具有GUI，因此<code>Win32StartAddress</code>不为null。然后将这个位置的值修改位其他线程的入口。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094549890.png" alt="image-20230615094549890"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094610181.png" alt="image-20230615094610181"></p>
<p>回到虚拟机重新查看线程所属的模块。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615094642370.png" alt="image-20230615094642370"></p>
<p>可以看到已经被伪装。</p>
<h2 id="2-3-杀死进程"><a href="#2-3-杀死进程" class="headerlink" title="2.3 杀死进程"></a>2.3 杀死进程</h2><p>杀死进程实际上等同于杀死线程，如果一个进程里没有任何线程在执行则进程等于结束。而<code>线程只能自己杀死自己</code>，原理是利用APC插入一个函数到线程中，这个函数的作用就是杀死自己，然后当线程调度后会执行这个函数就把自己杀死了。</p>
<p>杀死进程有三种方法：</p>
<ul>
<li>调用API杀死</li>
<li>清空进程中所有的线程链表。（API本质上就是这样）</li>
<li>暴力抹除进程内存。(把进程代码直接抹除或者设置为不可执行，程序就会保存退出)</li>
</ul>
<h3 id="2-3-1-NtTerminateProcess逆向"><a href="#2-3-1-NtTerminateProcess逆向" class="headerlink" title="2.3.1 NtTerminateProcess逆向"></a>2.3.1 NtTerminateProcess逆向</h3><p>首先会判断EPROCESS.RundownProtect位，如果为1则不允许结束。这个位在上边有介绍。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615095932177.png" alt="image-20230615095932177"></p>
<p>然后就是结束所有的线程。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615095952824.png" alt="image-20230615095952824"></p>
<p><code>PspTerminateAllThreads</code>中实际上就是遍历线程后调用<code>PspTerminateThreadByPointer</code>结束，进入<code>PspTerminateThreadByPointer</code>。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230615100143668.png" alt="image-20230615100143668"></p>
<blockquote>
<p>这里需要补充的是，由于EPROCESS、KPROCESS、ETHREAD、KTHREAD都有一个ThreadListEntry。他们之间的关系如下</p>
<p>EPROCESS-&gt;ThreadListEntry指向的位置是ETHREAD-&gt;ThreadListEntry</p>
<p>KPROCESS-&gt;ThreadListEntry指向的位置是KTHREAD-&gt;ThreadListEntry</p>
<p>因此如果要遍历线程需要上边对应的关系去减掉对应ThreadListEntry在*THREAD中的偏移(*表示K或者E)，才能拿到线程头</p>
</blockquote>
<h1 id="3、KPCR"><a href="#3、KPCR" class="headerlink" title="3、KPCR"></a>3、KPCR</h1><p>FS段，R0下叫做KPCR（内核进程控制区），R3下叫做PEB（进程环境块）。每一个核独有一个，这个结构记录了这个核的CPU信息。内核变量<code>KeNumberProcessors</code>用于记录当前机器有多少个核。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613122919271.png" alt="image-20230613122919271"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x3748 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KPCR</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_NT_TIB</span> NtTib;                                               <span class="comment">//0x0</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">_EXCEPTION_REGISTRATION_RECORD</span>* Used_ExceptionList;      <span class="comment">//0x0</span></span><br><span class="line">            VOID* Used_StackBase;                                           <span class="comment">//0x4</span></span><br><span class="line">            VOID* Spare2;                                                   <span class="comment">//0x8</span></span><br><span class="line">            VOID* TssCopy;                                                  <span class="comment">//0xc</span></span><br><span class="line">            ULONG ContextSwitches;                                          <span class="comment">//0x10</span></span><br><span class="line">            ULONG SetMemberCopy;                                            <span class="comment">//0x14</span></span><br><span class="line">            VOID* Used_Self;                                                <span class="comment">//0x18</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPCR</span>* SelfPcr;                                                  <span class="comment">//0x1c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPRCB</span>* Prcb;                                                    <span class="comment">//0x20</span></span><br><span class="line">    UCHAR Irql;                                                             <span class="comment">//0x24</span></span><br><span class="line">    ULONG IRR;                                                              <span class="comment">//0x28</span></span><br><span class="line">    ULONG IrrActive;                                                        <span class="comment">//0x2c</span></span><br><span class="line">    ULONG IDR;                                                              <span class="comment">//0x30</span></span><br><span class="line">    VOID* KdVersionBlock;                                                   <span class="comment">//0x34</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KIDTENTRY</span>* IDT;                                                 <span class="comment">//0x38</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KGDTENTRY</span>* GDT;                                                 <span class="comment">//0x3c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTSS</span>* TSS;                                                      <span class="comment">//0x40</span></span><br><span class="line">    USHORT MajorVersion;                                                    <span class="comment">//0x44</span></span><br><span class="line">    USHORT MinorVersion;                                                    <span class="comment">//0x46</span></span><br><span class="line">    ULONG SetMember;                                                        <span class="comment">//0x48</span></span><br><span class="line">    ULONG StallScaleFactor;                                                 <span class="comment">//0x4c</span></span><br><span class="line">    UCHAR SpareUnused;                                                      <span class="comment">//0x50</span></span><br><span class="line">    UCHAR Number;                                                           <span class="comment">//0x51</span></span><br><span class="line">    UCHAR Spare0;                                                           <span class="comment">//0x52</span></span><br><span class="line">    UCHAR SecondLevelCacheAssociativity;                                    <span class="comment">//0x53</span></span><br><span class="line">    ULONG VdmAlert;                                                         <span class="comment">//0x54</span></span><br><span class="line">    ULONG KernelReserved[<span class="number">14</span>];                                               <span class="comment">//0x58</span></span><br><span class="line">    ULONG SecondLevelCacheSize;                                             <span class="comment">//0x90</span></span><br><span class="line">    ULONG HalReserved[<span class="number">16</span>];                                                  <span class="comment">//0x94</span></span><br><span class="line">    ULONG InterruptMode;                                                    <span class="comment">//0xd4</span></span><br><span class="line">    UCHAR Spare1;                                                           <span class="comment">//0xd8</span></span><br><span class="line">    ULONG KernelReserved2[<span class="number">17</span>];                                              <span class="comment">//0xdc</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPRCB</span> PrcbData;                                                 <span class="comment">//0x120</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>NtTib：</p>
<ul>
<li>Used_ExceptionList：异常处理程序链表。</li>
<li>Used_StackBase：当前线程的栈底。</li>
<li>Spare2&#x2F;StackLimit：当前线程的堆栈大小。</li>
<li>Used_Self：指向NtTib自身，也是KPCR自身（fs:[0x18]）。</li>
</ul>
</li>
<li><p>TssCopy：0x40处TSS的初始值。</p>
</li>
<li><p>SelfPcr：指向KPCR自身。与UsedSelf不同，SelfPcr必然指向KPCR自身，UsedSelf有时候会指向TEB。</p>
</li>
<li><p>Prcb：KPRCB结构指针，实际上指向的是0x120的PrcbData。</p>
</li>
<li><p>KdVersionBlock：只有第一个核有值，其他核为0；</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011025900.png" alt="image-20230614011025900"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011102894.png" alt="image-20230614011102894"></p>
<p>并且这个位置的值大有用处！！！！这个KdVersionBlock对应的结构为<code>_DBGKD_GET_VERSION64</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_DBGKD_GET_VERSION64</span></span><br><span class="line">&#123;</span><br><span class="line">    USHORT MajorVersion;                                                    <span class="comment">//0x0</span></span><br><span class="line">    USHORT MinorVersion;                                                    <span class="comment">//0x2</span></span><br><span class="line">    UCHAR ProtocolVersion;                                                  <span class="comment">//0x4</span></span><br><span class="line">    UCHAR KdSecondaryVersion;                                               <span class="comment">//0x5</span></span><br><span class="line">    USHORT Flags;                                                           <span class="comment">//0x6</span></span><br><span class="line">    USHORT MachineType;                                                     <span class="comment">//0x8</span></span><br><span class="line">    UCHAR MaxPacketType;                                                    <span class="comment">//0xa</span></span><br><span class="line">    UCHAR MaxStateChange;                                                   <span class="comment">//0xb</span></span><br><span class="line">    UCHAR MaxManipulate;                                                    <span class="comment">//0xc</span></span><br><span class="line">    UCHAR Simulation;                                                       <span class="comment">//0xd</span></span><br><span class="line">    USHORT Unused[<span class="number">1</span>];                                                       <span class="comment">//0xe</span></span><br><span class="line">    ULONGLONG KernBase;                                                     <span class="comment">//0x10</span></span><br><span class="line">    ULONGLONG PsLoadedModuleList;                                           <span class="comment">//0x18</span></span><br><span class="line">    ULONGLONG DebuggerDataList;                                             <span class="comment">//0x20</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011455243.png" alt="image-20230614011455243"></p>
<ul>
<li>KernBase：ntoskrnl.exe的基地址</li>
<li>PsLoadedModuleList：模块链表。</li>
<li>DebuggerDataList：最牛逼的东西，里边存着很多公开&#x2F;未公开的内容。使用<code>dds</code>查看。</li>
</ul>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011631290.png" alt="image-20230614011631290"></p>
<p>可以看到里边有很多东西，比如句柄表<code>PspCidTable</code>,对于他的这个结构在WRK有给出部分(由于系统一直在更新，所以内容也一直在添加)。<code>_KDDEBUGGER_DATA64</code></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011853388.png" alt="image-20230614011853388"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614011901258.png" alt="image-20230614011901258"></p>
</li>
<li><p>IDT：当前线程的IDT表地址。</p>
</li>
<li><p>GDT：当前线程的GDT表地址。</p>
</li>
<li><p>TSS：指向当前线程的TSS表。</p>
</li>
<li><p>SetNumber：当前CPU编号。从1开始。</p>
</li>
<li><p>Number：当前CPU编号。从0开始。</p>
</li>
<li><p>PrcbData：KPRCB结构，扩展结构，见后文。</p>
</li>
</ul>
<h2 id="3-1-KPRCB"><a href="#3-1-KPRCB" class="headerlink" title="3.1 KPRCB"></a>3.1 KPRCB</h2><p>内核进程控制区域块。内核变量<code>KiProcessorBlock</code>中保存了KPRCB的地址。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613123642965.png" alt="image-20230613123642965"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x3628 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_KPRCB</span></span><br><span class="line">&#123;</span><br><span class="line">    USHORT MinorVersion;                                                    <span class="comment">//0x0</span></span><br><span class="line">    USHORT MajorVersion;                                                    <span class="comment">//0x2</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTHREAD</span>* CurrentThread;                                         <span class="comment">//0x4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTHREAD</span>* NextThread;                                            <span class="comment">//0x8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTHREAD</span>* IdleThread;                                            <span class="comment">//0xc</span></span><br><span class="line">    UCHAR LegacyNumber;                                                     <span class="comment">//0x10</span></span><br><span class="line">    UCHAR NestingLevel;                                                     <span class="comment">//0x11</span></span><br><span class="line">    USHORT BuildType;                                                       <span class="comment">//0x12</span></span><br><span class="line">    CHAR CpuType;                                                           <span class="comment">//0x14</span></span><br><span class="line">    CHAR CpuID;                                                             <span class="comment">//0x15</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        USHORT CpuStep;                                                     <span class="comment">//0x16</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            UCHAR CpuStepping;                                              <span class="comment">//0x16</span></span><br><span class="line">            UCHAR CpuModel;                                                 <span class="comment">//0x17</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPROCESSOR_STATE</span> ProcessorState;                                <span class="comment">//0x18</span></span><br><span class="line">    ULONG KernelReserved[<span class="number">16</span>];                                               <span class="comment">//0x338</span></span><br><span class="line">    ULONG HalReserved[<span class="number">16</span>];                                                  <span class="comment">//0x378</span></span><br><span class="line">    ULONG CFlushSize;                                                       <span class="comment">//0x3b8</span></span><br><span class="line">    UCHAR CoresPerPhysicalProcessor;                                        <span class="comment">//0x3bc</span></span><br><span class="line">    UCHAR LogicalProcessorsPerCore;                                         <span class="comment">//0x3bd</span></span><br><span class="line">    UCHAR PrcbPad0[<span class="number">2</span>];                                                      <span class="comment">//0x3be</span></span><br><span class="line">    ULONG MHz;                                                              <span class="comment">//0x3c0</span></span><br><span class="line">    UCHAR CpuVendor;                                                        <span class="comment">//0x3c4</span></span><br><span class="line">    UCHAR GroupIndex;                                                       <span class="comment">//0x3c5</span></span><br><span class="line">    USHORT Group;                                                           <span class="comment">//0x3c6</span></span><br><span class="line">    ULONG GroupSetMember;                                                   <span class="comment">//0x3c8</span></span><br><span class="line">    ULONG Number;                                                           <span class="comment">//0x3cc</span></span><br><span class="line">    UCHAR PrcbPad1[<span class="number">72</span>];                                                     <span class="comment">//0x3d0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KSPIN_LOCK_QUEUE</span> LockQueue[<span class="number">17</span>];                                 <span class="comment">//0x418</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTHREAD</span>* NpxThread;                                             <span class="comment">//0x4a0</span></span><br><span class="line">    ULONG InterruptCount;                                                   <span class="comment">//0x4a4</span></span><br><span class="line">    ULONG KernelTime;                                                       <span class="comment">//0x4a8</span></span><br><span class="line">    ULONG UserTime;                                                         <span class="comment">//0x4ac</span></span><br><span class="line">    ULONG DpcTime;                                                          <span class="comment">//0x4b0</span></span><br><span class="line">    ULONG DpcTimeCount;                                                     <span class="comment">//0x4b4</span></span><br><span class="line">    ULONG InterruptTime;                                                    <span class="comment">//0x4b8</span></span><br><span class="line">    ULONG AdjustDpcThreshold;                                               <span class="comment">//0x4bc</span></span><br><span class="line">    ULONG PageColor;                                                        <span class="comment">//0x4c0</span></span><br><span class="line">    UCHAR DebuggerSavedIRQL;                                                <span class="comment">//0x4c4</span></span><br><span class="line">    UCHAR NodeColor;                                                        <span class="comment">//0x4c5</span></span><br><span class="line">    UCHAR PrcbPad20[<span class="number">2</span>];                                                     <span class="comment">//0x4c6</span></span><br><span class="line">    ULONG NodeShiftedColor;                                                 <span class="comment">//0x4c8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KNODE</span>* ParentNode;                                              <span class="comment">//0x4cc</span></span><br><span class="line">    ULONG SecondaryColorMask;                                               <span class="comment">//0x4d0</span></span><br><span class="line">    ULONG DpcTimeLimit;                                                     <span class="comment">//0x4d4</span></span><br><span class="line">    ULONG PrcbPad21[<span class="number">2</span>];                                                     <span class="comment">//0x4d8</span></span><br><span class="line">    ULONG CcFastReadNoWait;                                                 <span class="comment">//0x4e0</span></span><br><span class="line">    ULONG CcFastReadWait;                                                   <span class="comment">//0x4e4</span></span><br><span class="line">    ULONG CcFastReadNotPossible;                                            <span class="comment">//0x4e8</span></span><br><span class="line">    ULONG CcCopyReadNoWait;                                                 <span class="comment">//0x4ec</span></span><br><span class="line">    ULONG CcCopyReadWait;                                                   <span class="comment">//0x4f0</span></span><br><span class="line">    ULONG CcCopyReadNoWaitMiss;                                             <span class="comment">//0x4f4</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmSpinLockOrdering;                                       <span class="comment">//0x4f8</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG IoReadOperationCount;                                     <span class="comment">//0x4fc</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG IoWriteOperationCount;                                    <span class="comment">//0x500</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG IoOtherOperationCount;                                    <span class="comment">//0x504</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> IoReadTransferCount;                               <span class="comment">//0x508</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> IoWriteTransferCount;                              <span class="comment">//0x510</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> IoOtherTransferCount;                              <span class="comment">//0x518</span></span><br><span class="line">    ULONG CcFastMdlReadNoWait;                                              <span class="comment">//0x520</span></span><br><span class="line">    ULONG CcFastMdlReadWait;                                                <span class="comment">//0x524</span></span><br><span class="line">    ULONG CcFastMdlReadNotPossible;                                         <span class="comment">//0x528</span></span><br><span class="line">    ULONG CcMapDataNoWait;                                                  <span class="comment">//0x52c</span></span><br><span class="line">    ULONG CcMapDataWait;                                                    <span class="comment">//0x530</span></span><br><span class="line">    ULONG CcPinMappedDataCount;                                             <span class="comment">//0x534</span></span><br><span class="line">    ULONG CcPinReadNoWait;                                                  <span class="comment">//0x538</span></span><br><span class="line">    ULONG CcPinReadWait;                                                    <span class="comment">//0x53c</span></span><br><span class="line">    ULONG CcMdlReadNoWait;                                                  <span class="comment">//0x540</span></span><br><span class="line">    ULONG CcMdlReadWait;                                                    <span class="comment">//0x544</span></span><br><span class="line">    ULONG CcLazyWriteHotSpots;                                              <span class="comment">//0x548</span></span><br><span class="line">    ULONG CcLazyWriteIos;                                                   <span class="comment">//0x54c</span></span><br><span class="line">    ULONG CcLazyWritePages;                                                 <span class="comment">//0x550</span></span><br><span class="line">    ULONG CcDataFlushes;                                                    <span class="comment">//0x554</span></span><br><span class="line">    ULONG CcDataPages;                                                      <span class="comment">//0x558</span></span><br><span class="line">    ULONG CcLostDelayedWrites;                                              <span class="comment">//0x55c</span></span><br><span class="line">    ULONG CcFastReadResourceMiss;                                           <span class="comment">//0x560</span></span><br><span class="line">    ULONG CcCopyReadWaitMiss;                                               <span class="comment">//0x564</span></span><br><span class="line">    ULONG CcFastMdlReadResourceMiss;                                        <span class="comment">//0x568</span></span><br><span class="line">    ULONG CcMapDataNoWaitMiss;                                              <span class="comment">//0x56c</span></span><br><span class="line">    ULONG CcMapDataWaitMiss;                                                <span class="comment">//0x570</span></span><br><span class="line">    ULONG CcPinReadNoWaitMiss;                                              <span class="comment">//0x574</span></span><br><span class="line">    ULONG CcPinReadWaitMiss;                                                <span class="comment">//0x578</span></span><br><span class="line">    ULONG CcMdlReadNoWaitMiss;                                              <span class="comment">//0x57c</span></span><br><span class="line">    ULONG CcMdlReadWaitMiss;                                                <span class="comment">//0x580</span></span><br><span class="line">    ULONG CcReadAheadIos;                                                   <span class="comment">//0x584</span></span><br><span class="line">    ULONG KeAlignmentFixupCount;                                            <span class="comment">//0x588</span></span><br><span class="line">    ULONG KeExceptionDispatchCount;                                         <span class="comment">//0x58c</span></span><br><span class="line">    ULONG KeSystemCalls;                                                    <span class="comment">//0x590</span></span><br><span class="line">    ULONG AvailableTime;                                                    <span class="comment">//0x594</span></span><br><span class="line">    ULONG PrcbPad22[<span class="number">2</span>];                                                     <span class="comment">//0x598</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_PP_LOOKASIDE_LIST</span> PPLookasideList[<span class="number">16</span>];                          <span class="comment">//0x5a0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_GENERAL_LOOKASIDE_POOL</span> PPNPagedLookasideList[<span class="number">32</span>];               <span class="comment">//0x620</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_GENERAL_LOOKASIDE_POOL</span> PPPagedLookasideList[<span class="number">32</span>];                <span class="comment">//0xf20</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG PacketBarrier;                                           <span class="comment">//0x1820</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG ReverseStall;                                             <span class="comment">//0x1824</span></span><br><span class="line">    VOID* IpiFrame;                                                         <span class="comment">//0x1828</span></span><br><span class="line">    UCHAR PrcbPad3[<span class="number">52</span>];                                                     <span class="comment">//0x182c</span></span><br><span class="line">    VOID* <span class="keyword">volatile</span> CurrentPacket[<span class="number">3</span>];                                        <span class="comment">//0x1860</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG TargetSet;                                               <span class="comment">//0x186c</span></span><br><span class="line">    <span class="built_in">VOID</span> (* volatileWorkerRoutine)(VOID* arg1, VOID* arg2, VOID* arg3, VOID* arg4); <span class="comment">//0x1870</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG IpiFrozen;                                               <span class="comment">//0x1874</span></span><br><span class="line">    UCHAR PrcbPad4[<span class="number">40</span>];                                                     <span class="comment">//0x1878</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG RequestSummary;                                          <span class="comment">//0x18a0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KPRCB</span>* <span class="keyword">volatile</span> SignalDone;                                     <span class="comment">//0x18a4</span></span><br><span class="line">    UCHAR PrcbPad50[<span class="number">56</span>];                                                    <span class="comment">//0x18a8</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KDPC_DATA</span> DpcData[<span class="number">2</span>];                                           <span class="comment">//0x18e0</span></span><br><span class="line">    VOID* DpcStack;                                                         <span class="comment">//0x1908</span></span><br><span class="line">    LONG MaximumDpcQueueDepth;                                              <span class="comment">//0x190c</span></span><br><span class="line">    ULONG DpcRequestRate;                                                   <span class="comment">//0x1910</span></span><br><span class="line">    ULONG MinimumDpcRate;                                                   <span class="comment">//0x1914</span></span><br><span class="line">    ULONG DpcLastCount;                                                     <span class="comment">//0x1918</span></span><br><span class="line">    ULONG PrcbLock;                                                         <span class="comment">//0x191c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KGATE</span> DpcGate;                                                  <span class="comment">//0x1920</span></span><br><span class="line">    UCHAR ThreadDpcEnable;                                                  <span class="comment">//0x1930</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR QuantumEnd;                                              <span class="comment">//0x1931</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR DpcRoutineActive;                                        <span class="comment">//0x1932</span></span><br><span class="line">    <span class="keyword">volatile</span> UCHAR IdleSchedule;                                            <span class="comment">//0x1933</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">volatile</span> LONG DpcRequestSummary;                                    <span class="comment">//0x1934</span></span><br><span class="line">        SHORT DpcRequestSlot[<span class="number">2</span>];                                            <span class="comment">//0x1934</span></span><br><span class="line">        <span class="keyword">struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            SHORT NormalDpcState;                                           <span class="comment">//0x1934</span></span><br><span class="line">            <span class="keyword">union</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">volatile</span> USHORT DpcThreadActive:<span class="number">1</span>;                          <span class="comment">//0x1936</span></span><br><span class="line">                SHORT ThreadDpcState;                                       <span class="comment">//0x1936</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">volatile</span> ULONG TimerHand;                                               <span class="comment">//0x1938</span></span><br><span class="line">    ULONG LastTick;                                                         <span class="comment">//0x193c</span></span><br><span class="line">    LONG MasterOffset;                                                      <span class="comment">//0x1940</span></span><br><span class="line">    ULONG PrcbPad41[<span class="number">2</span>];                                                     <span class="comment">//0x1944</span></span><br><span class="line">    ULONG PeriodicCount;                                                    <span class="comment">//0x194c</span></span><br><span class="line">    ULONG PeriodicBias;                                                     <span class="comment">//0x1950</span></span><br><span class="line">    ULONGLONG TickOffset;                                                   <span class="comment">//0x1958</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTIMER_TABLE</span> TimerTable;                                        <span class="comment">//0x1960</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KDPC</span> CallDpc;                                                   <span class="comment">//0x31a0</span></span><br><span class="line">    LONG ClockKeepAlive;                                                    <span class="comment">//0x31c0</span></span><br><span class="line">    UCHAR ClockCheckSlot;                                                   <span class="comment">//0x31c4</span></span><br><span class="line">    UCHAR ClockPollCycle;                                                   <span class="comment">//0x31c5</span></span><br><span class="line">    UCHAR PrcbPad6[<span class="number">2</span>];                                                      <span class="comment">//0x31c6</span></span><br><span class="line">    LONG DpcWatchdogPeriod;                                                 <span class="comment">//0x31c8</span></span><br><span class="line">    LONG DpcWatchdogCount;                                                  <span class="comment">//0x31cc</span></span><br><span class="line">    LONG ThreadWatchdogPeriod;                                              <span class="comment">//0x31d0</span></span><br><span class="line">    LONG ThreadWatchdogCount;                                               <span class="comment">//0x31d4</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG KeSpinLockOrdering;                                       <span class="comment">//0x31d8</span></span><br><span class="line">    ULONG PrcbPad70[<span class="number">1</span>];                                                     <span class="comment">//0x31dc</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> WaitListHead;                                        <span class="comment">//0x31e0</span></span><br><span class="line">    ULONG WaitLock;                                                         <span class="comment">//0x31e8</span></span><br><span class="line">    ULONG ReadySummary;                                                     <span class="comment">//0x31ec</span></span><br><span class="line">    ULONG QueueIndex;                                                       <span class="comment">//0x31f0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_SINGLE_LIST_ENTRY</span> DeferredReadyListHead;                        <span class="comment">//0x31f4</span></span><br><span class="line">    ULONGLONG StartCycles;                                                  <span class="comment">//0x31f8</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONGLONG CycleTime;                                           <span class="comment">//0x3200</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG HighCycleTime;                                           <span class="comment">//0x3208</span></span><br><span class="line">    ULONG PrcbPad71;                                                        <span class="comment">//0x320c</span></span><br><span class="line">    ULONGLONG PrcbPad72[<span class="number">2</span>];                                                 <span class="comment">//0x3210</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_LIST_ENTRY</span> DispatcherReadyListHead[<span class="number">32</span>];                         <span class="comment">//0x3220</span></span><br><span class="line">    VOID* ChainedInterruptList;                                             <span class="comment">//0x3320</span></span><br><span class="line">    LONG LookasideIrpFloat;                                                 <span class="comment">//0x3324</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmPageFaultCount;                                         <span class="comment">//0x3328</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmCopyOnWriteCount;                                       <span class="comment">//0x332c</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmTransitionCount;                                        <span class="comment">//0x3330</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmCacheTransitionCount;                                   <span class="comment">//0x3334</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmDemandZeroCount;                                        <span class="comment">//0x3338</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmPageReadCount;                                          <span class="comment">//0x333c</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmPageReadIoCount;                                        <span class="comment">//0x3340</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmCacheReadCount;                                         <span class="comment">//0x3344</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmCacheIoCount;                                           <span class="comment">//0x3348</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmDirtyPagesWriteCount;                                   <span class="comment">//0x334c</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmDirtyWriteIoCount;                                      <span class="comment">//0x3350</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmMappedPagesWriteCount;                                  <span class="comment">//0x3354</span></span><br><span class="line">    <span class="keyword">volatile</span> LONG MmMappedWriteIoCount;                                     <span class="comment">//0x3358</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG CachedCommit;                                            <span class="comment">//0x335c</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONG CachedResidentAvailable;                                 <span class="comment">//0x3360</span></span><br><span class="line">    VOID* HyperPte;                                                         <span class="comment">//0x3364</span></span><br><span class="line">    UCHAR PrcbPad8[<span class="number">4</span>];                                                      <span class="comment">//0x3368</span></span><br><span class="line">    UCHAR VendorString[<span class="number">13</span>];                                                 <span class="comment">//0x336c</span></span><br><span class="line">    UCHAR InitialApicId;                                                    <span class="comment">//0x3379</span></span><br><span class="line">    UCHAR LogicalProcessorsPerPhysicalProcessor;                            <span class="comment">//0x337a</span></span><br><span class="line">    UCHAR PrcbPad9[<span class="number">5</span>];                                                      <span class="comment">//0x337b</span></span><br><span class="line">    ULONG FeatureBits;                                                      <span class="comment">//0x3380</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> UpdateSignature;                                   <span class="comment">//0x3388</span></span><br><span class="line">    <span class="keyword">volatile</span> ULONGLONG IsrTime;                                             <span class="comment">//0x3390</span></span><br><span class="line">    ULONGLONG RuntimeAccumulation;                                          <span class="comment">//0x3398</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_PROCESSOR_POWER_STATE</span> PowerState;                               <span class="comment">//0x33a0</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KDPC</span> DpcWatchdogDpc;                                            <span class="comment">//0x3468</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KTIMER</span> DpcWatchdogTimer;                                        <span class="comment">//0x3488</span></span><br><span class="line">    VOID* WheaInfo;                                                         <span class="comment">//0x34b0</span></span><br><span class="line">    VOID* EtwSupport;                                                       <span class="comment">//0x34b4</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_SLIST_HEADER</span> InterruptObjectPool;                                <span class="comment">//0x34b8</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">_SLIST_HEADER</span> HypercallPageList;                                  <span class="comment">//0x34c0</span></span><br><span class="line">    VOID* HypercallPageVirtual;                                             <span class="comment">//0x34c8</span></span><br><span class="line">    VOID* VirtualApicAssist;                                                <span class="comment">//0x34cc</span></span><br><span class="line">    ULONGLONG* StatisticsPage;                                              <span class="comment">//0x34d0</span></span><br><span class="line">    VOID* RateControl;                                                      <span class="comment">//0x34d4</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_CACHE_DESCRIPTOR</span> Cache[<span class="number">5</span>];                                      <span class="comment">//0x34d8</span></span><br><span class="line">    ULONG CacheCount;                                                       <span class="comment">//0x3514</span></span><br><span class="line">    ULONG CacheProcessorMask[<span class="number">5</span>];                                            <span class="comment">//0x3518</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KAFFINITY_EX</span> PackageProcessorSet;                               <span class="comment">//0x352c</span></span><br><span class="line">    ULONG PrcbPad91[<span class="number">1</span>];                                                     <span class="comment">//0x3538</span></span><br><span class="line">    ULONG CoreProcessorSet;                                                 <span class="comment">//0x353c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_KDPC</span> TimerExpirationDpc;                                        <span class="comment">//0x3540</span></span><br><span class="line">    ULONG SpinLockAcquireCount;                                             <span class="comment">//0x3560</span></span><br><span class="line">    ULONG SpinLockContentionCount;                                          <span class="comment">//0x3564</span></span><br><span class="line">    ULONG SpinLockSpinCount;                                                <span class="comment">//0x3568</span></span><br><span class="line">    ULONG IpiSendRequestBroadcastCount;                                     <span class="comment">//0x356c</span></span><br><span class="line">    ULONG IpiSendRequestRoutineCount;                                       <span class="comment">//0x3570</span></span><br><span class="line">    ULONG IpiSendSoftwareInterruptCount;                                    <span class="comment">//0x3574</span></span><br><span class="line">    ULONG ExInitializeResourceCount;                                        <span class="comment">//0x3578</span></span><br><span class="line">    ULONG ExReInitializeResourceCount;                                      <span class="comment">//0x357c</span></span><br><span class="line">    ULONG ExDeleteResourceCount;                                            <span class="comment">//0x3580</span></span><br><span class="line">    ULONG ExecutiveResourceAcquiresCount;                                   <span class="comment">//0x3584</span></span><br><span class="line">    ULONG ExecutiveResourceContentionsCount;                                <span class="comment">//0x3588</span></span><br><span class="line">    ULONG ExecutiveResourceReleaseExclusiveCount;                           <span class="comment">//0x358c</span></span><br><span class="line">    ULONG ExecutiveResourceReleaseSharedCount;                              <span class="comment">//0x3590</span></span><br><span class="line">    ULONG ExecutiveResourceConvertsCount;                                   <span class="comment">//0x3594</span></span><br><span class="line">    ULONG ExAcqResExclusiveAttempts;                                        <span class="comment">//0x3598</span></span><br><span class="line">    ULONG ExAcqResExclusiveAcquiresExclusive;                               <span class="comment">//0x359c</span></span><br><span class="line">    ULONG ExAcqResExclusiveAcquiresExclusiveRecursive;                      <span class="comment">//0x35a0</span></span><br><span class="line">    ULONG ExAcqResExclusiveWaits;                                           <span class="comment">//0x35a4</span></span><br><span class="line">    ULONG ExAcqResExclusiveNotAcquires;                                     <span class="comment">//0x35a8</span></span><br><span class="line">    ULONG ExAcqResSharedAttempts;                                           <span class="comment">//0x35ac</span></span><br><span class="line">    ULONG ExAcqResSharedAcquiresExclusive;                                  <span class="comment">//0x35b0</span></span><br><span class="line">    ULONG ExAcqResSharedAcquiresShared;                                     <span class="comment">//0x35b4</span></span><br><span class="line">    ULONG ExAcqResSharedAcquiresSharedRecursive;                            <span class="comment">//0x35b8</span></span><br><span class="line">    ULONG ExAcqResSharedWaits;                                              <span class="comment">//0x35bc</span></span><br><span class="line">    ULONG ExAcqResSharedNotAcquires;                                        <span class="comment">//0x35c0</span></span><br><span class="line">    ULONG ExAcqResSharedStarveExclusiveAttempts;                            <span class="comment">//0x35c4</span></span><br><span class="line">    ULONG ExAcqResSharedStarveExclusiveAcquiresExclusive;                   <span class="comment">//0x35c8</span></span><br><span class="line">    ULONG ExAcqResSharedStarveExclusiveAcquiresShared;                      <span class="comment">//0x35cc</span></span><br><span class="line">    ULONG ExAcqResSharedStarveExclusiveAcquiresSharedRecursive;             <span class="comment">//0x35d0</span></span><br><span class="line">    ULONG ExAcqResSharedStarveExclusiveWaits;                               <span class="comment">//0x35d4</span></span><br><span class="line">    ULONG ExAcqResSharedStarveExclusiveNotAcquires;                         <span class="comment">//0x35d8</span></span><br><span class="line">    ULONG ExAcqResSharedWaitForExclusiveAttempts;                           <span class="comment">//0x35dc</span></span><br><span class="line">    ULONG ExAcqResSharedWaitForExclusiveAcquiresExclusive;                  <span class="comment">//0x35e0</span></span><br><span class="line">    ULONG ExAcqResSharedWaitForExclusiveAcquiresShared;                     <span class="comment">//0x35e4</span></span><br><span class="line">    ULONG ExAcqResSharedWaitForExclusiveAcquiresSharedRecursive;            <span class="comment">//0x35e8</span></span><br><span class="line">    ULONG ExAcqResSharedWaitForExclusiveWaits;                              <span class="comment">//0x35ec</span></span><br><span class="line">    ULONG ExAcqResSharedWaitForExclusiveNotAcquires;                        <span class="comment">//0x35f0</span></span><br><span class="line">    ULONG ExSetResOwnerPointerExclusive;                                    <span class="comment">//0x35f4</span></span><br><span class="line">    ULONG ExSetResOwnerPointerSharedNew;                                    <span class="comment">//0x35f8</span></span><br><span class="line">    ULONG ExSetResOwnerPointerSharedOld;                                    <span class="comment">//0x35fc</span></span><br><span class="line">    ULONG ExTryToAcqExclusiveAttempts;                                      <span class="comment">//0x3600</span></span><br><span class="line">    ULONG ExTryToAcqExclusiveAcquires;                                      <span class="comment">//0x3604</span></span><br><span class="line">    ULONG ExBoostExclusiveOwner;                                            <span class="comment">//0x3608</span></span><br><span class="line">    ULONG ExBoostSharedOwners;                                              <span class="comment">//0x360c</span></span><br><span class="line">    ULONG ExEtwSynchTrackingNotificationsCount;                             <span class="comment">//0x3610</span></span><br><span class="line">    ULONG ExEtwSynchTrackingNotificationsAccountedCount;                    <span class="comment">//0x3614</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_CONTEXT</span>* Context;                                               <span class="comment">//0x3618</span></span><br><span class="line">    ULONG ContextFlags;                                                     <span class="comment">//0x361c</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_XSAVE_AREA</span>* ExtendedState;                                      <span class="comment">//0x3620</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li>CurrentThread：当前CPU正在跑的线程。</li>
<li>NextThread：将要切换的线程。</li>
<li>IdleThread：如果没有要切换的线程，CPU将要跑的空闲线程。</li>
<li>DispatcherReadyListHead：线程就绪位，共32位，哪一位为1说明哪一个核上有线程在跑。</li>
</ul>
<h2 id="3-2-代码获取KiProcessorBlock"><a href="#3-2-代码获取KiProcessorBlock" class="headerlink" title="3.2 代码获取KiProcessorBlock"></a>3.2 代码获取KiProcessorBlock</h2><p>由于<code>KiProcessorBlock</code>是未公开的变量，因此不能直接使用。但是可以通过上边的<code>KdVersionBlock</code>进行获取。由于只有0核下这个成员才有值，因此需要将当前的运行线程切换到0核，可以通过函数<code>KeSetSystemAffinityThread</code>指定当前线程到0核执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DBGKD_GET_VERSION64</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	USHORT MajorVersion;                                                    <span class="comment">//0x0</span></span><br><span class="line">	USHORT MinorVersion;                                                    <span class="comment">//0x2</span></span><br><span class="line">	UCHAR ProtocolVersion;                                                  <span class="comment">//0x4</span></span><br><span class="line">	UCHAR KdSecondaryVersion;                                               <span class="comment">//0x5</span></span><br><span class="line">	USHORT Flags;                                                           <span class="comment">//0x6</span></span><br><span class="line">	USHORT MachineType;                                                     <span class="comment">//0x8</span></span><br><span class="line">	UCHAR MaxPacketType;                                                    <span class="comment">//0xa</span></span><br><span class="line">	UCHAR MaxStateChange;                                                   <span class="comment">//0xb</span></span><br><span class="line">	UCHAR MaxManipulate;                                                    <span class="comment">//0xc</span></span><br><span class="line">	UCHAR Simulation;                                                       <span class="comment">//0xd</span></span><br><span class="line">	USHORT Unused[<span class="number">1</span>];                                                       <span class="comment">//0xe</span></span><br><span class="line">	ULONGLONG KernBase;                                                     <span class="comment">//0x10</span></span><br><span class="line">	ULONGLONG PsLoadedModuleList;                                           <span class="comment">//0x18</span></span><br><span class="line">	ULONGLONG DebuggerDataList;                                             <span class="comment">//0x20</span></span><br><span class="line">&#125;DBGKD_GET_VERSION64, *PDBGKD_GET_VERSION64;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">unloaddrv</span><span class="params">(PDRIVER_OBJECT pDrv)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDrv,PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">	pDrv-&gt;DriverUnload = unloaddrv;</span><br><span class="line"></span><br><span class="line">	KeSetSystemAffinityThread(<span class="number">0</span>);<span class="comment">//设置到0核</span></span><br><span class="line">	PKPCR kpcr = (PKPCR)__readfsdword(<span class="number">0x1C</span>); <span class="comment">//SelfPcr</span></span><br><span class="line">	PDBGKD_GET_VERSION64 pdbgVer = (PDBGKD_GET_VERSION64)kpcr-&gt;KdVersionBlock;</span><br><span class="line">	ULONG_PTR DbgDataList = *(PULONG_PTR)(pdbgVer-&gt;DebuggerDataList);</span><br><span class="line">	DbgPrint(<span class="string">&quot;DbgDataList=%p\n&quot;</span>, DbgDataList);</span><br><span class="line">	ULONG_PTR KiProcessorBlock = *(PULONG_PTR)(DbgDataList + <span class="number">0x218</span>);   <span class="comment">//KiProcessorBlock - *DebuggerDataList = 0x218</span></span><br><span class="line">	DbgPrint(<span class="string">&quot;KiProcessorBlock=%p\n&quot;</span>, KiProcessorBlock);</span><br><span class="line">	KeRevertToUserAffinityThread();<span class="comment">//恢复</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614014234470.png" alt="image-20230614014234470"></p>
<h1 id="4、OBJECT-HEADER"><a href="#4、OBJECT-HEADER" class="headerlink" title="4、OBJECT_HEADER"></a>4、OBJECT_HEADER</h1><p>每一个对象都有一个对象头，然后接着才是对象类型的结构内容。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613130813145.png" alt="image-20230613130813145"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x20 bytes (sizeof)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_OBJECT_HEADER</span></span><br><span class="line">&#123;</span><br><span class="line">    LONG PointerCount;                                                      <span class="comment">//0x0</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        LONG HandleCount;                                                   <span class="comment">//0x4</span></span><br><span class="line">        VOID* NextToFree;                                                   <span class="comment">//0x4</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_EX_PUSH_LOCK</span> Lock;                                              <span class="comment">//0x8</span></span><br><span class="line">    UCHAR TypeIndex;                                                        <span class="comment">//0xc</span></span><br><span class="line">    UCHAR TraceFlags;                                                       <span class="comment">//0xd</span></span><br><span class="line">    UCHAR InfoMask;                                                         <span class="comment">//0xe</span></span><br><span class="line">    UCHAR Flags;                                                            <span class="comment">//0xf</span></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">_OBJECT_CREATE_INFORMATION</span>* ObjectCreateInfo;                <span class="comment">//0x10</span></span><br><span class="line">        VOID* QuotaBlockCharged;                                            <span class="comment">//0x10</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* SecurityDescriptor;                                               <span class="comment">//0x14</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_QUAD</span> Body;                                                      <span class="comment">//0x18</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<ul>
<li>PointerCount：对应的内核对象被使用了多少次。如调用ObXXXX函数都会将该值+1。该值为0时，对应的内核对象就会被释放。</li>
<li>HandleCount：句柄引用。</li>
<li>TypeIndex：对应的内核对象的类型。</li>
<li>Flags：详细作用未知。当此处的值被置为4时（对应的对象为进程对象时），对应的进程被保护，无法打开、附加。且不影响进程功能。仅对3环起作用。</li>
<li>Body：接着实际对象类型的结构数据，比如EPROCESS,ETHREAD等等。因此一个对象<code>-0x18</code>可以得到对象头的首地址。</li>
</ul>
<h1 id="5、Window查询就绪线程函数"><a href="#5、Window查询就绪线程函数" class="headerlink" title="5、Window查询就绪线程函数"></a>5、Window查询就绪线程函数</h1><p>KPRCB中ReadySummary成员（0x31EC）为就绪位图，4字节32位。每一位对应一条就绪链表。某一位为1则说明对应的就绪链表中有等待执行的线程。32条就绪链表存储在KPRCB中DispatcherReadyListHead成员。如：ReadySummary值为5，二进制0101，说明第0号、第3号就绪链表中存在待执行线程。在线程切换时就会从这两个链表中取待切换的线程。</p>
<p>Windows中<code>KiFindReadyThread</code>用来查询就绪函数。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613160832341.png" alt="image-20230613160832341"></p>
<p>通过对函数的交叉引用可知前一个参数为ReadySummary后两个都为KPRCB指针。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230613160745296.png" alt="image-20230613160745296"></p>
<blockquote>
<p>bsr从低-&gt;高扫描源操作数第一个为1的位置,下标保存到目的操作数。</p>
<p>bx &#x3D; 0x10 -&gt; 0001 0000</p>
<p>bsr ax,bx -&gt; ax &#x3D; 4</p>
</blockquote>
<ul>
<li>没有就绪线程时，CPU会运行一个系统事先准备好的空线程。（Ide）</li>
<li>线程亲核性决定了线程可以跑在哪个核上。如果恶意修改某个线程结构的亲核性为不存在的核，等同于杀死线程。</li>
</ul>
<h1 id="6、Windows交换线程函数"><a href="#6、Windows交换线程函数" class="headerlink" title="6、Windows交换线程函数"></a>6、Windows交换线程函数</h1><p>Windows中有两种线程切换方式，一种是主动切换（WaitForSingleObject、Sleep），另一种是被动切换（CPU时钟）。</p>
<p>线程状态(来自WKR)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ypedef <span class="class"><span class="keyword">enum</span> _<span class="title">KTHREAD_STATE</span> &#123;</span></span><br><span class="line">    Initialized,  	<span class="comment">//初始化状态</span></span><br><span class="line">    Ready,        	<span class="comment">//就绪状态，此时线程在就绪链表中等待被取出。</span></span><br><span class="line">    Running,    	<span class="comment">//运行状态</span></span><br><span class="line">    Standby,    	<span class="comment">//备用状态，当一个线程被设置到KPRCB的NextThread成员时，为备用状态，线程切换时会直接切换到NextThread中的线程。</span></span><br><span class="line">	Terminated,     <span class="comment">//结束状态。</span></span><br><span class="line">    Waiting,        <span class="comment">//等待状态。</span></span><br><span class="line">    Transition,     <span class="comment">//交换状态。 当线程优先级很低，执行频率很低时，会被交换到磁盘上。此时为交换状态。内部细分为：正在换出、已经换出、正在换入、已经换入。</span></span><br><span class="line">    DeferredReady, 	<span class="comment">//没用到</span></span><br><span class="line">    GateWait    	<span class="comment">//没用到</span></span><br><span class="line">&#125; KTHREAD_STATE;</span><br></pre></td></tr></table></figure>

<h2 id="6-1-主动切换"><a href="#6-1-主动切换" class="headerlink" title="6.1 主动切换"></a>6.1 主动切换</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WaitForSingleObject-&gt;NtWaitForSingleObject-&gt;KiCommitThreadWait-&gt;KiSwapThread</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sleep-&gt;SleepEx-&gt;RtlDelayExecution-&gt;NtDelayExecution-&gt;KiCommitThreadWait-&gt;KiSwapThread</span><br></pre></td></tr></table></figure>

<h3 id="6-1-1-KiSwapThread逆向"><a href="#6-1-1-KiSwapThread逆向" class="headerlink" title="6.1.1 KiSwapThread逆向"></a>6.1.1 KiSwapThread逆向</h3><p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114646701.png" alt="image-20230614114646701"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114706308.png" alt="image-20230614114706308"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114718633.png" alt="image-20230614114718633"></p>
<p><code>KiSwapThread</code>只是做了查询就绪函数，实际上线程交换是在<code>KiSwapContext</code>中</p>
<h3 id="6-1-2-KiSearchForNewThread逆向"><a href="#6-1-2-KiSearchForNewThread逆向" class="headerlink" title="6.1.2 KiSearchForNewThread逆向"></a>6.1.2 KiSearchForNewThread逆向</h3><p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614114935264.png" alt="image-20230614114935264"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115004134.png" alt="image-20230614115004134"></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115014216.png" alt="image-20230614115014216"></p>
<p><code>KiSearchForNewThread</code>函数主要是对<code>KiSwapThread</code>调用时出入的KPRCB参数进行查找就绪函数，如果当前核找不到则切换到其他核找。</p>
<h3 id="6-1-3-SwapContext逆向"><a href="#6-1-3-SwapContext逆向" class="headerlink" title="6.1.3 SwapContext逆向"></a>6.1.3 SwapContext逆向</h3><p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115135812.png" alt="image-20230614115135812"></p>
<p>首先将新线程的状态设置为就绪，然后获取新线程的堆栈作为<code>SwapContext_PatchXSave</code>参数调用。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115229779.png" alt="image-20230614115229779"></p>
<p>接着是判断新旧线程是否来自同一个进程。如果是同一个进程则进行切换环境。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115305076.png" alt="image-20230614115305076"></p>
<p>如果不是同一个进程则会切换CR3操作之类的。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614115612425.png" alt="image-20230614115612425"></p>
<blockquote>
<p>1、用户层绝大部分API的调用都会导致线程的切换</p>
<p>2、本质上没有进程切换，只是在线程切换时如果不是同一进程则会顺带CR3进行处理。</p>
</blockquote>
<h2 id="6-2-被动切换"><a href="#6-2-被动切换" class="headerlink" title="6.2 被动切换"></a>6.2 被动切换</h2><p>被动切换实际上是CPU时钟切换，windbg使用<code>!idt</code>中断表，其中有一项名为<code>hal!HalpHpetClockInterrupt</code>。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120241008.png" alt="image-20230614120241008"></p>
<p>可以看到属于hal模块，因为CPU操作属于硬件操作。hal负责与硬件进行操作。Windows系统对于不同的处理器提供了不同的hal模块。在Windbg中输入命令<code>lm</code>查看当前Windows使用的hal模块全名称。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120410056.png" alt="image-20230614120410056"></p>
<p>ida打开后跳转到<code>HalpHpetClockInterrupt</code>.</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120813868.png" alt="image-20230614120813868"></p>
<p>简单分析后实际上有用的也就<code>KeUpdateSystemTime</code>函数，进入查看。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120850794.png" alt="image-20230614120850794"></p>
<p>发现来自导入表。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120909664.png" alt="image-20230614120909664"></p>
<p>回到ntotkrnl查看该函数。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614120949595.png" alt="image-20230614120949595"></p>
<p>函数很长，实际上有用的是最后的返回函数。</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121210212.png" alt="image-20230614121210212"></p>
<p>继续回到hal查看<code>HalRequestSoftwareInterrupt</code></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121501799.png" alt="image-20230614121501799"></p>
<p>进入<code>KfLowerIrql</code>.</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121554962.png" alt="image-20230614121554962"></p>
<p>进入<code>HalpCheckForSoftwareInterrupt</code>.</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121614349.png" alt="image-20230614121614349"></p>
<p>进入<code>HalpDispatchSoftwareInterrupt</code></p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121631225.png" alt="image-20230614121631225"></p>
<p>回到ntoskrnl进入<code>KiDispatchInterrupt</code>.</p>
<p><img src="/./x86%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230614121711042.png" alt="image-20230614121711042"></p>
<p>CPU时钟的调用流程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hal!HalpHpetClockInterrupt</span><br><span class="line">nt!KeUpdateSystemTime</span><br><span class="line">nt!KeUpdateRunTime</span><br><span class="line">hal!HalRequestSoftwareInterrupt</span><br><span class="line">hal!KfLowerIrql</span><br><span class="line">hal!HalpCheckForSoftwareInterrupt</span><br><span class="line">hal!HalpDispatchSoftwareInterrupt</span><br><span class="line">nt!KiDispatchInterrupt</span><br><span class="line">SwapContext</span><br></pre></td></tr></table></figure>

<p>只是简单跟了一下~~~~。</p>
<blockquote>
<p>另外，当软件发生异常的时候（实际上就是中断），就会进行线程切换。因此，在Windows操作系统中，调用绝大部分API 以及 触发各种异常 均会导致线程的切换。如果想让自己的线程永远占有CPU，则不可以调用API、不能触发异常（内存访问也可能触发缺页异常，在用户层是看不出来的）。</p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/06/13/Usual/Linux%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="prev" title="Linux环境搭建常用命令">
                  <i class="fa fa-chevron-left"></i> Linux环境搭建常用命令
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/06/14/Anti/VMProtect%E5%88%86%E6%9E%90-%E5%8A%A0%E8%BD%BD%E5%99%A8/" rel="next" title="VMProtect分析-加载器">
                  VMProtect分析-加载器 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PlaneJun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
