<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="codeva-XHCX41TH3N">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.planejun.cn","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.17.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一、没有大炮我们自己造首先编写一个简单的程序。 1234567int main()&amp;#123;	int a &#x3D; 1;	a &#x3D; a + 1;	printf(&quot;%d\n&quot;,a);	return 0;&amp;#125;  编译后给程序添加vmp保护壳，这里选择的VMP版本为v3.5.0。">
<meta property="og:type" content="article">
<meta property="og:title" content="VMProtect分析-虚拟化流程">
<meta property="og:url" content="https://blog.planejun.cn/2023/01/05/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="PlaneJun&#39;Blog">
<meta property="og:description" content="一、没有大炮我们自己造首先编写一个简单的程序。 1234567int main()&amp;#123;	int a &#x3D; 1;	a &#x3D; a + 1;	printf(&quot;%d\n&quot;,a);	return 0;&amp;#125;  编译后给程序添加vmp保护壳，这里选择的VMP版本为v3.5.0。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160101521.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160113820.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160125791.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160139363.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160153886.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160206575.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160031408.png">
<meta property="og:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105162339766.png">
<meta property="article:published_time" content="2023-01-05T07:28:00.000Z">
<meta property="article:modified_time" content="2024-04-21T13:23:05.656Z">
<meta property="article:author" content="PlaneJun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.planejun.cn/images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160101521.png">


<link rel="canonical" href="https://blog.planejun.cn/2023/01/05/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.planejun.cn/2023/01/05/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/","path":"2023/01/05/VMProtect分析-虚拟化流程/","title":"VMProtect分析-虚拟化流程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>VMProtect分析-虚拟化流程 | PlaneJun'Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">PlaneJun'Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">我是从未来来的！现在学已经来不及了，放开玩吧！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section">归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section">分类</a></li><li class="menu-item menu-item-github"><a href="https://www.github.com/PlaneJun" rel="section" target="_blank">GitHub</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section">关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%B2%A1%E6%9C%89%E5%A4%A7%E7%82%AE%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E9%80%A0"><span class="nav-number">1.</span> <span class="nav-text">一、没有大炮我们自己造</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%8F%AA%E8%83%BD%E6%8B%89%E4%B8%80%E7%82%B9%E7%82%B9"><span class="nav-number">2.</span> <span class="nav-text">二、只能拉一点点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%97%B6%E9%97%B4%E4%BC%9A%E5%91%8A%E8%AF%89%E4%BD%A0%E7%AD%94%E6%A1%88"><span class="nav-number">3.</span> <span class="nav-text">三、时间会告诉你答案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E6%8C%87%E4%BB%A4%E5%88%86%E6%9E%90"><span class="nav-number">3.1.</span> <span class="nav-text">1、指令分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VMEntry"><span class="nav-number">3.1.1.</span> <span class="nav-text">VMEntry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VMInit"><span class="nav-number">3.1.2.</span> <span class="nav-text">VMInit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r10"><span class="nav-number">3.1.3.</span> <span class="nav-text">vPop r10</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r12"><span class="nav-number">3.1.4.</span> <span class="nav-text">vPop r12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r8"><span class="nav-number">3.1.5.</span> <span class="nav-text">vPop r8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r6"><span class="nav-number">3.1.6.</span> <span class="nav-text">vPop r6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r3"><span class="nav-number">3.1.7.</span> <span class="nav-text">vPop r3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r5"><span class="nav-number">3.1.8.</span> <span class="nav-text">vPop r5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r9"><span class="nav-number">3.1.9.</span> <span class="nav-text">vPop r9</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r2"><span class="nav-number">3.1.10.</span> <span class="nav-text">vPop r2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r4"><span class="nav-number">3.1.11.</span> <span class="nav-text">vPop r4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r0"><span class="nav-number">3.1.12.</span> <span class="nav-text">vPop r0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r15"><span class="nav-number">3.1.13.</span> <span class="nav-text">vPop r15</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-ebp-0x19ff74"><span class="nav-number">3.1.14.</span> <span class="nav-text">vPush ebp(0x19ff74)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-esp-0x0019FF2C"><span class="nav-number">3.1.15.</span> <span class="nav-text">vPush esp(0x0019FF2C)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-ebp-0x19FF2C"><span class="nav-number">3.1.16.</span> <span class="nav-text">vPop ebp(0x19FF2C)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-ecx-0x0"><span class="nav-number">3.1.17.</span> <span class="nav-text">vPush ecx(0x0)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-esp"><span class="nav-number">3.1.18.</span> <span class="nav-text">vPush esp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-1"><span class="nav-number">3.1.19.</span> <span class="nav-text">vPush 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-ebp-0x0019FF2C"><span class="nav-number">3.1.20.</span> <span class="nav-text">vPush ebp(0x0019FF2C)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-4-0xFFFFFFFC"><span class="nav-number">3.1.21.</span> <span class="nav-text">vPush -4(0xFFFFFFFC)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%8F%98%E9%87%8Fa%E7%9A%84%E5%9C%B0%E5%9D%80-ebp-4"><span class="nav-number">3.1.22.</span> <span class="nav-text">计算变量a的地址,ebp-4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r12-1"><span class="nav-number">3.1.23.</span> <span class="nav-text">vPop r12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mov-dword-ptr-ebp-4-1"><span class="nav-number">3.1.24.</span> <span class="nav-text">mov dword ptr [ebp-4],1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-4-0xFFFFFFFC-1"><span class="nav-number">3.1.25.</span> <span class="nav-text">vPush -4(0xFFFFFFFC)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%8F%98%E9%87%8Fa%E7%9A%84%E5%9C%B0%E5%9D%80-ebp-4-1"><span class="nav-number">3.1.26.</span> <span class="nav-text">计算变量a的地址,ebp-4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r11"><span class="nav-number">3.1.27.</span> <span class="nav-text">vPop r11</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%8A%E5%8F%98%E9%87%8Fa%E7%9A%84%E5%80%BC%E5%AD%98%E6%94%BE%E6%A0%88%E9%A1%B6"><span class="nav-number">3.1.28.</span> <span class="nav-text">把变量a的值存放栈顶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r15-1"><span class="nav-number">3.1.29.</span> <span class="nav-text">vPop r15</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-1-1"><span class="nav-number">3.1.30.</span> <span class="nav-text">vPush 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-15"><span class="nav-number">3.1.31.</span> <span class="nav-text">vPush 15</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vAdd-dword-ptr-ds-v-esp-0x4-R15"><span class="nav-number">3.1.32.</span> <span class="nav-text">vAdd dword ptr ds:[v_esp+0x4],R15</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r7"><span class="nav-number">3.1.33.</span> <span class="nav-text">vPop r7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r4-1"><span class="nav-number">3.1.34.</span> <span class="nav-text">vPop r4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-r4"><span class="nav-number">3.1.35.</span> <span class="nav-text">vPush r4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-R0-0x0019FF2C"><span class="nav-number">3.1.36.</span> <span class="nav-text">vPush R0(0x0019FF2C)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-4-0xFFFFFFFC-2"><span class="nav-number">3.1.37.</span> <span class="nav-text">vPush -4(0xFFFFFFFC)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%8F%98%E9%87%8Fa%E7%9A%84%E5%9C%B0%E5%9D%80-ebp-4-2"><span class="nav-number">3.1.38.</span> <span class="nav-text">计算变量a的地址,ebp-4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r12-2"><span class="nav-number">3.1.39.</span> <span class="nav-text">vPop r12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%8A%E8%AE%A1%E7%AE%97%E7%9A%84%E7%BB%93%E6%9E%9C%E5%AD%98%E5%9B%9E%E5%8F%98%E9%87%8Fa"><span class="nav-number">3.1.40.</span> <span class="nav-text">把计算的结果存回变量a</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-R0-0x0019FF2C-1"><span class="nav-number">3.1.41.</span> <span class="nav-text">vPush R0(0x0019FF2C)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-4-0xFFFFFFFC-3"><span class="nav-number">3.1.42.</span> <span class="nav-text">vPush -4(0xFFFFFFFC)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%8F%98%E9%87%8Fa%E7%9A%84%E5%9C%B0%E5%9D%80-ebp-4-3"><span class="nav-number">3.1.43.</span> <span class="nav-text">计算变量a的地址,ebp-4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r15-2"><span class="nav-number">3.1.44.</span> <span class="nav-text">vPop r15</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%8A%E5%8F%98%E9%87%8Fa%E7%9A%84%E5%80%BC%E5%AD%98%E6%94%BE%E6%A0%88%E9%A1%B6-1"><span class="nav-number">3.1.45.</span> <span class="nav-text">把变量a的值存放栈顶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPop-r12-3"><span class="nav-number">3.1.46.</span> <span class="nav-text">vPop r12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-R12"><span class="nav-number">3.1.47.</span> <span class="nav-text">vPush R12</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-4020FCh"><span class="nav-number">3.1.48.</span> <span class="nav-text">vPush 4020FCh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-VMEntry"><span class="nav-number">3.1.49.</span> <span class="nav-text">vPush VMEntry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-printf"><span class="nav-number">3.1.50.</span> <span class="nav-text">vPush printf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-R4-2"><span class="nav-number">3.1.51.</span> <span class="nav-text">vPush R4(2)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-R5-2"><span class="nav-number">3.1.52.</span> <span class="nav-text">vPush R5(2)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush"><span class="nav-number">3.1.53.</span> <span class="nav-text">vPush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-1"><span class="nav-number">3.1.54.</span> <span class="nav-text">vPush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-2"><span class="nav-number">3.1.55.</span> <span class="nav-text">vPush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-3"><span class="nav-number">3.1.56.</span> <span class="nav-text">vPush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-4"><span class="nav-number">3.1.57.</span> <span class="nav-text">vPush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vPush-5"><span class="nav-number">3.1.58.</span> <span class="nav-text">vPush</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VMExit"><span class="nav-number">3.1.59.</span> <span class="nav-text">VMExit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E9%98%B2%E4%BE%A7%E6%BC%8F%E7%94%A8%E8%8B%8F%E8%8F%B2"><span class="nav-number">3.2.</span> <span class="nav-text">2、防侧漏用苏菲</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VMP%E5%A0%86%E6%A0%88%E6%A3%80%E6%9F%A5"><span class="nav-number">3.2.1.</span> <span class="nav-text">VMP堆栈检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E7%AE%80%E5%8D%95%E6%8F%90%E5%87%A0%E5%8F%A5"><span class="nav-number">3.3.</span> <span class="nav-text">3、简单提几句</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E7%9C%9F%E7%90%86%E5%8F%AA%E5%9C%A8%E5%A4%A7%E7%82%AE%E5%B0%84%E7%A8%8B%E4%B9%8B%E5%86%85"><span class="nav-number">4.</span> <span class="nav-text">四、真理只在大炮射程之内</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9FVMP%E6%8C%87%E4%BB%A4"><span class="nav-number">4.0.1.</span> <span class="nav-text">模拟VMP指令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%B2%BE%E5%87%86%E5%B0%84%E5%87%BB"><span class="nav-number">5.</span> <span class="nav-text">五、精准射击</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">PlaneJun</p>
  <div class="site-description" itemprop="description">This is PlaneJun‘s Blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.planejun.cn/2023/01/05/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="PlaneJun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PlaneJun'Blog">
      <meta itemprop="description" content="This is PlaneJun‘s Blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="VMProtect分析-虚拟化流程 | PlaneJun'Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          VMProtect分析-虚拟化流程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-05 15:28:00" itemprop="dateCreated datePublished" datetime="2023-01-05T15:28:00+08:00">2023-01-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-04-21 21:23:05" itemprop="dateModified" datetime="2024-04-21T21:23:05+08:00">2024-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Anti/" itemprop="url" rel="index"><span itemprop="name">Anti</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="一、没有大炮我们自己造"><a href="#一、没有大炮我们自己造" class="headerlink" title="一、没有大炮我们自己造"></a>一、没有大炮我们自己造</h1><p>首先编写一个简单的程序。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">	a = a + <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后给程序添加vmp保护壳，这里选择的VMP版本为<code>v3.5.0</code>。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160101521.png" alt="image-20230105160101521"></p>
<p>保护的函数为main函数，编译类型修改为虚拟。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160113820.png" alt="image-20230105160113820"></p>
<p>并且关闭一系列保护。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160125791.png" alt="image-20230105160125791"></p>
<p>编译完成后，可看到程序体积有一个翻倍增加。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160139363.png" alt="image-20230105160139363"></p>
<h1 id="二、只能拉一点点"><a href="#二、只能拉一点点" class="headerlink" title="二、只能拉一点点"></a>二、只能拉一点点</h1><p>首先对原程序的汇编进行一个简单查看，用vs在main函数中打下断点运行后，查看反汇编窗口。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160153886.png" alt="image-20230105160153886"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">00401040 55                   push        ebp  						;ebp=0x19ff74</span><br><span class="line">00401041 8B EC                mov         ebp,esp  					;ebp=0x19FF2C</span><br><span class="line">00401043 51                   push        ecx  						;ecx=0x0</span><br><span class="line">00401044 C7 45 FC 01 00 00 00 mov         dword ptr [ebp-4],1  		;ebp-4=0x19FF28	&#123; int a = 1; &#125;</span><br><span class="line">0040104B 8B 45 FC             mov         eax,dword ptr [ebp-4]  	;eax=0x1</span><br><span class="line">0040104E 83 C0 01             add         eax,1  					;eax=0x2</span><br><span class="line">00401051 89 45 FC             mov         dword ptr [ebp-4],eax  	;ebp-4=0x19FF28	&#123; a = a + 1; &#125;</span><br><span class="line">00401054 8B 4D FC             mov         ecx,dword ptr [ebp-4]  	;ecx=0x2</span><br><span class="line">00401057 51                   push        ecx  						</span><br><span class="line">00401058 68 FC 20 40 00       push        4020FCh  					;&quot;%d\n&quot;</span><br><span class="line">0040105D E8 0E 00 00 00       call        00401070  				;&#123; printf(&quot;%d\n&quot;,a); &#125;</span><br><span class="line">00401062 83 C4 08             add         esp,8  </span><br><span class="line">00401065 33 C0                xor         eax,eax  </span><br><span class="line">00401067 8B E5                mov         esp,ebp  </span><br><span class="line">00401069 5D                   pop         ebp  </span><br><span class="line">0040106A C3                   ret </span><br></pre></td></tr></table></figure>

<p>经过对vmp的分析，可知vmp会将一条代码指令进行拆分后以push和pop命令进行实现，其中push和pop为vmp自实现的函数，这种被vmp自实现用来代替原有指令的函数叫做<code>handler</code>;解密字节码并跳转到对应的handler，这个过程叫做<code>dispatch</code>.例如mov ebp,esp的执行在vmp下会被修改为如下代码：</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160206575.png" alt="image-20230105160206575"></p>
<p>并且vmp会对通用寄存器有自己的解释。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EAX:通用寄存器</span><br><span class="line">EDX:通用寄存器</span><br><span class="line">ECX:通用寄存器</span><br><span class="line">EDI:opcode</span><br><span class="line">ESP:虚拟机的栈顶,v_esp</span><br><span class="line">ESI:实际堆栈</span><br><span class="line">EBP:虚拟机的执行地址,v_eip</span><br><span class="line">EBX:滚动key</span><br></pre></td></tr></table></figure>

<p>同时也有定义了自己的寄存器，用来存放一些临时数据。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">vm_context</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> R0;	<span class="comment">//0x00</span></span><br><span class="line">	<span class="type">uint32_t</span> R1;	<span class="comment">//0x04</span></span><br><span class="line">	<span class="type">uint32_t</span> R2;	<span class="comment">//0x08</span></span><br><span class="line">	<span class="type">uint32_t</span> R3;	<span class="comment">//0x0C</span></span><br><span class="line">	<span class="type">uint32_t</span> R4;	<span class="comment">//0x10</span></span><br><span class="line">	<span class="type">uint32_t</span> R5;	<span class="comment">//0x14</span></span><br><span class="line">	<span class="type">uint32_t</span> R6;	<span class="comment">//0x18</span></span><br><span class="line">	<span class="type">uint32_t</span> R7;	<span class="comment">//0x1C</span></span><br><span class="line">	<span class="type">uint32_t</span> R8;	<span class="comment">//0x20</span></span><br><span class="line">	<span class="type">uint32_t</span> R9;	<span class="comment">//0x24</span></span><br><span class="line">	<span class="type">uint32_t</span> R10;	<span class="comment">//0x28</span></span><br><span class="line">	<span class="type">uint32_t</span> R11;	<span class="comment">//0x2C</span></span><br><span class="line">	<span class="type">uint32_t</span> R12;	<span class="comment">//0x30</span></span><br><span class="line">	<span class="type">uint32_t</span> R13;	<span class="comment">//0x34</span></span><br><span class="line">	<span class="type">uint32_t</span> R14;	<span class="comment">//0x38</span></span><br><span class="line">	<span class="type">uint32_t</span> R15;	<span class="comment">//0x3C</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三、时间会告诉你答案"><a href="#三、时间会告诉你答案" class="headerlink" title="三、时间会告诉你答案"></a>三、时间会告诉你答案</h1><p>把加了vmp壳的程序拖入OD，能看到属于VMP的入口点。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105160031408.png" alt="image-20230105160031408"></p>
<p>其中push的内容为被加密了的<code>opcode</code>，opcode存放着的是所有的handler地址和一些操作寄存器的数据。</p>
<h2 id="1、指令分析"><a href="#1、指令分析" class="headerlink" title="1、指令分析"></a>1、指令分析</h2><p>下列所有的代码均为手工取出虚拟化后的代码，并且所有加了v或者v_前缀的内容均值的是vmp自定义的数据。由于vmp在执行函数时会退出虚拟机，函数执行完毕后重新进入虚拟机，因此流程只跟踪到执行printf函数完毕。</p>
<hr>
<h3 id="VMEntry"><a href="#VMEntry" class="headerlink" title="VMEntry"></a>VMEntry</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00475751    68 C3365BBC     push 0xBC5B36C3</span><br><span class="line">00475756    E8 BE1FFAFF     call test1_vm.00417719</span><br></pre></td></tr></table></figure>

<h3 id="VMInit"><a href="#VMInit" class="headerlink" title="VMInit"></a>VMInit</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">00417719    50              push eax                                 ; 保存堆栈</span><br><span class="line">00417720    51              push ecx</span><br><span class="line">00417721    9C              pushfd</span><br><span class="line">00417724    53              push ebx</span><br><span class="line">00417727    56              push esi</span><br><span class="line">0041772E    57              push edi</span><br><span class="line">00417734    52              push edx</span><br><span class="line">0041773D    55              push ebp</span><br><span class="line">00417742    BA 00000000     mov edx,0x0</span><br><span class="line">00417747    52              push edx</span><br><span class="line">0041774A    8B7C24 28       mov edi,dword ptr ss:[esp+0x28]         ;0xBC5B36C3获取外层push的参数</span><br><span class="line">00417756    4F              dec edi                                 ;开始解密参数</span><br><span class="line">0041775C    81F7 5442907B   xor edi,0x7B904254</span><br><span class="line">0041776F    F7D7            not edi</span><br><span class="line">0041777B    F7DF            neg edi</span><br><span class="line">00417781    F7D7            not edi</span><br><span class="line">0041778A    81EF 98071636   sub edi,0x36160798</span><br><span class="line">00417797    C1CF 03         ror edi,0x3</span><br><span class="line">004177A2    8D3C17          lea edi,dword ptr ds:[edi+edx]			;EDI=v_eip,内容以opcode形式存放</span><br><span class="line">004177A5    8BF4            mov esi,esp								;保存原始esp</span><br><span class="line">004177A7    81EC C0000000   sub esp,0xC0							;开辟新堆栈,vm_context</span><br><span class="line">004177AD    8BDF            mov ebx,edi								;初始化滚动Key</span><br><span class="line">004177B6    B8 00000000     mov eax,0x0</span><br><span class="line">004177C2    2BD8            sub ebx,eax                              </span><br><span class="line">004177CE    8D2D CE774100   lea ebp,dword ptr ds:[0x4177CE]			;获取虚拟机代码的起始地址</span><br><span class="line">004177D7    8B17            mov edx,dword ptr ds:[edi]				;读取opcode</span><br><span class="line">004177DA    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0043DC1F    33D3            xor edx,ebx         					;解密                     </span><br><span class="line">0043DC26    F7DA            neg edx</span><br><span class="line">0043DC29    D1CA            ror edx,1</span><br><span class="line">00469F4B    4A              dec edx</span><br><span class="line">00469F4C    81F2 88622457   xor edx,0x57246288</span><br><span class="line">00469F57    81EA B426A803   sub edx,0x3A826B4</span><br><span class="line">00469F63    0FCA            bswap edx</span><br><span class="line">00469F66    81F2 F21FD256   xor edx,0x56D21FF2</span><br><span class="line">004263AF    C1CA 03         ror edx,0x3</span><br><span class="line">004263B6    33DA            xor ebx,edx								;更新滚动key</span><br><span class="line">004263B8    03EA            add ebp,edx								;计算出handler地址</span><br><span class="line">004263BA  ^ FFE5            jmp ebp                                 ;test1_vm.004343B9</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r10"><a href="#vPop-r10" class="headerlink" title="vPop r10"></a>vPop r10</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">004343B9    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">004343C4    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">004343C7    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">004343CD    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">004343CF    04 95           add al,0x95</span><br><span class="line">004343D1    F6D8            neg al</span><br><span class="line">0040ACDA    FEC0            inc al</span><br><span class="line">0040ACDE    34 28           xor al,0x28								</span><br><span class="line">0040ACEB    32D8            xor bl,al								;更新滚动key</span><br><span class="line">0040ACEF    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x28</span><br><span class="line">0040ACF5    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">0040ACF8    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0040AD03    33CB            xor ecx,ebx                         	;解密读取到的4字节     </span><br><span class="line">0047679A    C1C9 02         ror ecx,0x2</span><br><span class="line">0047679D    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00448CC5    49              dec ecx</span><br><span class="line">00448CC6    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00448CCD    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">00448CD3    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">00448CDA    03E9            add ebp,ecx</span><br><span class="line">00449A6E    55              push ebp                                ;压栈下一个handler地址后跳转</span><br><span class="line">00449A6F    C3              retn									;0x46FF2C</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r12"><a href="#vPop-r12" class="headerlink" title="vPop r12"></a>vPop r12</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0046FF2C    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">0046FF2E    8DB6 04000000   lea esi,dword ptr ds:[esi+0x4]			;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">0046FF37    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0046FF3A    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]			;跳过读取的字节</span><br><span class="line">0046FF48    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0046FF53    04 95           add al,0x95</span><br><span class="line">00446B15    F6D8            neg al</span><br><span class="line">00454B5C    FEC0            inc al</span><br><span class="line">00454B61    34 28           xor al,0x28								</span><br><span class="line">00454B64    32D8            xor bl,al								;更新滚动key</span><br><span class="line">00454B66    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x30</span><br><span class="line">00454B6C    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00454B72    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">00454B7A    33CB            xor ecx,ebx                             ;解密读取到的4字节 </span><br><span class="line">00454B7C    C1C9 02         ror ecx,0x2</span><br><span class="line">00454B7F    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00422059    49              dec ecx</span><br><span class="line">0042205D    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00422065    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">0042206B    33D9            xor ebx,ecx</span><br><span class="line">0042206D    03E9            add ebp,ecx								;更新滚动key</span><br><span class="line">00409147   /FFE5            jmp ebp                                 ;0x00453841</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r8"><a href="#vPop-r8" class="headerlink" title="vPop r8"></a>vPop r8</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">00453841    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">00453846    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">00453854    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">00453857    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">00453866    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0045386E    04 95           add al,0x95</span><br><span class="line">00453870    F6D8            neg al</span><br><span class="line">00458E65    FEC0            inc al</span><br><span class="line">00458E6B    34 28           xor al,0x28</span><br><span class="line">00458E6D    32D8            xor bl,al								;更新滚动key</span><br><span class="line">00458E6F    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x20</span><br><span class="line">00458E7C    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00479B0C    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0041B623    33CB            xor ecx,ebx</span><br><span class="line">00470224    C1C9 02         ror ecx,0x2</span><br><span class="line">00470227    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">004452FB    49              dec ecx</span><br><span class="line">004452FC    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00445305    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">0044530B    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">0044530D    03E9            add ebp,ecx	</span><br><span class="line">0043AD66    55              push ebp                                 </span><br><span class="line">0043AD67    C3              retn									;0x00430521</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r6"><a href="#vPop-r6" class="headerlink" title="vPop r6"></a>vPop r6</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00430521    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">00430523    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">00430529    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">004552EE    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">004552F4    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">004552F9    04 95           add al,0x95</span><br><span class="line">004552FB    F6D8            neg al</span><br><span class="line">004552FD    FEC0            inc al</span><br><span class="line">00455303    34 28           xor al,0x28</span><br><span class="line">00455309    32D8            xor bl,al								;更新滚动key</span><br><span class="line">0045530C    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x18</span><br><span class="line">00455311    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00455313    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0045531F    33CB            xor ecx,ebx                             </span><br><span class="line">00455324    C1C9 02         ror ecx,0x2</span><br><span class="line">0045532B    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00455331    49              dec ecx</span><br><span class="line">00455332    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00455339    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">00455345    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">00455347    03E9            add ebp,ecx</span><br><span class="line">004781EB  ^\FFE5            jmp ebp                                 ;0x0043BD4C</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r3"><a href="#vPop-r3" class="headerlink" title="vPop r3"></a>vPop r3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0043BD4C    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">0043BD55    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">0043BD5B    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0043BD66    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]			;跳过读取的字节</span><br><span class="line">0043BD72    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0043BD74    04 95           add al,0x95</span><br><span class="line">0043BD7A    F6D8            neg al</span><br><span class="line">00479730    FEC0            inc al</span><br><span class="line">00424206    34 28           xor al,0x28</span><br><span class="line">00424208    32D8            xor bl,al								;更新滚动key</span><br><span class="line">0042420C    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0xC</span><br><span class="line">0042420F    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00424211    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">00424217    33CB            xor ecx,ebx                            </span><br><span class="line">0043796F    C1C9 02         ror ecx,0x2</span><br><span class="line">0041F44A    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">004104C7    49              dec ecx</span><br><span class="line">004104C8    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">004104CE    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">004104D5    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">004104D7    03E9            add ebp,ecx</span><br><span class="line">004536AD    55              push ebp                               </span><br><span class="line">004536AE    C3              retn									;0x0045E179</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r5"><a href="#vPop-r5" class="headerlink" title="vPop r5"></a>vPop r5</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0045E179    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">0045E181    8DB6 04000000   lea esi,dword ptr ds:[esi+0x4]			;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">0045E187    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0045E18A    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">0045E193    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0045E197    04 95           add al,0x95</span><br><span class="line">0045E199    F6D8            neg al</span><br><span class="line">0047C824    FEC0            inc al</span><br><span class="line">00459FC2    34 28           xor al,0x28</span><br><span class="line">00459FC8    32D8            xor bl,al								;更新滚动key</span><br><span class="line">00459FCC    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x14</span><br><span class="line">00459FCF    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00459FD1    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">00459FD7    33CB            xor ecx,ebx                             </span><br><span class="line">00459FD9    C1C9 02         ror ecx,0x2</span><br><span class="line">00459FDC    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00459FE2    49              dec ecx</span><br><span class="line">00459FE3    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00459FEE    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">00459FF4    33D9            xor ebx,ecx</span><br><span class="line">00459FF6    03E9            add ebp,ecx								;更新滚动key</span><br><span class="line">00479CA7  ^\FFE5            jmp ebp                                 ;0x0046D3FB</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r9"><a href="#vPop-r9" class="headerlink" title="vPop r9"></a>vPop r9</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0046D3FB    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">0046D3FD    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">0046D403    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0046D407    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]			;跳过读取的字节</span><br><span class="line">0046D413    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0046D415    04 95           add al,0x95</span><br><span class="line">0046D41B    F6D8            neg al</span><br><span class="line">004264F7    FEC0            inc al</span><br><span class="line">004264F9    34 28           xor al,0x28</span><br><span class="line">004264FC    32D8            xor bl,al								;更新滚动key</span><br><span class="line">00426500    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x24</span><br><span class="line">00426503    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00426508    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">0042650F    33CB            xor ecx,ebx                             </span><br><span class="line">00426512    C1C9 02         ror ecx,0x2</span><br><span class="line">0047CDC0    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00483DE1    49              dec ecx</span><br><span class="line">00483DE8    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00483DF9    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">00483E02    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">00483E0B    03E9            add ebp,ecx</span><br><span class="line">0047FFF9  ^\FFE5            jmp ebp                                 ;0x0046C4CB</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r2"><a href="#vPop-r2" class="headerlink" title="vPop r2"></a>vPop r2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0046C4CB    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">0046C4CD    8DB6 04000000   lea esi,dword ptr ds:[esi+0x4]			;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">0046C4D7    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0046C4DD    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">0046C4E3    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0046C4EA    04 95           add al,0x95</span><br><span class="line">00445326    F6D8            neg al</span><br><span class="line">00445328    FEC0            inc al</span><br><span class="line">0044532B    34 28           xor al,0x28</span><br><span class="line">00445332    32D8            xor bl,al								;更新滚动key</span><br><span class="line">00445334    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x8</span><br><span class="line">0044533F    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00445346    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0044534C    33CB            xor ecx,ebx</span><br><span class="line">0044534E    C1C9 02         ror ecx,0x2</span><br><span class="line">00445351    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00478CFC    49              dec ecx</span><br><span class="line">00478CFD    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">0046EDD9    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">0046EDE5    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">0046EDEA    03E9            add ebp,ecx								</span><br><span class="line">0043713E    55              push ebp                                 </span><br><span class="line">0043713F    C3              retn									;0x00474E9C</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r4"><a href="#vPop-r4" class="headerlink" title="vPop r4"></a>vPop r4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">00474E9C    8B0E            mov ecx,dword ptr ds:[esi]              ;读取原始esp</span><br><span class="line">00474EA0    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">00474EAB    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">00474EAE    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">00474EB6    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">00445C08    04 95           add al,0x95</span><br><span class="line">00445C0B    F6D8            neg al</span><br><span class="line">00483885    FEC0            inc al</span><br><span class="line">00483887    34 28           xor al,0x28</span><br><span class="line">0048388A    32D8            xor bl,al								;更新滚动key</span><br><span class="line">00483890    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x10</span><br><span class="line">00483895    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">004376C4    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">004745C8    33CB            xor ecx,ebx</span><br><span class="line">0044E82C    C1C9 02         ror ecx,0x2</span><br><span class="line">0044E82F    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">004072B1    49              dec ecx</span><br><span class="line">004072B5    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">004072BB    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">004072C5    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">004072C9    03E9            add ebp,ecx</span><br><span class="line">00471DC6    55              push ebp                             </span><br><span class="line">00471DC7    C3              retn									;0x00476E65</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r0"><a href="#vPop-r0" class="headerlink" title="vPop r0"></a>vPop r0</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00476E65    8B0E            mov ecx,dword ptr ds:[esi]              ;读取原始esp</span><br><span class="line">00476E67    8DB6 04000000   lea esi,dword ptr ds:[esi+0x4]			;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">00476E75    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0047D681    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">0047D687    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0047D689    04 95           add al,0x95</span><br><span class="line">0047D694    F6D8            neg al</span><br><span class="line">0047C676    FEC0            inc al</span><br><span class="line">0047C67B    34 28           xor al,0x28</span><br><span class="line">0047C67F    32D8            xor bl,al								;更新滚动key</span><br><span class="line">0047C681    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x0</span><br><span class="line">0047C68C    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">0047C68E    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0046C29E    33CB            xor ecx,ebx</span><br><span class="line">0046C2A1    C1C9 02         ror ecx,0x2</span><br><span class="line">0046C2A8    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">0044B630    49              dec ecx</span><br><span class="line">0044B631    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">0044B637    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">0044B648    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">0044B64D    03E9            add ebp,ecx</span><br><span class="line">00422D63   /FFE5            jmp ebp                                 ;0x00451F05</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r15"><a href="#vPop-r15" class="headerlink" title="vPop r15"></a>vPop r15</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00451F05    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp</span><br><span class="line">00451F0A    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">00451F15    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">00451F18    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">00451F1E    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">00451F20    04 95           add al,0x95</span><br><span class="line">00451F25    F6D8            neg al</span><br><span class="line">004718C3    FEC0            inc al</span><br><span class="line">004718C5    34 28           xor al,0x28</span><br><span class="line">004718CA    32D8            xor bl,al								;更新滚动key</span><br><span class="line">004718CC    890C04          mov dword ptr ss:[esp+eax],ecx			;eax=0x3C</span><br><span class="line">004718CF    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">004718D1    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">004718D7    33CB            xor ecx,ebx                             </span><br><span class="line">004718D9    C1C9 02         ror ecx,0x2</span><br><span class="line">004718DC    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">004407D7    49              dec ecx</span><br><span class="line">004407D8    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">004407E3    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">004407EE    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">004407F0    03E9            add ebp,ecx</span><br><span class="line">004407F2    FFE5            jmp ebp                                 ;0x0045325C</span><br></pre></td></tr></table></figure>

<h3 id="vPush-ebp-0x19ff74"><a href="#vPush-ebp-0x19ff74" class="headerlink" title="vPush ebp(0x19ff74)"></a>vPush ebp(0x19ff74)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0045325C    0FB60F          movzx ecx,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">00453267    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]			;跳过读取的字节</span><br><span class="line">0045326D    32CB            xor cl,bl								;解密读取到的字节</span><br><span class="line">0045326F    F6D9            neg cl</span><br><span class="line">00453272    80F1 0E         xor cl,0xE</span><br><span class="line">00453278    80E9 21         sub cl,0x21</span><br><span class="line">00453282    F6D9            neg cl</span><br><span class="line">0045328E    80F1 E2         xor cl,0xE2</span><br><span class="line">00453296    32D9            xor bl,cl								;更新滚动key</span><br><span class="line">004532A5    8B140C          mov edx,dword ptr ss:[esp+ecx]			;从v_esp中读取数据到edx</span><br><span class="line">004532A8    81EE 04000000   sub esi,0x4								;原始esp-0x4</span><br><span class="line">004532B4    8916            mov dword ptr ds:[esi],edx				;edx=0x0019FF74,把读到的数据存到esp中,此处两句指令对应 push edx</span><br><span class="line">004532BD    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">004532C4    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">0041B011    33CB            xor ecx,ebx                             ;解密读取到的字节</span><br><span class="line">0041B018    81E9 8C1F9123   sub ecx,0x23911F8C</span><br><span class="line">0041B01E    D1C9            ror ecx,1</span><br><span class="line">004692ED    49              dec ecx</span><br><span class="line">004692F3    F7D1            not ecx</span><br><span class="line">004692FA    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">004692FC    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]			;edx=v_esp+0x60</span><br><span class="line">0046263A    3BF2            cmp esi,edx								;原始esp与edx比较</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C					;如果原始esp&gt;edx就正常返回,防止原始esp内容覆盖了vm_context</span><br><span class="line">00481408    8BC4            mov eax,esp								;将v_esp传给eax</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]			;把原始esp上台0x80大小,然后把地址传给edx</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4							</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx								;把新的堆栈地址传给v_esp</span><br><span class="line">0046734B    57              push edi                               </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax								</span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi] ;把原来v_esp的内容拷贝到新的v_esp</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                  </span><br><span class="line">00458194    5F              pop edi                                  </span><br><span class="line">0044BD0C    55              push ebp                                 </span><br><span class="line">0044BD0D    C3              retn									;0x004786D0	</span><br></pre></td></tr></table></figure>

<h3 id="vPush-esp-0x0019FF2C"><a href="#vPush-esp-0x0019FF2C" class="headerlink" title="vPush esp(0x0019FF2C)"></a>vPush esp(0x0019FF2C)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">004786D0    8BC6            mov eax,esi								;原始esp传给eax,当前esp保存的是变量a的地址</span><br><span class="line">004786D8    81EE 04000000   sub esi,0x4								;原始esp-0x4</span><br><span class="line">004786DE    8906            mov dword ptr ds:[esi],eax				;把eax存到原始esp中,此处两句指令对应 push eax</span><br><span class="line">004786E6    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">004786E8    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">004786EE    33CB            xor ecx,ebx                             ;解密读取到的字节                </span><br><span class="line">0040AA81    49              dec ecx</span><br><span class="line">0040AA82    D1C9            ror ecx,1</span><br><span class="line">0040AA8C    F7D9            neg ecx</span><br><span class="line">0040AA95    81C1 0C094E44   add ecx,0x444E090C</span><br><span class="line">0040AA9C    0FC9            bswap ecx</span><br><span class="line">0040AA9F    C1C9 02         ror ecx,0x2                                               </span><br><span class="line">0040AAAA    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">0040AAAC    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]			;edx=v_esp+0x60</span><br><span class="line">0046263A    3BF2            cmp esi,edx								;原始esp与edx比较</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C					;如果原始esp&gt;edx就正常返回,防止原始esp内容覆盖了vm_context</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]			;把原始esp上台0x80大小,然后把地址传给edx</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx								;把新的堆栈地址传给v_esp</span><br><span class="line">0046734B    57              push edi                                                    </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                         </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]    ;把原来v_esp的内容拷贝到新的v_esp                                       </span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                                    </span><br><span class="line">00458194    5F              pop edi                                                       </span><br><span class="line">0044BD0C    55              push ebp                                                     </span><br><span class="line">0044BD0D    C3              retn									;0x004343B9</span><br></pre></td></tr></table></figure>

<h3 id="vPop-ebp-0x19FF2C"><a href="#vPop-ebp-0x19FF2C" class="headerlink" title="vPop ebp(0x19FF2C)"></a>vPop ebp(0x19FF2C)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">004343B9    8B0E            mov ecx,dword ptr ds:[esi]				;读取原始esp,ecx=保存了变量a的地址</span><br><span class="line">004343BE    81C6 04000000   add esi,0x4								;原始esp+0x4, 此处两句指令对应 pop ecx</span><br><span class="line">004343C4    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">004343C7    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">004343CD    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">004343CF    04 95           add al,0x95</span><br><span class="line">004343D1    F6D8            neg al</span><br><span class="line">0040ACDA    FEC0            inc al</span><br><span class="line">0040ACDE    34 28           xor al,0x28</span><br><span class="line">0040ACEB    32D8            xor bl,al								;更新滚动key</span><br><span class="line">0040ACEF    890C04          mov dword ptr ss:[esp+eax],ecx			;ecx=0x0019FF2C</span><br><span class="line">0040ACF5    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">0040ACF8    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0040AD03    33CB            xor ecx,ebx</span><br><span class="line">0047679A    C1C9 02         ror ecx,0x2</span><br><span class="line">0047679D    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00448CC5    49              dec ecx</span><br><span class="line">00448CC6    81F1 F25E4677   xor ecx,0x77465EF2							</span><br><span class="line">00448CCD    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">00448CD3    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">00448CDA    03E9            add ebp,ecx</span><br><span class="line">00449A6E    55              push ebp                                                    </span><br><span class="line">00449A6F    C3              retn									;0x0045225C</span><br></pre></td></tr></table></figure>

<h3 id="vPush-ecx-0x0"><a href="#vPush-ecx-0x0" class="headerlink" title="vPush ecx(0x0)"></a>vPush ecx(0x0)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0045225C    0FB60F          movzx ecx,byte ptr ds:[edi]				;读取opcode的第一个字节                                                 ; test1_vm.0043D0C3</span><br><span class="line">00452265    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]			;跳过读取的字节</span><br><span class="line">0045226B    32CB            xor cl,bl								;解密读取到的字节</span><br><span class="line">0045226D    F6D9            neg cl</span><br><span class="line">00452273    80F1 0E         xor cl,0xE</span><br><span class="line">0045227D    80E9 21         sub cl,0x21</span><br><span class="line">0045228B    F6D9            neg cl</span><br><span class="line">0045228D    80F1 E2         xor cl,0xE2</span><br><span class="line">00452292    32D9            xor bl,cl								;更新滚动key</span><br><span class="line">00452297    8B140C          mov edx,dword ptr ss:[esp+ecx]			;从vm_stack读取数据</span><br><span class="line">0045229A    81EE 04000000   sub esi,0x4</span><br><span class="line">004522AE    8916            mov dword ptr ds:[esi],edx				;push edx</span><br><span class="line">004522B0    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">004522B3    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">004522BE    33CB            xor ecx,ebx</span><br><span class="line">0045676E    81E9 8C1F9123   sub ecx,0x23911F8C</span><br><span class="line">00456776    D1C9            ror ecx,1</span><br><span class="line">00463F87    49              dec ecx</span><br><span class="line">00463F8C    F7D1            not ecx</span><br><span class="line">0041EFFB    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">0041F001    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">00445778    3BF2            cmp esi,edx								;检查堆栈</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                      ; test1_vm.0043D0C3</span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                                ; test1_vm.0043D0C3</span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                       ; 0019FF2C                                                  ; test1_vm.0043D0C3</span><br><span class="line">00458194    5F              pop edi                                                       ; 0019FF2C</span><br><span class="line">0044BD0C    55              push ebp                                                      ; test1_vm.0045225C</span><br><span class="line">0044BD0D    C3              retn									;0047E64B</span><br></pre></td></tr></table></figure>

<h3 id="vPush-esp"><a href="#vPush-esp" class="headerlink" title="vPush esp"></a>vPush esp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">0047E64B    0FB60F          movzx ecx,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">0047E65A    81C7 01000000   add edi,0x1								;跳过读取的字节 </span><br><span class="line">0047E661    32CB            xor cl,bl								;解密读取到的字节</span><br><span class="line">0047E663    F6D9            neg cl</span><br><span class="line">0047E66B    80F1 0E         xor cl,0xE</span><br><span class="line">0047E670    80E9 21         sub cl,0x21</span><br><span class="line">0047E673    80C2 96         add dl,0x96</span><br><span class="line">0047E681    F6D9            neg cl</span><br><span class="line">0047E683    80F1 E2         xor cl,0xE2</span><br><span class="line">0047E686    32D9            xor bl,cl								;更新滚动key</span><br><span class="line">0047E68E    8B140C          mov edx,dword ptr ss:[esp+ecx]			</span><br><span class="line">0047E697    81EE 04000000   sub esi,0x4</span><br><span class="line">0047E6A2    8916            mov dword ptr ds:[esi],edx				;push edx</span><br><span class="line">0047E6AC    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">0047E6B4    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">0047E6BF    33CB            xor ecx,ebx</span><br><span class="line">0047E6C8    81E9 8C1F9123   sub ecx,0x23911F8C</span><br><span class="line">0047E6CF    D1C9            ror ecx,1</span><br><span class="line">0044CE2D    49              dec ecx</span><br><span class="line">0044CE2E    F7D1            not ecx</span><br><span class="line">0044CE30    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">0044CE33    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx								;堆栈检查</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                     </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                               </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                                    </span><br><span class="line">00458194    5F              pop edi                                                       </span><br><span class="line">0044BD0C    55              push ebp                                                   </span><br><span class="line">0044BD0D    C3              retn									;0x00454C04</span><br></pre></td></tr></table></figure>

<h3 id="vPush-1"><a href="#vPush-1" class="headerlink" title="vPush 1"></a>vPush 1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">00454C04    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">004131C1    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">004131C7    33CB            xor ecx,ebx                             ;解密读取到的字节            </span><br><span class="line">004131C9    41              inc ecx                                               </span><br><span class="line">004503B4    F7D9            neg ecx</span><br><span class="line">00455A33    41              inc ecx</span><br><span class="line">00455A34    81F1 66772375   xor ecx,0x75237766</span><br><span class="line">00455A3B    33D9            xor ebx,ecx</span><br><span class="line">00455A40    81EE 04000000   sub esi,0x4</span><br><span class="line">00447C2B    890E            mov dword ptr ds:[esi],ecx				;push ecx</span><br><span class="line">00447C35    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">00447C37    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">00447C41    33CB            xor ecx,ebx                             ;解密读取到的字节                 </span><br><span class="line">00447C49    F7D9            neg ecx</span><br><span class="line">0041448F    8D89 6233DE7C   lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">00414495    F7D9            neg ecx</span><br><span class="line">00414497    F7D1            not ecx</span><br><span class="line">00414499    33D9            xor ebx,ecx</span><br><span class="line">0041449B    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx								;堆栈检查</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C	</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                   </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                               </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]                                              </span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                          </span><br><span class="line">00458194    5F              pop edi                                                      </span><br><span class="line">0044BD0C    55              push ebp                                                </span><br><span class="line">0044BD0D    C3              retn										;0041043E</span><br></pre></td></tr></table></figure>

<h3 id="vPush-ebp-0x0019FF2C"><a href="#vPush-ebp-0x0019FF2C" class="headerlink" title="vPush ebp(0x0019FF2C)"></a>vPush ebp(0x0019FF2C)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">0041043E    0FB60F          movzx ecx,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">00410443    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]			;跳过读取的字节</span><br><span class="line">0041044E    32CB            xor cl,bl								;解密读取到的字节</span><br><span class="line">00410450    F6D9            neg cl</span><br><span class="line">00410452    80F1 0E         xor cl,0xE</span><br><span class="line">00410460    80E9 21         sub cl,0x21</span><br><span class="line">0041046B    F6D9            neg cl</span><br><span class="line">0041046D    D2D2            rcl dl,cl</span><br><span class="line">0041046F    F6DE            neg dh</span><br><span class="line">00410471    80F1 E2         xor cl,0xE2</span><br><span class="line">00410479    32D9            xor bl,cl								;更新滚动key</span><br><span class="line">0041047D    8B140C          mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">00410480    81EE 04000000   sub esi,0x4</span><br><span class="line">00410489    8916            mov dword ptr ds:[esi],edx				;push edx</span><br><span class="line">00410497    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">0041049E    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]			;递增opcode,跳到下一个opcode</span><br><span class="line">004104A4    33CB            xor ecx,ebx</span><br><span class="line">004104A8    81E9 8C1F9123   sub ecx,0x23911F8C</span><br><span class="line">004104B1    D1C9            ror ecx,1</span><br><span class="line">004104B3    49              dec ecx</span><br><span class="line">00440D59    F7D1            not ecx</span><br><span class="line">00440D5C    33D9            xor ebx,ecx</span><br><span class="line">004251B5    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx								;堆栈检查</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                    </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                              </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                                  </span><br><span class="line">00458194    5F              pop edi                                                   </span><br><span class="line">0044BD0C    55              push ebp                                                  </span><br><span class="line">0044BD0D    C3              retn						;0043E97B</span><br></pre></td></tr></table></figure>

<h3 id="vPush-4-0xFFFFFFFC"><a href="#vPush-4-0xFFFFFFFC" class="headerlink" title="vPush -4(0xFFFFFFFC)"></a>vPush -4(0xFFFFFFFC)</h3><blockquote>
<p>变量a地址相对于ebp的相对偏移</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0043E97B    8B0F            mov ecx,dword ptr ds:[edi]				;从opcode读取4字节</span><br><span class="line">0044140D    81C7 04000000   add edi,0x4								;递增opcode,跳到下一个opcode</span><br><span class="line">00441418    33CB            xor ecx,ebx</span><br><span class="line">0047D18C    41              inc ecx</span><br><span class="line">0047D18D    F7D9            neg ecx</span><br><span class="line">00450AE0    41              inc ecx</span><br><span class="line">00450AE1    81F1 66772375   xor ecx,0x75237766</span><br><span class="line">00450AE7    33D9            xor ebx,ecx								;更新滚动key</span><br><span class="line">00450AEA    8DB6 FCFFFFFF   lea esi,dword ptr ds:[esi-0x4]			</span><br><span class="line">00450AF2    890E            mov dword ptr ds:[esi],ecx				;push ecx</span><br><span class="line">00450AF8    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">00450AFA    81C7 04000000   add edi,0x4</span><br><span class="line">00450B07    33CB            xor ecx,ebx</span><br><span class="line">00450B0C    F7D9            neg ecx</span><br><span class="line">00450B0E    8D89 6233DE7C   lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">00450B17    F7D9            neg ecx</span><br><span class="line">00450B19    F7D1            not ecx</span><br><span class="line">00450B1B    33D9            xor ebx,ecx</span><br><span class="line">00450B1E    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                    </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A32D    0FB7F2          movzx esi,dx</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                            </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C0    0BFB            or edi,ebx</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                            </span><br><span class="line">00458194    5F              pop edi                                                      </span><br><span class="line">0044BD0C    55              push ebp                                                      </span><br><span class="line">0044BD0D    C3              retn								;0040423D</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov eax,dword ptr ds:[v_esp]	;变量a地址相对于ebp的相对偏移</span><br><span class="line">mov edx,dword ptr ds:[v_esp+0x4]</span><br><span class="line">add eax,edx</span><br><span class="line">mov dword ptr ds:[v_esp+0x4],eax</span><br></pre></td></tr></table></figure>

<h3 id="计算变量a的地址-ebp-4"><a href="#计算变量a的地址-ebp-4" class="headerlink" title="计算变量a的地址,ebp-4"></a>计算变量a的地址,ebp-4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0040423D    8B06            mov eax,dword ptr ds:[esi]			;从原始esp读取变量a地址相对于edx的偏移</span><br><span class="line">00404243    8B56 04         mov edx,dword ptr ds:[esi+0x4]		;从原始esp+4 读取ebp</span><br><span class="line">00404248    03C2            add eax,edx							;相加后eax为变量a地址</span><br><span class="line">0044AFE5    8946 04         mov dword ptr ds:[esi+0x4],eax		;eax压入原始esp+4 位置</span><br><span class="line">0044AFED    9C              pushfd</span><br><span class="line">0044AFEE    8F06            pop dword ptr ds:[esi]                                       </span><br><span class="line">0044AFF7    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">0044AFF9    81C7 04000000   add edi,0x4</span><br><span class="line">0044B000    33CB            xor ecx,ebx</span><br><span class="line">004056EF    C1C9 03         ror ecx,0x3</span><br><span class="line">004056F6    F7D1            not ecx</span><br><span class="line">004056F8    81C1 C448053F   add ecx,0x3F0548C4</span><br><span class="line">00405701    81F1 2A55B526   xor ecx,0x26B5552A</span><br><span class="line">00405707    81E9 864A0664   sub ecx,0x64064A86</span><br><span class="line">00405710    33D9            xor ebx,ecx</span><br><span class="line">00405718    03E9            add ebp,ecx</span><br><span class="line">0040571A    55              push ebp                                                    </span><br><span class="line">0040571B    C3              retn								;0046FF2C</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r12-1"><a href="#vPop-r12-1" class="headerlink" title="vPop r12"></a>vPop r12</h3><blockquote>
<p>将偏移弹到R12</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0046FF2C    8B0E            mov ecx,dword ptr ds:[esi]			;从原始esp读取变量a地址相对于edx的偏移</span><br><span class="line">0046FF2E    8DB6 04000000   lea esi,dword ptr ds:[esi+0x4]		;原地esp+4,pop ecx</span><br><span class="line">0046FF37    0FB607          movzx eax,byte ptr ds:[edi]			;读取opcode的第一个字节</span><br><span class="line">0046FF3A    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]		;跳过读取的字节</span><br><span class="line">0046FF48    32C3            xor al,bl							;解密读取到的字节</span><br><span class="line">0046FF53    04 95           add al,0x95</span><br><span class="line">00446B15    F6D8            neg al</span><br><span class="line">00454B5C    FEC0            inc al</span><br><span class="line">00454B61    34 28           xor al,0x28</span><br><span class="line">00454B64    32D8            xor bl,al</span><br><span class="line">00454B66    890C04          mov dword ptr ss:[esp+eax],ecx		;出栈</span><br><span class="line">00454B6C    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">00454B72    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00454B7A    33CB            xor ecx,ebx</span><br><span class="line">00454B7C    C1C9 02         ror ecx,0x2</span><br><span class="line">00454B7F    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00422059    49              dec ecx</span><br><span class="line">0042205D    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00422065    8D89 1A29644A   lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">0042206B    33D9            xor ebx,ecx</span><br><span class="line">0042206D    03E9            add ebp,ecx</span><br><span class="line">00409147   /FFE5            jmp ebp                             ;0041D673  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov 	eax,dword ptr ds:[v_esp]	;变量a地址</span><br><span class="line">mov	edx,dword ptr ds:[v_esp+0x4]	;之前vPush进来的1</span><br><span class="line">mov	dword ptr ds:[eax],edx	;mov         dword ptr [ebp-4],1</span><br></pre></td></tr></table></figure>

<h3 id="mov-dword-ptr-ebp-4-1"><a href="#mov-dword-ptr-ebp-4-1" class="headerlink" title="mov dword ptr [ebp-4],1"></a>mov dword ptr [ebp-4],1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0041D673    8B06            mov eax,dword ptr ds:[esi]			;变量a的地址</span><br><span class="line">0041D67D    8B56 04         mov edx,dword ptr ds:[esi+0x4]		;之前vPush进来的1</span><br><span class="line">0041D688    8DB6 08000000   lea esi,dword ptr ds:[esi+0x8]		;出栈</span><br><span class="line">0046C3DB    36:8910         mov dword ptr ss:[eax],edx			;给变量a赋值,a=1</span><br><span class="line">0046C3DE    8B07            mov eax,dword ptr ds:[edi]</span><br><span class="line">0046C3E0    81C7 04000000   add edi,0x4</span><br><span class="line">0046C3E6    33C3            xor eax,ebx                                                                                             </span><br><span class="line">0041CA25    F7D0            not eax</span><br><span class="line">0041CA28    8D80 39CAABFE   lea eax,dword ptr ds:[eax-0x15435C7]</span><br><span class="line">0041CA31    35 CE111A71     xor eax,0x711A11CE</span><br><span class="line">0041CA3B    8D80 03AE9DB8   lea eax,dword ptr ds:[eax-0x476251FD]</span><br><span class="line">0041CA42    33D8            xor ebx,eax</span><br><span class="line">0041CA45    03E8            add ebp,eax</span><br><span class="line">00483D3B  ^\FFE5            jmp ebp            					;0045BC24 </span><br></pre></td></tr></table></figure>

<h3 id="vPush-4-0xFFFFFFFC-1"><a href="#vPush-4-0xFFFFFFFC-1" class="headerlink" title="vPush -4(0xFFFFFFFC)"></a>vPush -4(0xFFFFFFFC)</h3><blockquote>
<p>变量a地址相对于ebp的相对偏移</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">0045BC24    8B0F            mov ecx,dword ptr ds:[edi]						;从opcode读取4字节</span><br><span class="line">0045BC2C    81C7 04000000   add edi,0x4										;递增opcode,跳到下一个opcode</span><br><span class="line">0045BC33    33CB            xor ecx,ebx                                                   </span><br><span class="line">0046BEC4    41              inc ecx</span><br><span class="line">00431C1F    F7D9            neg ecx</span><br><span class="line">00474669    41              inc ecx</span><br><span class="line">00474672    81F1 66772375   xor ecx,0x75237766</span><br><span class="line">00474678    33D9            xor ebx,ecx										;更新滚动key</span><br><span class="line">0047467C    81EE 04000000   sub esi,0x4</span><br><span class="line">00474684    890E            mov dword ptr ds:[esi],ecx						;push ecx</span><br><span class="line">0047468B    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">0047468D    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00474695    33CB            xor ecx,ebx                                                 </span><br><span class="line">00474697    F7D9            neg ecx</span><br><span class="line">00474699    81C1 6233DE7C   add ecx,0x7CDE3362</span><br><span class="line">0047469F    F7D9            neg ecx</span><br><span class="line">0043D8C9    F7D1            not ecx</span><br><span class="line">0043D8CB    33D9            xor ebx,ecx</span><br><span class="line">00488CC8    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx												;堆栈检查</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                               </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                          </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]                                            </span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                          </span><br><span class="line">00458194    5F              pop edi                                                    </span><br><span class="line">0044BD0C    55              push ebp                                                </span><br><span class="line">0044BD0D    C3              retn						;00435011</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov	eax,dword ptr ds:[v_esp]	;变量a地址相对于ebp的相对偏移</span><br><span class="line">mov	edx,dword ptr ds:[v_esp+0x4]</span><br><span class="line">add	eax,edx</span><br><span class="line">mov	dword ptr ds:[v_esp+0x4],eax</span><br></pre></td></tr></table></figure>

<h3 id="计算变量a的地址-ebp-4-1"><a href="#计算变量a的地址-ebp-4-1" class="headerlink" title="计算变量a的地址,ebp-4"></a>计算变量a的地址,ebp-4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">00435011    8B06            mov eax,dword ptr ds:[esi]				;从原始esp获取变量a地址相对于ebp的相对偏移</span><br><span class="line">0043501B    8B56 04         mov edx,dword ptr ds:[esi+0x4]			;从原始esp+4,获取ebp</span><br><span class="line">00435023    03C2            add eax,edx								;相加得到变量a的地址</span><br><span class="line">00435028    8946 04         mov dword ptr ds:[esi+0x4],eax			;入栈</span><br><span class="line">00435034    9C              pushfd</span><br><span class="line">0043503B    8F06            pop dword ptr ds:[esi]                 	;保存ELF到vm_stack栈顶        	               </span><br><span class="line">00435043    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">00435047    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00435055    33CB            xor ecx,ebx                                                  </span><br><span class="line">00435057    C1C9 03         ror ecx,0x3</span><br><span class="line">0043505A    F7D1            not ecx</span><br><span class="line">0043505D    81C1 C448053F   add ecx,0x3F0548C4</span><br><span class="line">00435065    81F1 2A55B526   xor ecx,0x26B5552A</span><br><span class="line">00435070    8D89 7AB5F99B   lea ecx,dword ptr ds:[ecx-0x64064A86]</span><br><span class="line">0043507D    33D9            xor ebx,ecx</span><br><span class="line">00435082    03E9            add ebp,ecx</span><br><span class="line">0046DD9A  ^\FFE5            jmp ebp          						;0x00453841</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r11"><a href="#vPop-r11" class="headerlink" title="vPop r11"></a>vPop r11</h3><blockquote>
<p>将偏移弹出</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">00453841    8B0E            mov ecx,dword ptr ds:[esi]				;从原始esp读取数据</span><br><span class="line">00453846    81C6 04000000   add esi,0x4</span><br><span class="line">00453854    0FB607          movzx eax,byte ptr ds:[edi]				;读取opcode的第一个字节</span><br><span class="line">00453857    81C7 01000000   add edi,0x1								;跳过读取的字节</span><br><span class="line">00453866    32C3            xor al,bl								;解密读取到的字节</span><br><span class="line">0045386E    04 95           add al,0x95</span><br><span class="line">00453870    F6D8            neg al</span><br><span class="line">00458E65    FEC0            inc al</span><br><span class="line">00458E6B    34 28           xor al,0x28</span><br><span class="line">00458E6D    32D8            xor bl,al</span><br><span class="line">00458E6F    890C04          mov dword ptr ss:[esp+eax],ecx			</span><br><span class="line">00458E7C    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">00479B0C    81C7 04000000   add edi,0x4</span><br><span class="line">0041B623    33CB            xor ecx,ebx                                                   ; test1_vm.00439ED8</span><br><span class="line">00470224    C1C9 02         ror ecx,0x2</span><br><span class="line">00470227    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">004452FB    49              dec ecx</span><br><span class="line">004452FC    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00445305    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">0044530B    33D9            xor ebx,ecx</span><br><span class="line">0044530D    03E9            add ebp,ecx</span><br><span class="line">0043AD66    55              push ebp                                                      ; test1_vm.00453841</span><br><span class="line">0043AD67    C3              retn						;00463862</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov	edx,dword ptr ds:[esi]</span><br><span class="line">mov	eax,dword ptr ss:[edx]</span><br><span class="line">mov	dword ptr ds:[v_esp],eax	;将变量a的值覆盖到esp</span><br></pre></td></tr></table></figure>

<h3 id="把变量a的值存放栈顶"><a href="#把变量a的值存放栈顶" class="headerlink" title="把变量a的值存放栈顶"></a>把变量a的值存放栈顶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00463862    8B16            mov edx,dword ptr ds:[esi]			;从原始esp读取变量a的地址</span><br><span class="line">0046386C    36:8B02         mov eax,dword ptr ss:[edx]			;读取变量a的内容</span><br><span class="line">0046C75B    8906            mov dword ptr ds:[esi],eax			;把内容覆盖到变量a的地址</span><br><span class="line">0046C762    8B07            mov eax,dword ptr ds:[edi]			;从opcode读取4字节</span><br><span class="line">00481FFA    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00482003    33C3            xor eax,ebx                                                  </span><br><span class="line">0048200B    05 84307C17     add eax,0x177C3084</span><br><span class="line">00444EE2    0FC8            bswap eax</span><br><span class="line">00444EE4    40              inc eax                                              </span><br><span class="line">00444EE7    F7D0            not eax</span><br><span class="line">00444EE9    33D8            xor ebx,eax</span><br><span class="line">00444EEB    03E8            add ebp,eax</span><br><span class="line">00442693    55              push ebp                                                    </span><br><span class="line">00442694    C3              retn								;00430521</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将变量a的值弹到寄存器R15中,联合上面几句等价于</span><br><span class="line">mov         eax,dword ptr [ebp-4]</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r15-1"><a href="#vPop-r15-1" class="headerlink" title="vPop r15"></a>vPop r15</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00430521    8B0E            mov ecx,dword ptr ds:[esi]			;取出变量a的值</span><br><span class="line">00430523    81C6 04000000   add esi,0x4</span><br><span class="line">00430529    0FB607          movzx eax,byte ptr ds:[edi]			</span><br><span class="line">004552EE    81C7 01000000   add edi,0x1</span><br><span class="line">004552F4    32C3            xor al,bl</span><br><span class="line">004552F9    04 95           add al,0x95</span><br><span class="line">004552FB    F6D8            neg al</span><br><span class="line">004552FD    FEC0            inc al</span><br><span class="line">00455303    34 28           xor al,0x28</span><br><span class="line">00455309    32D8            xor bl,al</span><br><span class="line">0045530C    890C04          mov dword ptr ss:[esp+eax],ecx</span><br><span class="line">00455311    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">00455313    81C7 04000000   add edi,0x4</span><br><span class="line">0045531F    33CB            xor ecx,ebx</span><br><span class="line">00455324    C1C9 02         ror ecx,0x2</span><br><span class="line">0045532B    81F1 7E7F9C09   xor ecx,0x99C7F7E</span><br><span class="line">00455331    49              dec ecx</span><br><span class="line">00455332    81F1 F25E4677   xor ecx,0x77465EF2</span><br><span class="line">00455339    81C1 1A29644A   add ecx,0x4A64291A</span><br><span class="line">00455345    33D9            xor ebx,ecx</span><br><span class="line">00455347    03E9            add ebp,ecx</span><br><span class="line">004781EB  ^\FFE5            jmp ebp                              ;004693CB</span><br></pre></td></tr></table></figure>

<h3 id="vPush-1-1"><a href="#vPush-1-1" class="headerlink" title="vPush 1"></a>vPush 1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">004693CB    8B0F            mov ecx,dword ptr ds:[edi]					;获取1</span><br><span class="line">004693D3    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0046E6FE    33CB            xor ecx,ebx</span><br><span class="line">00443D5F    41              inc ecx</span><br><span class="line">00443D61    F7D9            neg ecx</span><br><span class="line">004141FF    41              inc ecx</span><br><span class="line">00414206    81F1 66772375   xor ecx,0x75237766</span><br><span class="line">0041420C    33D9            xor ebx,ecx</span><br><span class="line">0041420E    81EE 04000000   sub esi,0x4</span><br><span class="line">00414214    890E            mov dword ptr ds:[esi],ecx        			;push                                      </span><br><span class="line">00414221    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">0047C17B    81C7 04000000   add edi,0x4</span><br><span class="line">0047C181    33CB            xor ecx,ebx</span><br><span class="line">0042DAB1    F7D9            neg ecx</span><br><span class="line">0042DABC    81C1 6233DE7C   add ecx,0x7CDE3362</span><br><span class="line">0042DAC4    F7D9            neg ecx</span><br><span class="line">0042DAC8    F7D1            not ecx</span><br><span class="line">0042DACB    33D9            xor ebx,ecx</span><br><span class="line">0042DACD    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                     </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A32D    0FB7F2          movzx esi,dx</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                             </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                      </span><br><span class="line">00458194    5F              pop edi                                                       </span><br><span class="line">0044BD0C    55              push ebp                                                      </span><br><span class="line">0044BD0D    C3              retn			;0x00421D3D</span><br></pre></td></tr></table></figure>

<blockquote>
<p>取出R15寄存器的值,然后压栈</p>
</blockquote>
<h3 id="vPush-15"><a href="#vPush-15" class="headerlink" title="vPush 15"></a>vPush 15</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">00421D3D    0FB60F          movzx ecx,byte ptr ds:[edi]				;opcode获取一字节</span><br><span class="line">00421D43    8DBF 01000000   lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">00421D49    32CB            xor cl,bl</span><br><span class="line">00421D55    F6D9            neg cl</span><br><span class="line">00421D5B    80F1 0E         xor cl,0xE</span><br><span class="line">00421D64    80E9 21         sub cl,0x21</span><br><span class="line">00421D6D    F6D9            neg cl</span><br><span class="line">00421D72    80F1 E2         xor cl,0xE2</span><br><span class="line">00421D78    32D9            xor bl,cl</span><br><span class="line">00421D81    8B140C          mov edx,dword ptr ss:[esp+ecx]			;获取R15寄存器的值</span><br><span class="line">00421D87    8DB6 FCFFFFFF   lea esi,dword ptr ds:[esi-0x4]	</span><br><span class="line">00421D95    8916            mov dword ptr ds:[esi],edx				push edx</span><br><span class="line">00421D9D    8B0F            mov ecx,dword ptr ds:[edi]</span><br><span class="line">00455281    8DBF 04000000   lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00455289    33CB            xor ecx,ebx                                                 </span><br><span class="line">0045528E    81E9 8C1F9123   sub ecx,0x23911F8C</span><br><span class="line">00455294    D1C9            ror ecx,1</span><br><span class="line">0043425D    49              dec ecx</span><br><span class="line">00434263    F7D1            not ecx</span><br><span class="line">00434267    33D9            xor ebx,ecx</span><br><span class="line">00434269    81FC 1B356876   cmp esp,0x7668351B</span><br><span class="line">0043426F    03E9            add ebp,ecx</span><br><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2            cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4            mov eax,esp</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx</span><br><span class="line">0046734B    57              push edi                                                      ; test1_vm.0043D111</span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax                                            </span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi]                                             </span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                                                                                      </span><br><span class="line">00458194    5F              pop edi                                                     </span><br><span class="line">0044BD0C    55              push ebp                                                      </span><br><span class="line">0044BD0D    C3              retn	;0x004616C3</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vAdd	dword ptr ds:[v_esp+0x4],R15	;add         eax,1 </span><br><span class="line">mov	dword ptr ds:[v_esp],EFL</span><br></pre></td></tr></table></figure>

<h3 id="vAdd-dword-ptr-ds-v-esp-0x4-R15"><a href="#vAdd-dword-ptr-ds-v-esp-0x4-R15" class="headerlink" title="vAdd dword ptr ds:[v_esp+0x4],R15"></a>vAdd dword ptr ds:[v_esp+0x4],R15</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">004616C3    8B06             mov eax,dword ptr ds:[esi]					;读取R15</span><br><span class="line">004616CC    8B56 04          mov edx,dword ptr ds:[esi+0x4]				;读取数值1</span><br><span class="line">004616D6    03C2             add eax,edx								;相加</span><br><span class="line">004616E0    8946 04          mov dword ptr ds:[esi+0x4],eax				;将结果压入原始esp+4</span><br><span class="line">004616E6    9C               pushfd										</span><br><span class="line">004616E8    8F06             pop dword ptr ds:[esi]              		;然后将efl写入到原始esp                         </span><br><span class="line">004616F1    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00428439    81C7 04000000    add edi,0x4</span><br><span class="line">00428446    33CB             xor ecx,ebx                                                 </span><br><span class="line">00428448    C1C9 03          ror ecx,0x3</span><br><span class="line">004810BD    F7D1             not ecx</span><br><span class="line">004810BF    8D89 C448053F    lea ecx,dword ptr ds:[ecx+0x3F0548C4]</span><br><span class="line">004810C5    81F1 2A55B526    xor ecx,0x26B5552A</span><br><span class="line">004810D0    8D89 7AB5F99B    lea ecx,dword ptr ds:[ecx-0x64064A86]</span><br><span class="line">004810D6    33D9             xor ebx,ecx</span><br><span class="line">004810E0    03E9             add ebp,ecx</span><br><span class="line">0040F74A   /FFE5             jmp ebp   ;0x0043BD4C  </span><br></pre></td></tr></table></figure>

<blockquote>
<p>把保存的EFL弹到R7</p>
</blockquote>
<h3 id="vPop-r7"><a href="#vPop-r7" class="headerlink" title="vPop r7"></a>vPop r7</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0043BD4C    8B0E             mov ecx,dword ptr ds:[esi]				;从v_stack栈顶取出保存的efl</span><br><span class="line">0043BD5B    0FB607           movzx eax,byte ptr ds:[edi]			;读取一字节的opcode</span><br><span class="line">0043BD66    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0043BD72    32C3             xor al,bl</span><br><span class="line">0043BD74    04 95            add al,0x95</span><br><span class="line">0043BD7A    F6D8             neg al</span><br><span class="line">00479730    FEC0             inc al</span><br><span class="line">00424206    34 28            xor al,0x28</span><br><span class="line">00424208    32D8             xor bl,al                                           </span><br><span class="line">0042420C    890C04           mov dword ptr ss:[esp+eax],ecx			;push ecx</span><br><span class="line">0042420F    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00424211    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00424217    33CB             xor ecx,ebx</span><br><span class="line">0043796F    C1C9 02          ror ecx,0x2</span><br><span class="line">0041F44A    81F1 7E7F9C09    xor ecx,0x99C7F7E</span><br><span class="line">004104C7    49               dec ecx</span><br><span class="line">004104C8    81F1 F25E4677    xor ecx,0x77465EF2</span><br><span class="line">004104CE    8D89 1A29644A    lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">004104D5    33D9             xor ebx,ecx</span><br><span class="line">004104D7    03E9             add ebp,ecx</span><br><span class="line">004536AD    55               push ebp                                                    </span><br><span class="line">004536AE    C3               retn	;0x0045E179</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r4-1"><a href="#vPop-r4-1" class="headerlink" title="vPop r4"></a>vPop r4</h3><blockquote>
<p>把上面vAdd的结果弹到R4</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0045E179    8B0E             mov ecx,dword ptr ds:[esi]				;从v_stack栈顶取出保存的efl</span><br><span class="line">0045E181    8DB6 04000000    lea esi,dword ptr ds:[esi+0x4]</span><br><span class="line">0045E187    0FB607           movzx eax,byte ptr ds:[edi]			;读取一字节的opcode</span><br><span class="line">0045E18A    81C7 01000000    add edi,0x1</span><br><span class="line">0045E193    32C3             xor al,bl</span><br><span class="line">0045E197    04 95            add al,0x95</span><br><span class="line">0045E199    F6D8             neg al</span><br><span class="line">0047C824    FEC0             inc al</span><br><span class="line">00459FC2    34 28            xor al,0x28</span><br><span class="line">00459FC8    32D8             xor bl,al</span><br><span class="line">00459FCC    890C04           mov dword ptr ss:[esp+eax],ecx			;pop</span><br><span class="line">00459FCF    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00459FD1    81C7 04000000    add edi,0x4</span><br><span class="line">00459FD7    33CB             xor ecx,ebx</span><br><span class="line">00459FD9    C1C9 02          ror ecx,0x2</span><br><span class="line">00459FDC    81F1 7E7F9C09    xor ecx,0x99C7F7E</span><br><span class="line">00459FE2    49               dec ecx</span><br><span class="line">00459FE3    81F1 F25E4677    xor ecx,0x77465EF2</span><br><span class="line">00459FEE    81C1 1A29644A    add ecx,0x4A64291A</span><br><span class="line">00459FF4    33D9             xor ebx,ecx</span><br><span class="line">00459FF6    03E9             add ebp,ecx</span><br><span class="line">00479CA7  ^\FFE5             jmp ebp        	;0x0040EB2E </span><br></pre></td></tr></table></figure>

<h3 id="vPush-r4"><a href="#vPush-r4" class="headerlink" title="vPush r4"></a>vPush r4</h3><blockquote>
<p>R4入栈</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0040EB2E    0FB60F           movzx ecx,byte ptr ds:[edi]		;读取一字节的opcode</span><br><span class="line">0040EB37    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0040EB40    32CB             xor cl,bl</span><br><span class="line">0040EB4F    F6D9             neg cl</span><br><span class="line">0040EB51    80F1 0E          xor cl,0xE</span><br><span class="line">0040EB5B    80E9 21          sub cl,0x21</span><br><span class="line">0040EB68    F6D9             neg cl</span><br><span class="line">0040EB6E    80F1 E2          xor cl,0xE2</span><br><span class="line">0040EB76    32D9             xor bl,cl</span><br><span class="line">00440ED1    8B140C           mov edx,dword ptr ss:[esp+ecx]		;</span><br><span class="line">00440ED8    81EE 04000000    sub esi,0x4</span><br><span class="line">00440EDE    8916             mov dword ptr ds:[esi],edx			;</span><br><span class="line">00440EE0    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0041D911    81C7 04000000    add edi,0x4                                           </span><br><span class="line">0041D91A    33CB             xor ecx,ebx                                                  </span><br><span class="line">0042EDBF    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0042AD19    D1C9             ror ecx,1</span><br><span class="line">0042AD1B    49               dec ecx</span><br><span class="line">0042AD1C    F7D1             not ecx</span><br><span class="line">0042AD1E    33D9             xor ebx,ecx</span><br><span class="line">004526DB    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                      </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                                 </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]                                                 ; test1_vm.00412728</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                  ; test1_vm.0043D124</span><br><span class="line">00458194    5F               pop edi                                                       </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x004184B3</span><br></pre></td></tr></table></figure>

<h3 id="vPush-R0-0x0019FF2C"><a href="#vPush-R0-0x0019FF2C" class="headerlink" title="vPush R0(0x0019FF2C)"></a>vPush R0(0x0019FF2C)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">004184B3    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">004184C1    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">004184C7    32CB             xor cl,bl</span><br><span class="line">004184CB    F6D9             neg cl</span><br><span class="line">004184D4    80F1 0E          xor cl,0xE</span><br><span class="line">004184DC    80E9 21          sub cl,0x21</span><br><span class="line">004184DF    F6D9             neg cl</span><br><span class="line">004184E1    80F1 E2          xor cl,0xE2</span><br><span class="line">004184E6    32D9             xor bl,cl</span><br><span class="line">004184E8    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">004184F0    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">00418501    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">00418503    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0041850A    81C7 04000000    add edi,0x4</span><br><span class="line">00418510    33CB             xor ecx,ebx                                                 </span><br><span class="line">00418516    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">004402C4    D1C9             ror ecx,1</span><br><span class="line">004178C0    49               dec ecx</span><br><span class="line">0044E1FF    F7D1             not ecx</span><br><span class="line">0044E204    33D9             xor ebx,ecx</span><br><span class="line">0044E20A    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                              </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]                                               </span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                     </span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x004394F5</span><br></pre></td></tr></table></figure>

<h3 id="vPush-4-0xFFFFFFFC-2"><a href="#vPush-4-0xFFFFFFFC-2" class="headerlink" title="vPush -4(0xFFFFFFFC)"></a>vPush -4(0xFFFFFFFC)</h3><blockquote>
<p>变量a地址相对于ebp的相对偏移</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">004394F5    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004394F7    81C7 04000000    add edi,0x4</span><br><span class="line">00439503    33CB             xor ecx,ebx                                                 </span><br><span class="line">0043B90E    41               inc ecx</span><br><span class="line">0043B912    F7D9             neg ecx</span><br><span class="line">00446A07    41               inc ecx</span><br><span class="line">00446A11    81F1 66772375    xor ecx,0x75237766</span><br><span class="line">00446A1B    33D9             xor ebx,ecx</span><br><span class="line">00446A21    81EE 04000000    sub esi,0x4</span><br><span class="line">00446A30    890E             mov dword ptr ds:[esi],ecx</span><br><span class="line">00446A38    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00446A40    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0043C79B    33CB             xor ecx,ebx                                                  </span><br><span class="line">0045F6AB    F7D9             neg ecx</span><br><span class="line">0045F6AE    8D89 6233DE7C    lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">004538B9    F7D9             neg ecx</span><br><span class="line">004538BB    F7D1             not ecx</span><br><span class="line">004538BD    33D9             xor ebx,ecx</span><br><span class="line">004538C4    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                      </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                               </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]                                              </span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                              </span><br><span class="line">00458194    5F               pop edi                                                      </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x0046389F</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov	eax,dword ptr ds:[v_esp]	;变量a地址相对于ebp的相对偏移</span><br><span class="line">mov	edx,dword ptr ds:[v_esp+0x4]</span><br><span class="line">add 	eax,edx</span><br><span class="line">mov 	dword ptr ds:[v_esp+0x4],eax</span><br><span class="line">mov 	dword ptr ds:[v_esp],efl</span><br></pre></td></tr></table></figure>

<h3 id="计算变量a的地址-ebp-4-2"><a href="#计算变量a的地址-ebp-4-2" class="headerlink" title="计算变量a的地址,ebp-4"></a>计算变量a的地址,ebp-4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0046389F    8B06             mov eax,dword ptr ds:[esi]</span><br><span class="line">004638A4    8B56 04          mov edx,dword ptr ds:[esi+0x4]</span><br><span class="line">004638AE    03C2             add eax,edx</span><br><span class="line">004638B0    8946 04          mov dword ptr ds:[esi+0x4],eax</span><br><span class="line">004638B3    9C               pushfd</span><br><span class="line">004638B9    8F06             pop dword ptr ds:[esi]                                       </span><br><span class="line">004638BB    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004638BD    81C7 04000000    add edi,0x4</span><br><span class="line">004638CA    33CB             xor ecx,ebx</span><br><span class="line">004638CE    C1C9 03          ror ecx,0x3</span><br><span class="line">004638D8    F7D1             not ecx</span><br><span class="line">004638E1    8D89 C448053F    lea ecx,dword ptr ds:[ecx+0x3F0548C4]</span><br><span class="line">004638E9    81F1 2A55B526    xor ecx,0x26B5552A</span><br><span class="line">004638EF    8D89 7AB5F99B    lea ecx,dword ptr ds:[ecx-0x64064A86]</span><br><span class="line">004638F5    33D9             xor ebx,ecx</span><br><span class="line">004638F8    03E9             add ebp,ecx</span><br><span class="line">0045D98A    55               push ebp                                                    </span><br><span class="line">0045D98B    C3               retn		;0x0046D3FB</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r12-2"><a href="#vPop-r12-2" class="headerlink" title="vPop r12"></a>vPop r12</h3><blockquote>
<p>将EFL弹出堆栈</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0046D3FB    8B0E             mov ecx,dword ptr ds:[esi]</span><br><span class="line">0046D3FD    81C6 04000000    add esi,0x4</span><br><span class="line">0046D403    0FB607           movzx eax,byte ptr ds:[edi]</span><br><span class="line">0046D407    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0046D413    32C3             xor al,bl</span><br><span class="line">0046D415    04 95            add al,0x95</span><br><span class="line">0046D41B    F6D8             neg al</span><br><span class="line">004264F7    FEC0             inc al</span><br><span class="line">004264F9    34 28            xor al,0x28</span><br><span class="line">004264FC    32D8             xor bl,al</span><br><span class="line">00426500    890C04           mov dword ptr ss:[esp+eax],ecx</span><br><span class="line">00426503    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00426508    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0042650F    33CB             xor ecx,ebx</span><br><span class="line">00426512    C1C9 02          ror ecx,0x2</span><br><span class="line">0047CDC0    81F1 7E7F9C09    xor ecx,0x99C7F7E</span><br><span class="line">00483DE1    49               dec ecx</span><br><span class="line">00483DE8    81F1 F25E4677    xor ecx,0x77465EF2</span><br><span class="line">00483DF9    8D89 1A29644A    lea ecx,dword ptr ds:[ecx+0x4A64291A]</span><br><span class="line">00483E02    33D9             xor ebx,ecx</span><br><span class="line">00483E0B    03E9             add ebp,ecx</span><br><span class="line">0047FFF9  ^\FFE5             jmp ebp        ;0x00452B62  </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov 	eax,dword ptr ds:[v_esp]	;变量a地址</span><br><span class="line">mov	edx,dword ptr ds:[v_esp+0x4]	;之前vPush进来的eax</span><br><span class="line">mov	dword ptr ds:[eax],edx	;mov         dword ptr [ebp-4],eax</span><br></pre></td></tr></table></figure>

<h3 id="把计算的结果存回变量a"><a href="#把计算的结果存回变量a" class="headerlink" title="把计算的结果存回变量a"></a>把计算的结果存回变量a</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">00452B62    8B06             mov eax,dword ptr ds:[esi]				;变量a的地址</span><br><span class="line">00452B6B    8B56 04          mov edx,dword ptr ds:[esi+0x4]			;a的值</span><br><span class="line">00452B71    8DB6 08000000    lea esi,dword ptr ds:[esi+0x8]</span><br><span class="line">00452B7E    36:8910          mov dword ptr ss:[eax],edx</span><br><span class="line">00452B88    8B07             mov eax,dword ptr ds:[edi]</span><br><span class="line">00452B8D    81C7 04000000    add edi,0x4</span><br><span class="line">00452B96    33C3             xor eax,ebx                                                  </span><br><span class="line">00452B9C    F7D0             not eax</span><br><span class="line">00452BA3    8D80 39CAABFE    lea eax,dword ptr ds:[eax-0x15435C7]</span><br><span class="line">00452BA9    35 CE111A71      xor eax,0x711A11CE</span><br><span class="line">00452BB3    8D80 03AE9DB8    lea eax,dword ptr ds:[eax-0x476251FD]</span><br><span class="line">00452BB9    33D8             xor ebx,eax</span><br><span class="line">00452BBC    03E8             add ebp,eax</span><br><span class="line">0040AABF    55               push ebp                                                     </span><br><span class="line">0040AAC0    C3               retn	;0x004494C2</span><br></pre></td></tr></table></figure>

<h3 id="vPush-R0-0x0019FF2C-1"><a href="#vPush-R0-0x0019FF2C-1" class="headerlink" title="vPush R0(0x0019FF2C)"></a>vPush R0(0x0019FF2C)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">004494C2    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">004494CC    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">004494DA    32CB             xor cl,bl</span><br><span class="line">004494DC    F6D9             neg cl</span><br><span class="line">004494DF    80F1 0E          xor cl,0xE</span><br><span class="line">004494E8    80E9 21          sub cl,0x21</span><br><span class="line">004494EB    F6D9             neg cl</span><br><span class="line">004494F4    80F1 E2          xor cl,0xE2</span><br><span class="line">004494FD    32D9             xor bl,cl</span><br><span class="line">00449503    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">0044950A    81EE 04000000    sub esi,0x4</span><br><span class="line">00449511    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">00449516    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00449518    81C7 04000000    add edi,0x4</span><br><span class="line">0042DC24    33CB             xor ecx,ebx</span><br><span class="line">0042DC27    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0042DC30    D1C9             ror ecx,1</span><br><span class="line">0043242E    49               dec ecx</span><br><span class="line">00432430    F7D1             not ecx</span><br><span class="line">00432433    33D9             xor ebx,ecx</span><br><span class="line">00432436    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                      </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                                                                              </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                      </span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                     </span><br><span class="line">0044BD0D    C3               retn	;0x0044A08D</span><br></pre></td></tr></table></figure>

<h3 id="vPush-4-0xFFFFFFFC-3"><a href="#vPush-4-0xFFFFFFFC-3" class="headerlink" title="vPush -4(0xFFFFFFFC)"></a>vPush -4(0xFFFFFFFC)</h3><blockquote>
<p>变量a地址相对于ebp的相对偏移</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">0044A08D    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0044A08F    81C7 04000000    add edi,0x4</span><br><span class="line">0041917F    33CB             xor ecx,ebx</span><br><span class="line">00477182    41               inc ecx</span><br><span class="line">0041182A    F7D9             neg ecx</span><br><span class="line">0041996A    41               inc ecx</span><br><span class="line">0041996B    81F1 66772375    xor ecx,0x75237766</span><br><span class="line">00419972    33D9             xor ebx,ecx</span><br><span class="line">00419979    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">0041997F    890E             mov dword ptr ds:[esi],ecx</span><br><span class="line">00419981    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00419987    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0044414F    33CB             xor ecx,ebx</span><br><span class="line">00444154    F7D9             neg ecx</span><br><span class="line">00444159    8D89 6233DE7C    lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">004774CA    F7D9             neg ecx</span><br><span class="line">004774CD    F7D1             not ecx</span><br><span class="line">004774D0    33D9             xor ebx,ecx</span><br><span class="line">004774D3    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                  </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                        </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                     ; test1_vm.0043D148</span><br><span class="line">00458194    5F               pop edi                                                      </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x0042A0F0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov	eax,dword ptr ds:[v_esp]	;变量a地址相对于ebp的相对偏移</span><br><span class="line">mov	edx,dword ptr ds:[v_esp+0x4]</span><br><span class="line">add 	eax,edx</span><br><span class="line">mov 	dword ptr ds:[v_esp+0x4],eax</span><br><span class="line">mov 	dword ptr ds:[v_esp],efl</span><br></pre></td></tr></table></figure>

<h3 id="计算变量a的地址-ebp-4-3"><a href="#计算变量a的地址-ebp-4-3" class="headerlink" title="计算变量a的地址,ebp-4"></a>计算变量a的地址,ebp-4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0042A0F0    8B06             mov eax,dword ptr ds:[esi]</span><br><span class="line">0042A0FD    8B56 04          mov edx,dword ptr ds:[esi+0x4]</span><br><span class="line">0042A105    03C2             add eax,edx</span><br><span class="line">0042A107    8946 04          mov dword ptr ds:[esi+0x4],eax</span><br><span class="line">0042A10D    9C               pushfd</span><br><span class="line">0042A112    8F06             pop dword ptr ds:[esi]                                      </span><br><span class="line">0042A11B    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0042A11D    81C7 04000000    add edi,0x4</span><br><span class="line">0042A129    33CB             xor ecx,ebx</span><br><span class="line">004670D9    C1C9 03          ror ecx,0x3</span><br><span class="line">0041C461    F7D1             not ecx</span><br><span class="line">0041C468    8D89 C448053F    lea ecx,dword ptr ds:[ecx+0x3F0548C4]</span><br><span class="line">0041C46E    81F1 2A55B526    xor ecx,0x26B5552A</span><br><span class="line">0041C474    81E9 864A0664    sub ecx,0x64064A86</span><br><span class="line">0041C482    33D9             xor ebx,ecx</span><br><span class="line">0044C712    03E9             add ebp,ecx</span><br><span class="line">0045ACDE    55               push ebp                                                    </span><br><span class="line">0045ACDF    C3               retn				;0x0046C4CB</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r15-2"><a href="#vPop-r15-2" class="headerlink" title="vPop r15"></a>vPop r15</h3><blockquote>
<p>将EFL弹出</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0046C4CB    8B0E             mov ecx,dword ptr ds:[esi]</span><br><span class="line">0046C4CD    8DB6 04000000    lea esi,dword ptr ds:[esi+0x4]</span><br><span class="line">0046C4D7    0FB607           movzx eax,byte ptr ds:[edi]</span><br><span class="line">0046C4E3    32C3             xor al,bl</span><br><span class="line">0046C4EA    04 95            add al,0x95</span><br><span class="line">00445326    F6D8             neg al</span><br><span class="line">00445328    FEC0             inc al</span><br><span class="line">0044532B    34 28            xor al,0x28</span><br><span class="line">00445332    32D8             xor bl,al</span><br><span class="line">00445334    890C04           mov dword ptr ss:[esp+eax],ecx</span><br><span class="line">0044533F    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00445346    81C7 04000000    add edi,0x4</span><br><span class="line">0044534C    33CB             xor ecx,ebx</span><br><span class="line">0044534E    C1C9 02          ror ecx,0x2</span><br><span class="line">00445351    81F1 7E7F9C09    xor ecx,0x99C7F7E</span><br><span class="line">00478CFC    49               dec ecx</span><br><span class="line">00478CFD    81F1 F25E4677    xor ecx,0x77465EF2</span><br><span class="line">0046EDD9    81C1 1A29644A    add ecx,0x4A64291A</span><br><span class="line">0046EDE5    33D9             xor ebx,ecx</span><br><span class="line">0046EDEA    03E9             add ebp,ecx</span><br><span class="line">0043713E    55               push ebp                                                      </span><br><span class="line">0043713F    C3               retn		;0x00437854</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov 	eax,dword ptr ds:[v_esp]	;变量a地址</span><br><span class="line">mov	edx,dword ptr ds:[eax]	;</span><br><span class="line">mov	dword ptr ds:[v_esp],edx</span><br></pre></td></tr></table></figure>

<h3 id="把变量a的值存放栈顶-1"><a href="#把变量a的值存放栈顶-1" class="headerlink" title="把变量a的值存放栈顶"></a>把变量a的值存放栈顶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">00437854    8B16             mov edx,dword ptr ds:[esi]</span><br><span class="line">00437858    36:8B02          mov eax,dword ptr ss:[edx]</span><br><span class="line">0043785C    8906             mov dword ptr ds:[esi],eax		;把变量a的值读出来后存放值v_stack栈顶</span><br><span class="line">00437863    8B07             mov eax,dword ptr ds:[edi]</span><br><span class="line">00437865    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0043786D    33C3             xor eax,ebx                                                  </span><br><span class="line">0043786F    05 84307C17      add eax,0x177C3084</span><br><span class="line">00480A5B    0FC8             bswap eax</span><br><span class="line">0041D7F7    40               inc eax</span><br><span class="line">0041D7FC    F7D0             not eax</span><br><span class="line">0041D7FE    33D8             xor ebx,eax</span><br><span class="line">0041D803    03E8             add ebp,eax</span><br><span class="line">0042FA74    55               push ebp                                                   </span><br><span class="line">0042FA75    C3               retn	;0x00474E9C</span><br></pre></td></tr></table></figure>

<h3 id="vPop-r12-3"><a href="#vPop-r12-3" class="headerlink" title="vPop r12"></a>vPop r12</h3><blockquote>
<p>将变量a的值保存到寄存器R12,相当于mov	ecx,dword ptr [ebp-4] </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00474E9C    8B0E             mov ecx,dword ptr ds:[esi]</span><br><span class="line">00474EA0    81C6 04000000    add esi,0x4</span><br><span class="line">00474EAB    0FB607           movzx eax,byte ptr ds:[edi]</span><br><span class="line">00474EAE    81C7 01000000    add edi,0x1</span><br><span class="line">00474EB6    32C3             xor al,bl</span><br><span class="line">00445C08    04 95            add al,0x95</span><br><span class="line">00445C0B    F6D8             neg al</span><br><span class="line">00483885    FEC0             inc al</span><br><span class="line">00483887    34 28            xor al,0x28</span><br><span class="line">0048388A    32D8             xor bl,al</span><br><span class="line">00483890    890C04           mov dword ptr ss:[esp+eax],ecx</span><br><span class="line">00483895    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004376C4    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">004745C8    33CB             xor ecx,ebx                                                  </span><br><span class="line">0044E82C    C1C9 02          ror ecx,0x2</span><br><span class="line">0044E82F    81F1 7E7F9C09    xor ecx,0x99C7F7E</span><br><span class="line">004072B5    81F1 F25E4677    xor ecx,0x77465EF2</span><br><span class="line">004072BB    81C1 1A29644A    add ecx,0x4A64291A</span><br><span class="line">004072C5    33D9             xor ebx,ecx                                           </span><br><span class="line">004072C9    03E9             add ebp,ecx</span><br><span class="line">00471DC6    55               push ebp                                                      </span><br><span class="line">00471DC7    C3               retn	;0x00405372</span><br></pre></td></tr></table></figure>

<h3 id="vPush-R12"><a href="#vPush-R12" class="headerlink" title="vPush R12"></a>vPush R12</h3><blockquote>
<p>push ecx</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">00405372    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">0040537B    81C7 01000000    add edi,0x1</span><br><span class="line">00405384    32CB             xor cl,bl</span><br><span class="line">00405389    F6D9             neg cl</span><br><span class="line">0040538D    80F1 0E          xor cl,0xE</span><br><span class="line">00405393    80E9 21          sub cl,0x21</span><br><span class="line">00405396    F6D9             neg cl</span><br><span class="line">004053A0    80F1 E2          xor cl,0xE2</span><br><span class="line">004053A8    32D9             xor bl,cl</span><br><span class="line">004053B1    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">004053B9    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">004053C4    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">004053C9    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00474617    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00474622    33CB             xor ecx,ebx</span><br><span class="line">0047462F    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">00474636    D1C9             ror ecx,1</span><br><span class="line">004863EB    49               dec ecx</span><br><span class="line">00435EA6    F7D1             not ecx</span><br><span class="line">00435EAE    33D9             xor ebx,ecx</span><br><span class="line">00435EB8    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                             </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                            </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                 ; test1_vm.0043D162</span><br><span class="line">00458194    5F               pop edi                                                   </span><br><span class="line">0044BD0C    55               push ebp                                                     </span><br><span class="line">0044BD0D    C3               retn			//0x004357B8</span><br></pre></td></tr></table></figure>

<h3 id="vPush-4020FCh"><a href="#vPush-4020FCh" class="headerlink" title="vPush 4020FCh"></a>vPush 4020FCh</h3><blockquote>
<p>push “%d\n”</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">004357B8    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004357BD    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">004357C5    33CB             xor ecx,ebx</span><br><span class="line">004357D0    F7D9             neg ecx</span><br><span class="line">004357D2    41               inc ecx</span><br><span class="line">004357D5    81F1 66772375    xor ecx,0x75237766</span><br><span class="line">004357E1    33D9             xor ebx,ecx</span><br><span class="line">004357E3    81EE 04000000    sub esi,0x4</span><br><span class="line">004357EA    890E             mov dword ptr ds:[esi],ecx</span><br><span class="line">004357EC    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004357EE    81C7 04000000    add edi,0x4</span><br><span class="line">004357F8    33CB             xor ecx,ebx</span><br><span class="line">004357FA    F7D9             neg ecx</span><br><span class="line">00435802    8D89 6233DE7C    lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">0043580F    F7D1             not ecx</span><br><span class="line">0043581A    33D9             xor ebx,ecx</span><br><span class="line">0043581C    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                   </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                           </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                           ; test1_vm.0043D167</span><br><span class="line">00458194    5F               pop edi                                                   </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn			;0x0043AA20</span><br></pre></td></tr></table></figure>

<h3 id="vPush-VMEntry"><a href="#vPush-VMEntry" class="headerlink" title="vPush VMEntry"></a>vPush VMEntry</h3><blockquote>
<p>重新进入虚拟机的入口,也就是printf执行完毕后的返回地址</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">0043AA20    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0043AA26    81C7 04000000    add edi,0x4</span><br><span class="line">0043AA2E    33CB             xor ecx,ebx</span><br><span class="line">0047C322    F7D9             neg ecx</span><br><span class="line">0047C324    41               inc ecx</span><br><span class="line">0047C32B    81F1 66772375    xor ecx,0x75237766</span><br><span class="line">0042C668    33D9             xor ebx,ecx</span><br><span class="line">0042C66B    81EE 04000000    sub esi,0x4</span><br><span class="line">0042C674    890E             mov dword ptr ds:[esi],ecx</span><br><span class="line">0042C67F    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0042C687    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0042C699    33CB             xor ecx,ebx</span><br><span class="line">0045ED4D    F7D9             neg ecx</span><br><span class="line">0045ED4F    8D89 6233DE7C    lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">0045ED55    F7D9             neg ecx</span><br><span class="line">0045ED5D    F7D1             not ecx</span><br><span class="line">0045ED60    33D9             xor ebx,ecx</span><br><span class="line">00446EEF    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                             </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                            ; test1_vm.0043D16F</span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x0044A38D</span><br></pre></td></tr></table></figure>

<h3 id="vPush-printf"><a href="#vPush-printf" class="headerlink" title="vPush printf"></a>vPush printf</h3><blockquote>
<p>将printf函数地址压入栈</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">0044A38D    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0044A38F    81C7 04000000    add edi,0x4</span><br><span class="line">0044A395    33CB             xor ecx,ebx</span><br><span class="line">00441810    41               inc ecx</span><br><span class="line">00441816    F7D9             neg ecx</span><br><span class="line">0041C24A    41               inc ecx</span><br><span class="line">0041C250    81F1 66772375    xor ecx,0x75237766</span><br><span class="line">0041C259    33D9             xor ebx,ecx</span><br><span class="line">0041C260    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">0041C26A    890E             mov dword ptr ds:[esi],ecx</span><br><span class="line">0041C270    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0041C273    81C7 04000000    add edi,0x4</span><br><span class="line">0041C279    33CB             xor ecx,ebx</span><br><span class="line">0041C27B    F7D9             neg ecx</span><br><span class="line">0041C286    8D89 6233DE7C    lea ecx,dword ptr ds:[ecx+0x7CDE3362]</span><br><span class="line">0041C28C    F7D9             neg ecx</span><br><span class="line">00435617    F7D1             not ecx</span><br><span class="line">0043561B    33D9             xor ebx,ecx</span><br><span class="line">00435622    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                                </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                ; test1_vm.0043D177</span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                      </span><br><span class="line">0044BD0D    C3               retn			;0x004126A8</span><br></pre></td></tr></table></figure>

<h3 id="vPush-R4-2"><a href="#vPush-R4-2" class="headerlink" title="vPush R4(2)"></a>vPush R4(2)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">004126A8    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">004126B4    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">004126C0    32CB             xor cl,bl</span><br><span class="line">004126C4    F6D9             neg cl</span><br><span class="line">004126CD    80F1 0E          xor cl,0xE</span><br><span class="line">004126D3    80E9 21          sub cl,0x21</span><br><span class="line">004126DF    F6D9             neg cl</span><br><span class="line">004126E1    80F1 E2          xor cl,0xE2</span><br><span class="line">004126E4    32D9             xor bl,cl</span><br><span class="line">004126E6    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">004126F0    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">004126F6    8916             mov dword ptr ds:[esi],edx		</span><br><span class="line">004126FE    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00412702    81C7 04000000    add edi,0x4</span><br><span class="line">0041270D    33CB             xor ecx,ebx</span><br><span class="line">00412718    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0041271F    D1C9             ror ecx,1</span><br><span class="line">00412721    49               dec ecx</span><br><span class="line">00489F7A    F7D1             not ecx</span><br><span class="line">00445362    33D9             xor ebx,ecx</span><br><span class="line">00445369    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                              </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                     ; test1_vm.0043D17F</span><br><span class="line">00458194    5F               pop edi                                                      </span><br><span class="line">0044BD0C    55               push ebp                                                     </span><br><span class="line">0044BD0D    C3               retn	;0x0047B785</span><br></pre></td></tr></table></figure>

<h3 id="vPush-R5-2"><a href="#vPush-R5-2" class="headerlink" title="vPush R5(2)"></a>vPush R5(2)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">0047B785    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">0047B790    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0047B79E    32CB             xor cl,bl</span><br><span class="line">0047B7AA    F6D9             neg cl</span><br><span class="line">0047B7AC    80F1 0E          xor cl,0xE</span><br><span class="line">0047B7B3    80E9 21          sub cl,0x21</span><br><span class="line">0040EEF9    F6D9             neg cl</span><br><span class="line">0040EEFE    80F1 E2          xor cl,0xE2</span><br><span class="line">0040EF01    32D9             xor bl,cl</span><br><span class="line">0040EF07    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">0040EF0D    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">0040EF17    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">0040EF20    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0040EF22    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0040EF28    33CB             xor ecx,ebx</span><br><span class="line">0040EF2A    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0040EF32    D1C9             ror ecx,1</span><br><span class="line">00430F23    49               dec ecx</span><br><span class="line">00430F29    F7D1             not ecx</span><br><span class="line">00430F2B    33D9             xor ebx,ecx</span><br><span class="line">00430F2E    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                    </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                               </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                      </span><br><span class="line">00458194    5F               pop edi                                                      </span><br><span class="line">0044BD0C    55               push ebp                                                      </span><br><span class="line">0044BD0D    C3               retn	;0x0045325C</span><br></pre></td></tr></table></figure>

<h3 id="vPush"><a href="#vPush" class="headerlink" title="vPush"></a>vPush</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">0045325C    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">00453267    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0045326D    32CB             xor cl,bl</span><br><span class="line">0045326F    F6D9             neg cl</span><br><span class="line">00453272    80F1 0E          xor cl,0xE</span><br><span class="line">00453278    80E9 21          sub cl,0x21</span><br><span class="line">00453282    F6D9             neg cl                                              </span><br><span class="line">0045328E    80F1 E2          xor cl,0xE2</span><br><span class="line">00453291    80EA 48          sub dl,0x48</span><br><span class="line">00453296    32D9             xor bl,cl</span><br><span class="line">004532A5    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">004532A8    81EE 04000000    sub esi,0x4</span><br><span class="line">004532B4    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">004532BD    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004532C4    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">0041B011    33CB             xor ecx,ebx</span><br><span class="line">0041B018    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0041B01E    D1C9             ror ecx,1</span><br><span class="line">004692ED    49               dec ecx</span><br><span class="line">004692F3    F7D1             not ecx</span><br><span class="line">004692FA    33D9             xor ebx,ecx</span><br><span class="line">004692FC    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                            </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                              ; test1_vm.0043D189</span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x0045225C</span><br></pre></td></tr></table></figure>

<h3 id="vPush-1"><a href="#vPush-1" class="headerlink" title="vPush"></a>vPush</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0045225C    0FB60F           movzx ecx,byte ptr ds:[edi]                                         </span><br><span class="line">00452265    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0045226B    32CB             xor cl,bl</span><br><span class="line">0045226D    F6D9             neg cl</span><br><span class="line">00452273    80F1 0E          xor cl,0xE</span><br><span class="line">0045227D    80E9 21          sub cl,0x21</span><br><span class="line">0045228B    F6D9             neg cl</span><br><span class="line">0045228D    80F1 E2          xor cl,0xE2</span><br><span class="line">00452292    32D9             xor bl,cl</span><br><span class="line">00452297    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">0045229A    81EE 04000000    sub esi,0x4</span><br><span class="line">004522AE    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">004522B0    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">004522B3    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">004522BE    33CB             xor ecx,ebx</span><br><span class="line">0045676E    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">00456776    D1C9             ror ecx,1</span><br><span class="line">00463F87    49               dec ecx</span><br><span class="line">00463F8C    F7D1             not ecx</span><br><span class="line">0041EFFB    33D9             xor ebx,ecx</span><br><span class="line">0041F001    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                   </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                            </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                   </span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn		;0x0047E64B</span><br></pre></td></tr></table></figure>

<h3 id="vPush-2"><a href="#vPush-2" class="headerlink" title="vPush"></a>vPush</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0047E64B    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">0047E661    32CB             xor cl,bl</span><br><span class="line">0047E663    F6D9             neg cl</span><br><span class="line">0047E66B    80F1 0E          xor cl,0xE</span><br><span class="line">0047E670    80E9 21          sub cl,0x21</span><br><span class="line">0047E681    F6D9             neg cl</span><br><span class="line">0047E683    80F1 E2          xor cl,0xE2</span><br><span class="line">0047E686    32D9             xor bl,cl</span><br><span class="line">0047E68E    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">0047E697    81EE 04000000    sub esi,0x4</span><br><span class="line">0047E6A2    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">0047E6AC    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0047E6B4    81C7 04000000    add edi,0x4</span><br><span class="line">0047E6BA    66:81FE 6D64     cmp si,0x646D</span><br><span class="line">0047E6BF    33CB             xor ecx,ebx</span><br><span class="line">0047E6C8    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0047E6CF    D1C9             ror ecx,1</span><br><span class="line">0044CE2D    49               dec ecx</span><br><span class="line">0044CE2E    F7D1             not ecx</span><br><span class="line">0044CE30    33D9             xor ebx,ecx</span><br><span class="line">0044CE33    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                    </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                                </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                      </span><br><span class="line">00458194    5F               pop edi                                                      </span><br><span class="line">0044BD0C    55               push ebp                                                    </span><br><span class="line">0044BD0D    C3               retn	;0x0041043E</span><br></pre></td></tr></table></figure>

<h3 id="vPush-3"><a href="#vPush-3" class="headerlink" title="vPush"></a>vPush</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">0041043E    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">00410443    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0041044E    32CB             xor cl,bl</span><br><span class="line">00410450    F6D9             neg cl</span><br><span class="line">00410452    80F1 0E          xor cl,0xE</span><br><span class="line">00410460    80E9 21          sub cl,0x21</span><br><span class="line">0041046B    F6D9             neg cl</span><br><span class="line">00410471    80F1 E2          xor cl,0xE2</span><br><span class="line">00410479    32D9             xor bl,cl</span><br><span class="line">0041047D    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">00410480    81EE 04000000    sub esi,0x4</span><br><span class="line">00410489    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">00410497    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0041049E    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">004104A4    33CB             xor ecx,ebx</span><br><span class="line">004104A8    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">004104B1    D1C9             ror ecx,1</span><br><span class="line">004104B3    49               dec ecx</span><br><span class="line">00440D59    F7D1             not ecx</span><br><span class="line">00440D5C    33D9             xor ebx,ecx</span><br><span class="line">004251B5    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                      </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                               </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                 ; test1_vm.0043D198</span><br><span class="line">00458194    5F               pop edi                                                     </span><br><span class="line">0044BD0C    55               push ebp                                                  </span><br><span class="line">0044BD0D    C3               retn	;0x00421D3D</span><br></pre></td></tr></table></figure>

<h3 id="vPush-4"><a href="#vPush-4" class="headerlink" title="vPush"></a>vPush</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">00421D3D    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">00421D43    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">00421D49    32CB             xor cl,bl</span><br><span class="line">00421D55    F6D9             neg cl</span><br><span class="line">00421D5B    80F1 0E          xor cl,0xE</span><br><span class="line">00421D64    80E9 21          sub cl,0x21</span><br><span class="line">00421D6D    F6D9             neg cl</span><br><span class="line">00421D72    80F1 E2          xor cl,0xE2</span><br><span class="line">00421D78    32D9             xor bl,cl</span><br><span class="line">00421D81    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">00421D87    8DB6 FCFFFFFF    lea esi,dword ptr ds:[esi-0x4]</span><br><span class="line">00421D95    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">00421D9D    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">00455281    8DBF 04000000    lea edi,dword ptr ds:[edi+0x4]</span><br><span class="line">00455289    33CB             xor ecx,ebx</span><br><span class="line">0045528E    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">00455294    D1C9             ror ecx,1</span><br><span class="line">0043425D    49               dec ecx</span><br><span class="line">00434263    F7D1             not ecx</span><br><span class="line">00434267    33D9             xor ebx,ecx</span><br><span class="line">0043426F    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                                </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0040D075    FC               cld</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                                   ; test1_vm.0043D19D</span><br><span class="line">00458194    5F               pop edi                                                      </span><br><span class="line">0044BD0C    55               push ebp                                                   </span><br><span class="line">0044BD0D    C3               retn	;0x0040EB2E</span><br></pre></td></tr></table></figure>

<h3 id="vPush-5"><a href="#vPush-5" class="headerlink" title="vPush"></a>vPush</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">0040EB2E    0FB60F           movzx ecx,byte ptr ds:[edi]</span><br><span class="line">0040EB37    8DBF 01000000    lea edi,dword ptr ds:[edi+0x1]</span><br><span class="line">0040EB40    32CB             xor cl,bl</span><br><span class="line">0040EB4F    F6D9             neg cl</span><br><span class="line">0040EB51    80F1 0E          xor cl,0xE</span><br><span class="line">0040EB5B    80E9 21          sub cl,0x21</span><br><span class="line">0040EB68    F6D9             neg cl</span><br><span class="line">0040EB6E    80F1 E2          xor cl,0xE2</span><br><span class="line">0040EB76    32D9             xor bl,cl</span><br><span class="line">00440ED1    8B140C           mov edx,dword ptr ss:[esp+ecx]</span><br><span class="line">00440ED8    81EE 04000000    sub esi,0x4</span><br><span class="line">00440EDE    8916             mov dword ptr ds:[esi],edx</span><br><span class="line">00440EE0    8B0F             mov ecx,dword ptr ds:[edi]</span><br><span class="line">0041D911    81C7 04000000    add edi,0x4                                           </span><br><span class="line">0041D91A    33CB             xor ecx,ebx</span><br><span class="line">0042EDBF    81E9 8C1F9123    sub ecx,0x23911F8C</span><br><span class="line">0042AD19    D1C9             ror ecx,1</span><br><span class="line">0042AD1B    49               dec ecx</span><br><span class="line">0042AD1C    F7D1             not ecx</span><br><span class="line">0042AD1E    33D9             xor ebx,ecx</span><br><span class="line">004526DB    03E9             add ebp,ecx</span><br><span class="line">00462636    8D5424 60        lea edx,dword ptr ss:[esp+0x60]</span><br><span class="line">0046263A    3BF2             cmp esi,edx</span><br><span class="line">00481402  ^\0F87 04A9FCFF    ja test1_vm.0044BD0C</span><br><span class="line">00481408    8BC4             mov eax,esp</span><br><span class="line">0048140A    B9 40000000      mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80        lea edx,dword ptr ds:[esi-0x80]</span><br><span class="line">00467341    81E2 FCFFFFFF    and edx,-0x4</span><br><span class="line">00467347    2BD1             sub edx,ecx</span><br><span class="line">00467349    8BE2             mov esp,edx</span><br><span class="line">0046734B    57               push edi                                                     </span><br><span class="line">0045A32C    56               push esi</span><br><span class="line">0045A32D    0FB7F2           movzx esi,dx</span><br><span class="line">0045A330    9C               pushfd</span><br><span class="line">00489ACC    8BF0             mov esi,eax                                               </span><br><span class="line">00489AD2    8BFA             mov edi,edx</span><br><span class="line">0045B5BE    F3:A4            rep movs byte ptr es:[edi],byte ptr ds:[esi]</span><br><span class="line">0045B5C2    9D               popfd</span><br><span class="line">0045818E    5E               pop esi                                                                                               ; test1_vm.0043D1A2</span><br><span class="line">00458194    5F               pop edi                                                       </span><br><span class="line">0044BD0C    55               push ebp                                                   </span><br><span class="line">0044BD0D    C3               retn	;0x00415543</span><br></pre></td></tr></table></figure>

<h3 id="VMExit"><a href="#VMExit" class="headerlink" title="VMExit"></a>VMExit</h3><blockquote>
<p>退出虚拟机,执行printf</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00415543    8BE6             mov esp,esi</span><br><span class="line">0041554A    5D               pop ebp                                                       ; 0019FF2C</span><br><span class="line">0041554B    5A               pop edx                                                       ; 0019FF2C</span><br><span class="line">0041554D    5F               pop edi                                                       ; 0019FF2C</span><br><span class="line">0041554E    5E               pop esi                                                       ; 0019FF2C</span><br><span class="line">0041554F    5B               pop ebx                                                       ; 0019FF2C</span><br><span class="line">00415550    9D               popfd</span><br><span class="line">00415557    59               pop ecx                                                       ; 0019FF2C</span><br><span class="line">00415558    58               pop eax                                                       ; 0019FF2C</span><br><span class="line">0043B984    C3               retn</span><br></pre></td></tr></table></figure>

<blockquote>
<p>printf执行完毕后重新回到入口函数执行</p>
</blockquote>
<h2 id="2、防侧漏用苏菲"><a href="#2、防侧漏用苏菲" class="headerlink" title="2、防侧漏用苏菲"></a>2、防侧漏用苏菲</h2><p>因为是push指令，需要检查栈是否发生溢出，防止vm_context被真实堆栈覆盖。</p>
<h3 id="VMP堆栈检查"><a href="#VMP堆栈检查" class="headerlink" title="VMP堆栈检查"></a>VMP堆栈检查</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">00462636    8D5424 60       lea edx,dword ptr ss:[esp+0x60]			;edx=v_esp+0x60</span><br><span class="line">0046263A    3BF2            cmp esi,edx								;原始esp与edx比较</span><br><span class="line">00481402  ^\0F87 04A9FCFF   ja test1_vm.0044BD0C					;如果原始esp&gt;edx就正常返回,防止原始esp内容覆盖了vm_context</span><br><span class="line">00481408    8BC4            mov eax,esp								;将v_esp传给eax</span><br><span class="line">0048140A    B9 40000000     mov ecx,0x40</span><br><span class="line">0048140F    8D5426 80       lea edx,dword ptr ds:[esi-0x80]			;把原始esp上台0x80大小,然后把地址传给edx</span><br><span class="line">00467341    81E2 FCFFFFFF   and edx,-0x4							</span><br><span class="line">00467347    2BD1            sub edx,ecx</span><br><span class="line">00467349    8BE2            mov esp,edx								;把新的堆栈地址传给v_esp</span><br><span class="line">0046734B    57              push edi                               </span><br><span class="line">0045A32C    56              push esi</span><br><span class="line">0045A330    9C              pushfd</span><br><span class="line">00489ACC    8BF0            mov esi,eax								</span><br><span class="line">00489AD2    8BFA            mov edi,edx</span><br><span class="line">0045B5BE    F3:A4           rep movs byte ptr es:[edi],byte ptr ds:[esi] ;把原来v_esp的内容拷贝到新的v_esp</span><br><span class="line">0045B5C2    9D              popfd</span><br><span class="line">0045818E    5E              pop esi                                  </span><br><span class="line">00458194    5F              pop edi                                  </span><br><span class="line">0044BD0C    55              push ebp                                 </span><br><span class="line">0044BD0D    C3              retn									;0x004786D0		</span><br></pre></td></tr></table></figure>

<h2 id="3、简单提几句"><a href="#3、简单提几句" class="headerlink" title="3、简单提几句"></a>3、简单提几句</h2><ul>
<li>vmp在初始化时会保存当前环境，将寄存器通过push进行保存，退出虚拟机时恢复寄存器</li>
<li>在执行系统函数时，vmp会退出虚拟机，恢复初始环境；函数执行完毕后重新进入虚拟机。</li>
<li>vmp的虚拟化技术是通过将一条一句进行拆分，然后以push和pop形式进行实现，因此被称为栈虚拟机。</li>
<li>opcode的第一个字节若为操作数，则该操作数指向为vm_context的其中一个寄存器；若为四字节则为下一个要跳转的handler地址。</li>
<li>vmp是真的恶心啊。</li>
</ul>
<h1 id="四、真理只在大炮射程之内"><a href="#四、真理只在大炮射程之内" class="headerlink" title="四、真理只在大炮射程之内"></a>四、真理只在大炮射程之内</h1><p>经过对VMP虚拟化代码的分析后，可以使用push和pop指令按照vmp虚拟化的方式对原始的汇编语句继续改写，进行娱乐。</p>
<h3 id="模拟VMP指令"><a href="#模拟VMP指令" class="headerlink" title="模拟VMP指令"></a>模拟VMP指令</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> format[] = <span class="string">&quot;%d\n&quot;</span>;</span><br><span class="line"><span class="type">char</span>* p = format;</span><br><span class="line">__declspec(naked) <span class="function"><span class="type">void</span> <span class="title">my_test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm &#123;</span><br><span class="line">		push	ebp</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mov ebp,esp</span></span><br><span class="line">		push	esp</span><br><span class="line">		pop		ebp</span><br><span class="line"></span><br><span class="line">		push	ecx</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mov    dword ptr[ebp - 4], 1</span></span><br><span class="line">		push	<span class="number">1</span></span><br><span class="line">		push	ebp</span><br><span class="line">		push	<span class="number">0F</span>FFFFFFCh</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp + <span class="number">4</span>]</span><br><span class="line">		add		eax, edx</span><br><span class="line">		mov		dword ptr[esp + <span class="number">4</span>], eax</span><br><span class="line">		pop		esi</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp + <span class="number">4</span>]</span><br><span class="line">		mov		dword ptr[eax], edx</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mov    eax, dword ptr[ebp - 4]</span></span><br><span class="line">		push	<span class="number">0F</span>FFFFFFCh</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp + <span class="number">4</span>]</span><br><span class="line">		add		eax, edx</span><br><span class="line">		mov		dword ptr[esp + <span class="number">4</span>], eax</span><br><span class="line">		pop		esi</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[eax]</span><br><span class="line">		mov		dword ptr[esp], edx</span><br><span class="line">		pop		eax</span><br><span class="line"></span><br><span class="line">		<span class="comment">// add    eax, 1</span></span><br><span class="line">		push	<span class="number">1</span></span><br><span class="line">		push	eax</span><br><span class="line">		mov		eax,dword ptr[esp]</span><br><span class="line">		mov		edx,dword ptr[esp+<span class="number">4</span>]</span><br><span class="line">		add		eax,edx</span><br><span class="line">		mov		dword ptr[esp+<span class="number">4</span>],eax</span><br><span class="line">		pop		esi</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mov    dword ptr[ebp - 4], eax</span></span><br><span class="line">		push	ebp</span><br><span class="line">		push	<span class="number">0F</span>FFFFFFCh</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp + <span class="number">4</span>]</span><br><span class="line">		add		eax, edx</span><br><span class="line">		mov		dword ptr[esp + <span class="number">4</span>], eax</span><br><span class="line">		pop		esi</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp + <span class="number">4</span>]</span><br><span class="line">		mov		dword ptr[eax], edx</span><br><span class="line">		pop		esi</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mov    ecx, dword ptr[ebp - 4]</span></span><br><span class="line">		push	ebp</span><br><span class="line">		push	<span class="number">0F</span>FFFFFFCh</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp + <span class="number">4</span>]</span><br><span class="line">		add		eax, edx</span><br><span class="line">		mov		dword ptr[esp + <span class="number">4</span>], eax</span><br><span class="line">		pop		esi</span><br><span class="line">		mov		eax, dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[eax]</span><br><span class="line">		mov		dword ptr[esp], edx</span><br><span class="line">		pop		ecx</span><br><span class="line">		add		esp, <span class="number">8</span></span><br><span class="line"></span><br><span class="line">		push    ecx</span><br><span class="line">		push    p</span><br><span class="line"></span><br><span class="line">		<span class="comment">//call返回的地址</span></span><br><span class="line">		push	Next</span><br><span class="line"></span><br><span class="line">		<span class="comment">// call   00401070</span></span><br><span class="line">		push	printf</span><br><span class="line">		ret</span><br><span class="line"></span><br><span class="line">		Next :</span><br><span class="line"></span><br><span class="line">		<span class="comment">//add	esp, 8</span></span><br><span class="line">		push	<span class="number">8</span></span><br><span class="line">		push	esp</span><br><span class="line">		mov		eax,dword ptr[esp]</span><br><span class="line">		mov		edx, dword ptr[esp+<span class="number">4</span>]</span><br><span class="line">		add		eax,edx</span><br><span class="line">		mov		dword ptr[esp+<span class="number">4</span>],eax</span><br><span class="line">		pop		esi</span><br><span class="line">		mov		esi,dword ptr[esp]</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">xor</span> eax, eax</span><br><span class="line"></span><br><span class="line">		<span class="comment">//mov esp,ebp</span></span><br><span class="line">		push	ebp</span><br><span class="line">		pop		esp</span><br><span class="line"></span><br><span class="line">		pop		ebp</span><br><span class="line">		ret</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">my_test</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行无任何问题且能正常输出。</p>
<p><img src="/../images/Anti/VMProtect%E5%88%86%E6%9E%90-%E8%99%9A%E6%8B%9F%E5%8C%96%E6%B5%81%E7%A8%8B/image-20230105162339766.png" alt="image-20230105162339766"></p>
<h1 id="五、精准射击"><a href="#五、精准射击" class="headerlink" title="五、精准射击"></a>五、精准射击</h1><ul>
<li><a target="_blank" rel="noopener" href="https://back.engineering/17/05/2021/[VMProtect">https://back.engineering/17/05/2021/[VMProtect</a> 2 - Detailed Analysis of the Virtual Machine Architecture]</li>
<li><a target="_blank" rel="noopener" href="https://back.engineering/17/05/2021/[Quick">https://back.engineering/17/05/2021/[Quick</a> look around VMP 3.x - Part 1 : Unpacking]</li>
<li><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-586130-1-1.html[VMProtect">https://www.52pojie.cn/thread-586130-1-1.html[VMProtect</a> 3.09 虚拟机架构浅析]</li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-272152.htm[vmp2%E4%BB%A3%E7%A0%81%E8%BF%98%E5%8E%9F%E5%88%86%E4%BA%AB]">https://bbs.pediy.com/thread-272152.htm[vmp2代码还原分享]</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-217588.htm[%E9%80%9A%E8%BF%87%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E8%BF%9B%E8%A1%8CVMP%E4%BB%A3%E7%A0%81%E8%BF%98%E5%8E%9F]">https://bbs.pediy.com/thread-217588.htm[通过编译优化进行VMP代码还原]</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-225262.htm[%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%881%EF%BC%89%EF%BC%9A%E6%96%B0%E6%89%8B%E7%AF%87VMProtect">https://bbs.pediy.com/thread-225262.htm[如何分析虚拟机（1）：新手篇VMProtect</a> 1.81 Demo]</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/01/03/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%88%86%E6%9E%90VAC/" rel="prev" title="从零开始分析VAC">
                  <i class="fa fa-chevron-left"></i> 从零开始分析VAC
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/25/x64%E9%A1%B5%E8%A1%A8%E6%98%A0%E5%B0%84/" rel="next" title="x64页表映射">
                  x64页表映射 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PlaneJun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/fancybox.js"></script>



  




<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
